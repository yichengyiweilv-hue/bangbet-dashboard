<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>Bangbet 自然量月度数据对比</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="Bangbet 海外自然量月度数据对比看板" />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --bg-main: #f3f5f9;
        --bg-card: #ffffff;
        --border-subtle: rgba(148, 163, 184, 0.4);
        --accent: #2563eb;
        --accent-soft: #e0edff;
        --accent-strong: #1d4ed8;
        --accent-green: #16a34a;
        --text-main: #0f172a;
        --text-sub: #6b7280;
        --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.1);
        --radius-lg: 18px;
        --radius-md: 12px;
        --radius-pill: 999px;
        --transition-fast: 0.18s ease-out;
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        margin: 0;
        padding: 0;
        height: 100%;
        font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont,
          "Segoe UI", sans-serif;
        background: radial-gradient(
          circle at 0 0,
          #f9fbff 0,
          #edf1f9 45%,
          #e5ebf7 100%
        );
        color: var(--text-main);
        -webkit-font-smoothing: antialiased;
      }

      .page {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      .top-bar {
        padding: 16px 24px 10px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }

      .top-left {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .brand-mark {
        width: 34px;
        height: 34px;
        border-radius: 14px;
        background: conic-gradient(
          from 160deg,
          #2563eb,
          #22c55e,
          #38bdf8,
          #2563eb
        );
        position: relative;
        overflow: hidden;
        box-shadow: 0 10px 25px rgba(37, 99, 235, 0.45);
      }

      .brand-mark::after {
        content: "";
        position: absolute;
        inset: 7px;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.92);
        backdrop-filter: blur(12px);
      }

      .brand-mark-inner {
        position: absolute;
        inset: 10px 11px 10px 9px;
        border-radius: 9px;
        background: linear-gradient(135deg, #2563eb, #22c55e);
        opacity: 0.9;
        clip-path: polygon(0 30%, 60% 0, 100% 40%, 70% 100%, 20% 80%);
      }

      .brand-text-main {
        font-size: 16px;
        font-weight: 600;
        letter-spacing: 0.03em;
      }

      .brand-text-sub {
        font-size: 11px;
        letter-spacing: 0.12em;
        text-transform: uppercase;
        color: var(--text-sub);
      }

      .breadcrumb {
        font-size: 11px;
        color: var(--text-sub);
      }

      .breadcrumb a {
        color: var(--accent-strong);
        text-decoration: none;
      }

      .breadcrumb a:hover {
        text-decoration: underline;
      }

      .top-right {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 4px;
        font-size: 11px;
        color: var(--text-sub);
      }

      .badge-env {
        padding: 4px 10px;
        border-radius: var(--radius-pill);
        border: 1px solid rgba(148, 163, 184, 0.5);
        background: rgba(255, 255, 255, 0.9);
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .badge-dot {
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: radial-gradient(circle at 30% 30%, #22c55e, #16a34a);
        box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.22);
      }

      .hero {
        margin: 4px auto 20px;
        padding: 18px 20px 16px;
        border-radius: 22px;
        background: radial-gradient(
            circle at 0 0,
            rgba(59, 130, 246, 0.16) 0,
            transparent 50%
          ),
          radial-gradient(
            circle at 100% 0,
            rgba(34, 197, 94, 0.15) 0,
            transparent 55%
          ),
          rgba(255, 255, 255, 0.95);
        border: 1px solid rgba(148, 163, 184, 0.45);
        box-shadow: var(--shadow-soft);
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        gap: 16px;
        max-width: 1400px;
      }

      .hero-main {
        max-width: 750px;
      }

      .hero-title {
        font-size: 20px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 6px;
      }

      .hero-title span.bar {
        width: 3px;
        height: 20px;
        border-radius: 999px;
        background: linear-gradient(180deg, #22c55e, #2563eb);
      }

      .hero-sub {
        font-size: 13px;
        color: var(--text-sub);
        margin-bottom: 10px;
      }

      .hero-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }

      .hero-tag {
        font-size: 11px;
        padding: 4px 9px;
        border-radius: var(--radius-pill);
        background: rgba(15, 23, 42, 0.03);
        border: 1px solid rgba(148, 163, 184, 0.45);
        color: var(--text-sub);
      }

      .hero-side {
        min-width: 240px;
        max-width: 320px;
        font-size: 11px;
        color: var(--text-sub);
        display: flex;
        flex-direction: column;
        gap: 6px;
        align-items: flex-end;
        text-align: right;
      }

      .hero-pill {
        padding: 6px 11px;
        border-radius: var(--radius-pill);
        background: linear-gradient(120deg, var(--accent-strong), #22c55e);
        color: #f9fafb;
        font-size: 11px;
        font-weight: 500;
        box-shadow: 0 10px 30px rgba(37, 99, 235, 0.7);
      }

      .content {
        flex: 1;
        padding: 0 24px 22px;
        max-width: 1400px;
        margin: 0 auto;
        display: grid;
        grid-template-columns: minmax(0, 1fr);
        gap: 22px;
        align-items: flex-start;
      }

      .chart-card {
        border-radius: var(--radius-lg);
        background: rgba(255, 255, 255, 0.97);
        border: 1px solid rgba(148, 163, 184, 0.6);
        box-shadow: 0 18px 40px rgba(15, 23, 42, 0.08);
        padding: 18px 18px 14px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        min-height: 380px;
      }

      .chart-card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 12px;
      }

      .chart-title-block {
        display: flex;
        flex-direction: column;
        gap: 2px;
        max-width: 60%;
      }

      .chart-kicker {
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 0.16em;
        color: var(--text-sub);
      }

      .chart-title {
        font-size: 14px;
        font-weight: 600;
      }

      .chart-sub {
        font-size: 11px;
        color: var(--text-sub);
      }

      .chart-badge {
        font-size: 10px;
        border-radius: var(--radius-pill);
        padding: 3px 7px;
        background: rgba(239, 246, 255, 0.9);
        border: 1px solid rgba(191, 219, 254, 0.9);
        color: var(--accent-strong);
      }

      .chart-controls {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 6px;
        min-width: 260px;
      }

      .chart-mini-filter {
        display: flex;
        align-items: center;
        gap: 4px;
        flex-wrap: wrap;
        justify-content: flex-end;
      }

      .chart-mini-label {
        font-size: 11px;
        color: var(--text-sub);
      }

      .chart-mini-chips {
        display: flex;
        flex-wrap: wrap;
        justify-content: flex-end;
        gap: 4px;
      }

      .chart-mini-radio {
        font-size: 11px;
        color: var(--text-sub);
        display: inline-flex;
        flex-wrap: wrap;
        gap: 6px;
        justify-content: flex-end;
      }

      .chart-mini-radio label {
        display: inline-flex;
        align-items: center;
        gap: 3px;
        cursor: pointer;
      }

      .chart-mini-radio input {
        accent-color: var(--accent-strong);
        cursor: pointer;
      }

      .chart {
        width: 100%;
        height: 320px;
      }

      .chart-summary {
        font-size: 11px;
        color: var(--text-sub);
        padding-top: 4px;
        border-top: 1px dashed rgba(148, 163, 184, 0.5);
      }

      .chart-summary strong {
        color: var(--text-main);
      }
      /* 图表下方：按月份切换的数据分析块 */
      .chart-analysis-box {
        margin-top: 4px;
        border-radius: var(--radius-md);
        border: 1px solid rgba(209, 213, 219, 0.9);
        background: rgba(249, 250, 251, 0.96);
        display: flex;
        align-items: stretch;
        overflow: hidden;
      }

      .chart-analysis-months {
        flex: 0 0 70px;
        border-right: 1px solid rgba(209, 213, 219, 0.9);
        padding: 6px 4px;
        display: flex;
        flex-direction: column;
        gap: 4px;
        background: rgba(243, 244, 246, 0.95);
      }

      .chart-analysis-months-title {
        font-size: 11px;
        color: var(--text-sub);
        margin-bottom: 2px;
      }

      .chart-analysis-month-btn {
        width: 100%;
        font-size: 11px;
        border-radius: var(--radius-sm);
        border: 1px solid transparent;
        padding: 3px 6px;
        background: transparent;
        color: var(--text-sub);
        text-align: left;
        cursor: pointer;
        white-space: nowrap;
      }

      .chart-analysis-month-btn:hover {
        background: rgba(229, 231, 235, 0.9);
      }

      .chart-analysis-month-btn.active {
        background: rgba(129, 140, 248, 0.08);
        border-color: var(--accent-strong);
        color: var(--text-main);
        font-weight: 500;
      }

      .chart-analysis-body {
        flex: 1;
        padding: 6px 8px;
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .chart-analysis-title {
        font-size: 11px;
        color: var(--text-sub);
        font-weight: 500;
      }

      .chart-analysis-text {
        font-size: 11px;
        color: var(--text-main);
        line-height: 1.6;
        white-space: pre-wrap;
      }

      .chart-comment {
        margin-top: 4px;
        border-radius: var(--radius-md);
        border: 1px solid rgba(209, 213, 219, 0.8);
        padding: 6px 8px;
        background: rgba(249, 250, 251, 0.95);
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .chart-comment-label {
        font-size: 11px;
        color: var(--text-sub);
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 6px;
      }

      .chart-comment textarea {
        width: 100%;
        min-height: 52px;
        max-height: 130px;
        font-size: 11px;
        font-family: inherit;
        border-radius: 8px;
        border: 1px solid rgba(209, 213, 219, 0.9);
        padding: 4px 6px;
        resize: vertical;
        outline: none;
        background-color: #fff;
      }

      .chart-comment textarea:focus {
        border-color: var(--accent-strong);
        box-shadow: 0 0 0 1px rgba(129, 140, 248, 0.15);
      }

      .comment-actions {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 6px;
      }

      .btn-save {
        padding: 3px 10px;
        font-size: 11px;
        border-radius: var(--radius-pill);
        border: none;
        cursor: pointer;
        background: linear-gradient(120deg, var(--accent-strong), #22c55e);
        color: white;
        font-weight: 500;
        box-shadow: 0 8px 18px rgba(37, 99, 235, 0.5);
        transition: transform var(--transition-fast),
          box-shadow var(--transition-fast);
      }

      .btn-save:active {
        transform: translateY(1px);
        box-shadow: 0 5px 12px rgba(37, 99, 235, 0.5);
      }

      .comment-status {
        font-size: 10px;
        color: var(--text-sub);
      }

      .filter-chip {
        font-size: 11px;
        padding: 3px 8px;
        border-radius: var(--radius-pill);
        border: 1px solid rgba(148, 163, 184, 0.6);
        background: rgba(249, 250, 251, 0.9);
        display: inline-flex;
        align-items: center;
        gap: 4px;
        cursor: pointer;
        user-select: none;
        white-space: nowrap;
      }

      .filter-chip input {
        accent-color: var(--accent-strong);
        cursor: pointer;
      }

      .filter-chip-active {
        border-color: rgba(37, 99, 235, 0.9);
        background: var(--accent-soft);
        color: var(--accent-strong);
      }

      .footer {
        padding: 8px 24px 14px;
        font-size: 10px;
        color: var(--text-sub);
        display: flex;
        justify-content: space-between;
        gap: 10px;
        border-top: 1px solid rgba(148, 163, 184, 0.35);
        background: linear-gradient(
          to right,
          rgba(248, 250, 252, 0.92),
          rgba(241, 245, 249, 0.96)
        );
      }

      .footer strong {
        font-weight: 600;
      }

      @media (max-width: 900px) {
        .chart-card-header {
          flex-direction: column;
          align-items: flex-start;
        }
        .chart-title-block {
          max-width: 100%;
        }
        .chart-controls {
          align-items: flex-start;
          min-width: 0;
        }
        .hero {
          flex-direction: column;
          align-items: flex-start;
        }
        .hero-side {
          align-items: flex-start;
          text-align: left;
        }
      }
      /* ========= 图下方数据表 ========= */
      .chart-table-section {
        margin-top: 6px;
        padding-top: 6px;
        border-top: 1px dashed rgba(148, 163, 184, 0.5);
      }

      .chart-table-title {
        font-size: 11px;
        color: var(--text-sub);
        margin-bottom: 4px;
      }

      .chart-table-wrapper {
        max-height: 260px;
        overflow: auto;
        border-radius: 6px;
        border: 1px solid rgba(209, 213, 219, 0.9);
        background: #ffffff;
      }

      table.chart-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 11px;
      }

      .chart-table thead th,
      .chart-table tbody td {
        padding: 4px 8px;
        border-bottom: 1px solid #f3f4f6;
        white-space: nowrap;
      }

      .chart-table thead th {
        position: sticky;
        top: 0;
        z-index: 1;
        background: #f9fafb;
        text-align: center;
        font-weight: 500;
        color: var(--text-sub);
      }

      .chart-table tbody tr:nth-child(odd) td {
        background: #fcfcff;
      }

      .chart-table tbody tr:hover td {
        background: #eef2ff;
      }

      .chart-table td.num {
        text-align: right;
        font-variant-numeric: tabular-nums;
      }

      .chart-table td.highlight {
        color: #d4380d;
        font-weight: 600;
      }
    </style>
  </head>

  <body>
    <div class="page">
      <header class="top-bar">
        <div class="top-left">
          <div class="brand-mark">
            <div class="brand-mark-inner"></div>
          </div>
          <div>
            <div class="brand-text-main">Bangbet Growth Console</div>
            <div class="brand-text-sub">Organic · Monthly Comparison</div>
            <div class="breadcrumb">
              <a href="../index.html">首页目录</a> / 自然量月度数据对比
            </div>
          </div>
        </div>
        <div class="top-right">
          <div class="badge-env">
            <span class="badge-dot"></span>
            <span>Prod · Light · 自然渠道</span>
          </div>
          <div>单位：人数 / % / USD 等值 · 周期：按月 + 按日</div>
        </div>
      </header>

      <section class="hero">
        <div class="hero-main">
          <div class="hero-title">
            <span class="bar"></span>
            <span>自然量月度数据对比 · 看板</span>
          </div>
          <div class="hero-sub">
            按国家和月份拆解自然注册规模、付费率、ARPPU、人均流水、体育/游戏结构和留存表现，
            支持每张图单独筛选月份/国家/指标，并为日维度折线图预留「按月导入原始数据」的统一入口。
          </div>
          <div class="hero-tags">
            <span class="hero-tag">范围：GH / KE / NG / TZ / UG</span>
            <span class="hero-tag"
              >指标：注册 · 付费率 · ARPPU · 人均流水 · 玩法结构 · 留存</span
            >
            <span class="hero-tag">来源：自然渠道（非买量）</span>
          </div>
        </div>
        <div class="hero-side">
          <div>当前版本：v3.1 · 所有指标统一从 RAW_ORGANIC_BY_MONTH 聚合。</div>
          <div>
            每月新增数据：只需在 RAW_ORGANIC_BY_MONTH
            中新增一个月份数组，无需改任何图表逻辑。
          </div>
          <div class="hero-pill">
            提示：保存备注后复制浏览器地址，发给同事即可共享同一版备注。
          </div>
        </div>
      </section>

      <main class="content">
        <!-- 1. 自然注册量 -->
        <section class="chart-card" id="card-registrations">
          <header class="chart-card-header">
            <div class="chart-title-block">
              <div class="chart-kicker">Scale</div>
              <div class="chart-title">自然注册量 · 月度 / 日度对比</div>
              <div class="chart-sub">
                按国家对比不同月份的自然注册规模，并可切到日维度折线图看每日新增走势（最多选
                3 个月）。
              </div>
            </div>
            <div class="chart-controls">
              <span class="chart-badge">单位：人（自然注册）</span>
              <div class="chart-mini-filter">
                <span class="chart-mini-label">视图：</span>
                <div class="chart-mini-radio">
                  <label>
                    <input type="radio" name="reg-view" value="bar" checked />
                    柱状（月度）
                  </label>
                  <label>
                    <input type="radio" name="reg-view" value="line" />
                    折线（日度）
                  </label>
                </div>
              </div>
              <div class="chart-mini-filter">
                <span class="chart-mini-label">月份：</span>
                <div class="chart-mini-chips" id="reg-months"></div>
              </div>
              <div class="chart-mini-filter">
                <span class="chart-mini-label">国家：</span>
                <div class="chart-mini-chips" id="reg-countries"></div>
              </div>
            </div>
          </header>
          <div class="chart" id="chart-registrations"></div>
          <div class="chart-summary" data-analysis-key="reg"></div>
          <div class="chart-table-section">
            <div class="chart-table-title">
              当前筛选 · 自然新增注册（月度汇总）
            </div>
            <div class="chart-table-wrapper">
              <table id="table-registrations" class="chart-table"></table>
            </div>
          </div>

          <div class="chart-comment" data-comment-key="organic-registrations">
            <div class="chart-comment-label">
              <span>我的备注（注册规模 &amp; 日期波动）</span>
            </div>
            <textarea
              placeholder="例如：9 月中旬 NG 自然峰值对应某场顶级赛事；10 月下旬 KE 自然回落与搜索排名变化相关..."
            ></textarea>
            <div class="comment-actions">
              <button type="button" class="btn-save">保存备注</button>
              <span class="comment-status"
                >备注保存在浏览器本地，并写入当前链接；保存后复制地址栏即可分享。</span
              >
            </div>
          </div>
        </section>

        <!-- 2. 付费率 -->
        <section class="chart-card" id="card-payrate">
          <header class="chart-card-header">
            <div class="chart-title-block">
              <div class="chart-kicker">Monetization</div>
              <div class="chart-title">自然用户 D0 / D7 付费率</div>
              <div class="chart-sub">
                国家 × 月份对比 D0、D7 付费渗透，支持柱状（月度）与日折线；D0 与
                D7 分柱展示，D7 柱子透明度更低，折线图中 D0 为虚线、D7 为实线。
              </div>
            </div>
            <div class="chart-controls">
              <span class="chart-badge">单位：%（自然用户付费率）</span>
              <div class="chart-mini-filter">
                <span class="chart-mini-label">视图：</span>
                <div class="chart-mini-radio">
                  <label>
                    <input type="radio" name="pay-view" value="bar" checked />
                    柱状（月度）
                  </label>
                  <label>
                    <input type="radio" name="pay-view" value="line" />
                    折线（日度）
                  </label>
                </div>
              </div>
              <div class="chart-mini-filter">
                <span class="chart-mini-label">月份：</span>
                <div class="chart-mini-chips" id="pay-months"></div>
              </div>
              <div class="chart-mini-filter">
                <span class="chart-mini-label">国家：</span>
                <div class="chart-mini-chips" id="pay-countries"></div>
              </div>
              <div class="chart-mini-filter">
                <span class="chart-mini-label">天数：</span>
                <div class="chart-mini-radio">
                  <label>
                    <input
                      type="radio"
                      name="pay-day-type"
                      value="both"
                      checked
                    />
                    D0 + D7
                  </label>
                  <label>
                    <input type="radio" name="pay-day-type" value="D0" />
                    仅 D0
                  </label>
                  <label>
                    <input type="radio" name="pay-day-type" value="D7" />
                    仅 D7
                  </label>
                </div>
              </div>
            </div>
          </header>
          <div class="chart" id="chart-payrate"></div>
          <div class="chart-summary" data-analysis-key="pay"></div>
          <div class="chart-table-section">
            <div class="chart-table-title">
              当前筛选 · 自然用户 D0 / D7 付费率（月度）
            </div>
            <div class="chart-table-wrapper">
              <table id="table-payrate" class="chart-table"></table>
            </div>
          </div>

          <div class="chart-comment" data-comment-key="organic-payrate">
            <div class="chart-comment-label">
              <span>我的备注（付费率变化 &amp; 背景）</span>
            </div>
            <textarea
              placeholder="例如：TZ 10 月 D0 付费率下滑主要来自某体育冷门赛程；KE 自然 D7 付费率提升与首存活动改版有关..."
            ></textarea>
            <div class="comment-actions">
              <button type="button" class="btn-save">保存备注</button>
              <span class="comment-status"></span>
            </div>
          </div>
        </section>

        <!-- 3. ARPPU -->
        <section class="chart-card" id="card-arppu">
          <header class="chart-card-header">
            <div class="chart-title-block">
              <div class="chart-kicker">Value</div>
              <div class="chart-title">自然用户 D0 / D7 ARPPU</div>
              <div class="chart-sub">
                比较自然盘付费用户的人均付费额，支持按国家看 D0 / D7
                分柱，也可以按月份画折线，判断高价值用户水平是否抬升或下滑。
              </div>
            </div>
            <div class="chart-controls">
              <span class="chart-badge">单位：USD 等值 / 付费用户</span>
              <div class="chart-mini-filter">
                <span class="chart-mini-label">视图：</span>
                <div class="chart-mini-radio">
                  <label>
                    <input type="radio" name="arppu-view" value="bar" checked />
                    柱状（国家）
                  </label>
                  <label>
                    <input type="radio" name="arppu-view" value="line" />
                    折线（按月）
                  </label>
                </div>
              </div>
              <div class="chart-mini-filter">
                <span class="chart-mini-label">月份：</span>
                <div class="chart-mini-chips" id="arppu-months"></div>
              </div>
              <div class="chart-mini-filter">
                <span class="chart-mini-label">国家：</span>
                <div class="chart-mini-chips" id="arppu-countries"></div>
              </div>
              <div class="chart-mini-filter">
                <span class="chart-mini-label">天数：</span>
                <div class="chart-mini-radio">
                  <label>
                    <input
                      type="radio"
                      name="arppu-day-type"
                      value="both"
                      checked
                    />
                    D0 + D7
                  </label>
                  <label>
                    <input type="radio" name="arppu-day-type" value="D0" />
                    仅 D0
                  </label>
                  <label>
                    <input type="radio" name="arppu-day-type" value="D7" />
                    仅 D7
                  </label>
                </div>
              </div>
            </div>
          </header>
          <div class="chart" id="chart-arppu"></div>
          <div class="chart-summary" data-analysis-key="arppu"></div>
          <div class="chart-table-section">
            <div class="chart-table-title">
              当前筛选 · 自然用户 D0 / D7 ARPPU（月度）
            </div>
            <div class="chart-table-wrapper">
              <table id="table-arppu" class="chart-table"></table>
            </div>
          </div>

          <div class="chart-comment" data-comment-key="organic-arppu">
            <div class="chart-comment-label">
              <span>我的备注（高价值付费用户 &amp; 国家差异）</span>
            </div>
            <textarea
              placeholder="例如：UG 10 月 D7 ARPPU 飙升主要来自 jackpot/高赔率赛事，后续需关注是否具有持续性..."
            ></textarea>
            <div class="comment-actions">
              <button type="button" class="btn-save">保存备注</button>
              <span class="comment-status"></span>
            </div>
          </div>
        </section>

        <!-- 4. 人均流水 -->
        <section class="chart-card" id="card-flow">
          <header class="chart-card-header">
            <div class="chart-title-block">
              <div class="chart-kicker">Betting Depth</div>
              <div class="chart-title">
                自然用户 D0 / D7 人均流水（体育 / 游戏 / 总）
              </div>
              <div class="chart-sub">
                按玩法拆分人均投注流水，支持切换体育 / 游戏 / 总计以及 D0 /
                D7，既可以按国家柱状对比，也可以按月份看折线趋势。
              </div>
            </div>
            <div class="chart-controls">
              <span class="chart-badge">单位：USD 等值 / 下注用户</span>
              <div class="chart-mini-filter">
                <span class="chart-mini-label">视图：</span>
                <div class="chart-mini-radio">
                  <label>
                    <input type="radio" name="flow-view" value="bar" checked />
                    柱状（国家）
                  </label>
                  <label>
                    <input type="radio" name="flow-view" value="line" />
                    折线（按月）
                  </label>
                </div>
              </div>
              <div class="chart-mini-filter">
                <span class="chart-mini-label">玩法：</span>
                <div class="chart-mini-radio">
                  <label>
                    <input
                      type="radio"
                      name="flow-dim"
                      value="sports"
                      checked
                    />
                    体育
                  </label>
                  <label>
                    <input type="radio" name="flow-dim" value="game" />
                    游戏
                  </label>
                  <label>
                    <input type="radio" name="flow-dim" value="total" />
                    总计
                  </label>
                </div>
              </div>
              <div class="chart-mini-filter">
                <span class="chart-mini-label">月份：</span>
                <div class="chart-mini-chips" id="flow-months"></div>
              </div>
              <div class="chart-mini-filter">
                <span class="chart-mini-label">国家：</span>
                <div class="chart-mini-chips" id="flow-countries"></div>
              </div>
              <div class="chart-mini-filter">
                <span class="chart-mini-label">天数：</span>
                <div class="chart-mini-radio">
                  <label>
                    <input
                      type="radio"
                      name="flow-day-type"
                      value="both"
                      checked
                    />
                    D0 + D7
                  </label>
                  <label>
                    <input type="radio" name="flow-day-type" value="D0" />
                    仅 D0
                  </label>
                  <label>
                    <input type="radio" name="flow-day-type" value="D7" />
                    仅 D7
                  </label>
                </div>
              </div>
            </div>
          </header>
          <div class="chart" id="chart-flow"></div>
          <div class="chart-summary" data-analysis-key="flow"></div>
          <div class="chart-comment" data-comment-key="organic-flow">
            <div class="chart-comment-label">
              <span>我的备注（体育/游戏深度 &amp; 国家策略）</span>
            </div>
            <textarea
              placeholder="例如：UG 10 月游戏人均流水明显抬升，说明自然用户投注更多集中在 slots，可配合游戏向素材放量..."
            ></textarea>
            <div class="comment-actions">
              <button type="button" class="btn-save">保存备注</button>
              <span class="comment-status"></span>
            </div>
          </div>
        </section>

        <!-- 5. 体育 vs 游戏玩家比例 -->
        <section class="chart-card" id="card-ratio">
          <header class="chart-card-header">
            <div class="chart-title-block">
              <div class="chart-kicker">Mix</div>
              <div class="chart-title">体育 vs 游戏玩家比例（自然量）</div>
              <div class="chart-sub">
                指标为“体育投注用户数 ÷ 游戏投注用户数”，大于 1
                表示体育玩家更多。柱状图按国家对比，折线图按月份看结构变化，D0 /
                D7 可切换。
              </div>
            </div>
            <div class="chart-controls">
              <span class="chart-badge">单位：体育玩家 / 游戏玩家</span>
              <div class="chart-mini-filter">
                <span class="chart-mini-label">视图：</span>
                <div class="chart-mini-radio">
                  <label>
                    <input type="radio" name="ratio-view" value="bar" checked />
                    柱状（国家）
                  </label>
                  <label>
                    <input type="radio" name="ratio-view" value="line" />
                    折线（按月）
                  </label>
                </div>
              </div>
              <div class="chart-mini-filter">
                <span class="chart-mini-label">月份：</span>
                <div class="chart-mini-chips" id="ratio-months"></div>
              </div>
              <div class="chart-mini-filter">
                <span class="chart-mini-label">国家：</span>
                <div class="chart-mini-chips" id="ratio-countries"></div>
              </div>
              <div class="chart-mini-filter">
                <span class="chart-mini-label">天数：</span>
                <div class="chart-mini-radio">
                  <label>
                    <input
                      type="radio"
                      name="ratio-day-type"
                      value="both"
                      checked
                    />
                    D0 + D7
                  </label>
                  <label>
                    <input type="radio" name="ratio-day-type" value="D0" />
                    D0
                  </label>
                  <label>
                    <input type="radio" name="ratio-day-type" value="D7" />
                    D7
                  </label>
                </div>
              </div>
            </div>
          </header>
          <div class="chart" id="chart-ratio"></div>
          <div class="chart-summary" data-analysis-key="ratio"></div>
          <div class="chart-table-section">
            <div class="chart-table-title">
              当前筛选 · 体育 vs 游戏玩家比例（月度）大于1代表体育玩家多余游戏玩家
            </div>
            <div class="chart-table-wrapper">
              <table id="table-ratio" class="chart-table"></table>
            </div>
          </div>

          <div class="chart-comment" data-comment-key="organic-ratio">
            <div class="chart-comment-label">
              <span>我的备注（体育/游戏结构 &amp; 投放素材方向）</span>
            </div>
            <textarea
              placeholder="例如：KE 自然体育用户占比低，可用更多体育内容的 SEO/品牌曝光去拉体育向自然盘..."
            ></textarea>
            <div class="comment-actions">
              <button type="button" class="btn-save">保存备注</button>
              <span class="comment-status"></span>
            </div>
          </div>
        </section>

        <!-- 6. 留存 -->
        <section class="chart-card" id="card-retention">
          <header class="chart-card-header">
            <div class="chart-title-block">
              <div class="chart-kicker">Retention</div>
              <div class="chart-title">自然用户次日 / 7 日留存率</div>
              <div class="chart-sub">
                观察各国家自然用户的 D1、D7 登录留存表现。柱状图按国家 ×
                月份对比，折线图按日期看 D1 / D7 留存曲线（D1 虚线、D7 实线）。
              </div>
            </div>
            <div class="chart-controls">
              <span class="chart-badge">单位：%（登录留存率）</span>
              <div class="chart-mini-filter">
                <span class="chart-mini-label">视图：</span>
                <div class="chart-mini-radio">
                  <label>
                    <input type="radio" name="ret-view" value="bar" checked />
                    柱状（月度）
                  </label>
                  <label>
                    <input type="radio" name="ret-view" value="line" />
                    折线（日度）
                  </label>
                </div>
              </div>
              <div class="chart-mini-filter">
                <span class="chart-mini-label">月份：</span>
                <div class="chart-mini-chips" id="ret-months"></div>
              </div>
              <div class="chart-mini-filter">
                <span class="chart-mini-label">国家：</span>
                <div class="chart-mini-chips" id="ret-countries"></div>
              </div>
            </div>
          </header>
          <div class="chart" id="chart-retention"></div>
          <div class="chart-summary" data-analysis-key="retention"></div>
          <div class="chart-table-section">
            <div class="chart-table-title">
              当前筛选 · 次日 / 7 日留存率 &amp; 次日至七日流失率（月度）
            </div>
            <div class="chart-table-wrapper">
              <table id="table-retention" class="chart-table"></table>
            </div>
          </div>

          <div class="chart-comment" data-comment-key="organic-retention">
            <div class="chart-comment-label">
              <span>我的备注（留存问题 &amp; 动作）</span>
            </div>
            <textarea
              placeholder="例如：NG 10 月 D1→D7 流失率上升到 70%+，需配合任务、push、bonus 做一周内持续激活..."
            ></textarea>
            <div class="comment-actions">
              <button type="button" class="btn-save">保存备注</button>
              <span class="comment-status"></span>
            </div>
          </div>
        </section>
      </main>

      <footer class="footer">
        <span
          >Owner：<strong>用户增长部-Jerry Lyu</strong> · 自然量看板 v3.1（从
          RAW_ORGANIC_BY_MONTH 聚合）</span
        >
        <span>数据来源：内部自然量报表 · 时间口径建议统一为 UTC+0 日切。</span>
      </footer>
    </div>

    <!-- ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>

   

      // ===========================
      // 1. 配色与基础工具函数
      // ===========================

      // ===========================
      // 1. 配色与基础工具函数
      // ===========================

      const MONTH_COLOR_MAP = {
        "2025-09": "#f97316",
        "2025-10": "#2563eb",
        "2025-11": "#16a34a",
        "2025-12": "#7c3aed",
        "2026-01": "#e11d48",
      };

      const DEFAULT_COLOR_PALETTE = [
        "#2563eb",
        "#16a34a",
        "#f97316",
        "#7c3aed",
        "#ef4444",
        "#0f766e",
      ];

      function getColorForMonth(month, idx) {
        if (MONTH_COLOR_MAP[month]) return MONTH_COLOR_MAP[month];
        return DEFAULT_COLOR_PALETTE[idx % DEFAULT_COLOR_PALETTE.length];
      }

      // 新增：国家固定配色（所有日折线用这个）
      const COUNTRY_COLOR_MAP = {
        GH: "#2563eb",
        KE: "#16a34a",
        NG: "#f97316",
        TZ: "#7c3aed",
        UG: "#ef4444",
      };

      // 如果以后有新国家，自动 fallback 到默认调色板
      function getColorForCountry(country, idx) {
        if (COUNTRY_COLOR_MAP[country]) return COUNTRY_COLOR_MAP[country];
        return DEFAULT_COLOR_PALETTE[idx % DEFAULT_COLOR_PALETTE.length];
      }

      function safeDivide(num, denom, multiplier) {
        const n = Number(num);
        const d = Number(denom);
        const m = multiplier == null ? 1 : multiplier;
        if (!Number.isFinite(n) || !Number.isFinite(d) || d <= 0) return 0;
        return (n / d) * m;
      }

      // ===========================
      // 2. 从 RAW 构建聚合索引
      // ===========================

      const NUMERIC_FIELDS = [
        "registration",
        "D0_unique_purchase",
        "D0_PURCHASE_VALUE",
        "D0_TOTAL_BET_PLACED_USER",
        "D0_SPORTS_BET_PLACED_USER",
        "D0_GAMES_BET_PLACED_USER",
        "D0_SPORTS_BET_FLOW",
        "D0_GAMES_BET_FLOW",
        "D0_TOTAL_BET_FLOW",
        "D7_unique_purchase",
        "D7_PURCHASE_VALUE",
        "D7_TOTAL_BET_PLACED_USER",
        "D7_SPORTS_BET_PLACED_USER",
        "D7_GAMES_BET_PLACED_USER",
        "D7_SPORTS_BET_FLOW",
        "D7_GAMES_BET_FLOW",
        "D7_TOTAL_BET_FLOW",
        "D1_retained_users",
        "D7_retained_users",
      ];

      function createEmptyAgg() {
        const obj = {};
        NUMERIC_FIELDS.forEach((k) => {
          obj[k] = 0;
        });
        return obj;
      }

      function accumulateAgg(target, row) {
        NUMERIC_FIELDS.forEach((k) => {
          const rawVal = row[k];
          if (rawVal == null || rawVal === "") return;
          const v = Number(rawVal);
          if (!Number.isFinite(v)) return;
          target[k] += v;
        });
      }

      const AGG_MONTH = {};
      const ALL_MONTHS = Object.keys(RAW_ORGANIC_BY_MONTH).sort();
      const ALL_COUNTRIES_SET = new Set();

      (function buildAggregates() {
        ALL_MONTHS.forEach((month) => {
          const rows = RAW_ORGANIC_BY_MONTH[month] || [];
          if (!AGG_MONTH[month]) AGG_MONTH[month] = {};
          rows.forEach((row) => {
            const c = row.country;
            if (!c) return;
            ALL_COUNTRIES_SET.add(c);
            if (!AGG_MONTH[month][c]) {
              AGG_MONTH[month][c] = createEmptyAgg();
            }
            accumulateAgg(AGG_MONTH[month][c], row);
          });
        });
      })();

      const ALL_COUNTRIES = Array.from(ALL_COUNTRIES_SET).sort();

      // ===========================
      // 3. 图表状态与通用 UI 工具
      // ===========================

      const charts = [];

      const chartState = {
        reg: { months: [], countries: [], view: "bar" },
        pay: { months: [], countries: [], view: "bar", dayType: "both" },
        arppu: { months: [], countries: [], view: "bar", dayType: "both" },
        flow: {
          months: [],
          countries: [],
          view: "bar",
          dayType: "both",
          dim: "sports",
        },
        ratio: { months: [], countries: [], view: "bar", dayType: "both" },
        ret: { months: [], countries: [], view: "bar" },
      };

      function createMultiSelectChips(options) {
        const {
          containerId,
          values,
          getLabel,
          stateArray,
          max,
          preselect,
          onChange,
        } = options;
        const container = document.getElementById(containerId);
        if (!container || !Array.isArray(values)) return;

        container.innerHTML = "";

        // 初始化默认选中
        if (Array.isArray(stateArray) && stateArray.length === 0) {
          if (preselect === "all") {
            values.forEach((v) => stateArray.push(v));
          } else if (typeof preselect === "number") {
            for (let i = 0; i < Math.min(preselect, values.length); i++) {
              stateArray.push(values[i]);
            }
          }
        }

        values.forEach((value, idx) => {
          const labelEl = document.createElement("label");
          labelEl.className = "filter-chip";
          const input = document.createElement("input");
          input.type = "checkbox";
          input.value = value;

          const selected =
            Array.isArray(stateArray) && stateArray.indexOf(value) !== -1;
          if (selected) {
            input.checked = true;
            labelEl.classList.add("filter-chip-active");
          }

          labelEl.appendChild(input);
          labelEl.appendChild(
            document.createTextNode(
              typeof getLabel === "function" ? getLabel(value, idx) : value
            )
          );

          input.addEventListener("change", () => {
            if (!Array.isArray(stateArray)) return;
            const existsIndex = stateArray.indexOf(value);

            if (input.checked) {
              if (max && stateArray.length >= max && existsIndex === -1) {
                // 超出上限，回滚勾选
                input.checked = false;
                return;
              }
              if (existsIndex === -1) stateArray.push(value);
            } else {
              if (existsIndex !== -1) stateArray.splice(existsIndex, 1);
            }

            labelEl.classList.toggle("filter-chip-active", input.checked);
            if (typeof onChange === "function") onChange();
          });

          container.appendChild(labelEl);
        });

        if (typeof onChange === "function") onChange();
      }

      function bindRadioGroup(name, stateObj, key, onChange) {
        const radios = document.querySelectorAll('input[name="' + name + '"]');
        radios.forEach((r) => {
          if (r.checked) stateObj[key] = r.value;
          r.addEventListener("change", () => {
            if (r.checked) {
              stateObj[key] = r.value;
              if (typeof onChange === "function") onChange();
            }
          });
        });
      }

      // 通用：按日生成折线 series
      // 通用：按日生成折线 series（按国家聚合，跨月不断线）
      function buildDailySeries(months, countries, metricDefs) {
        // 1）先收集所有日期 & 按国家聚合行
        const dateSet = new Set();
        const rowsByCountry = {};

        months.forEach((month) => {
          const rows = RAW_ORGANIC_BY_MONTH[month] || [];
          rows.forEach((row) => {
            if (!row.date) return;
            if (countries.indexOf(row.country) === -1) return;

            dateSet.add(row.date);

            const c = row.country;
            if (!rowsByCountry[c]) rowsByCountry[c] = [];
            rowsByCountry[c].push(row);
          });
        });

        // x 轴：所有选中月份内的日期，排序后当成连续时间轴
        const dates = Array.from(dateSet).sort();
        const dateIndex = new Map();
        dates.forEach((d, i) => dateIndex.set(d, i));

        const series = [];

        // 2）每个「国家 × 指标」是一条连续曲线（跨月合并）
        countries.forEach((country, ci) => {
          const rows = rowsByCountry[country] || [];
          if (!rows.length) return;

          const baseColor = getColorForCountry(country, ci);

          metricDefs.forEach((metric) => {
            const data = new Array(dates.length).fill(null);

            rows.forEach((row) => {
              const idx = dateIndex.get(row.date);
              if (idx == null) return;
              let value = metric.getValue(row);
              if (value == null || Number.isNaN(value)) {
                data[idx] = null;
              } else {
                data[idx] = Number(value.toFixed(2));
              }
            });

            const lineStyle = Object.assign(
              { width: 2, color: baseColor },
              metric.lineStyle || {}
            );

            series.push({
              // 图例不再拆到“国家 × 月份”，只保留“国家 × 指标”
              // 例如：GH · D0、GH · D7
              name: country + " · " + metric.label,
              type: "line",
              smooth: true,
              symbolSize: 3,
              // 关键：跨缺失点也连线，9-30 到 10-01 不再断
              connectNulls: true,
              color: baseColor,
              itemStyle: { color: baseColor },
              lineStyle,
              data,
            });
          });
        });

        return { dates, series };
      }

      // 通用：按月 × 国家生成柱状 series
      function buildMonthlyBarSeries(months, countries, metricDefs) {
        const series = [];
        months.forEach((month, mi) => {
          const monthAgg = AGG_MONTH[month] || {};
          metricDefs.forEach((metric) => {
            const data = countries.map((country) => {
              const agg = monthAgg[country];
              if (!agg) return 0;
              let value = metric.getValue(agg);
              if (value == null || Number.isNaN(value)) return 0;
              return Number(value.toFixed(2));
            });
            const itemStyle =
              typeof metric.getItemStyle === "function"
                ? metric.getItemStyle(month, mi)
                : { color: getColorForMonth(month, mi) };

            series.push({
              name: month + " · " + metric.label,
              type: "bar",
              data,
              itemStyle,
              emphasis: { focus: "series" },
            });
          });
        });
        return series;
      }

      // 指标口径函数
      function payRateFromAgg(agg, day) {
        const reg = agg.registration;
        const payUsers =
          day === "D0" ? agg.D0_unique_purchase : agg.D7_unique_purchase;
        return safeDivide(payUsers, reg, 100);
      }

      function payRateFromRow(row, day) {
        const reg = row.registration;
        const payUsers =
          day === "D0" ? row.D0_unique_purchase : row.D7_unique_purchase;
        return safeDivide(payUsers, reg, 100);
      }

      function arppuFromAgg(agg, day) {
        const val =
          day === "D0" ? agg.D0_PURCHASE_VALUE : agg.D7_PURCHASE_VALUE;
        const users =
          day === "D0" ? agg.D0_unique_purchase : agg.D7_unique_purchase;
        return safeDivide(val, users, 1);
      }

      function arppuFromRow(row, day) {
        const val =
          day === "D0" ? row.D0_PURCHASE_VALUE : row.D7_PURCHASE_VALUE;
        const users =
          day === "D0" ? row.D0_unique_purchase : row.D7_unique_purchase;
        return safeDivide(val, users, 1);
      }

      function flowPerUserFromAgg(agg, day, dim) {
        let flowField;
        let userField;
        if (day === "D0") {
          if (dim === "sports") {
            flowField = "D0_SPORTS_BET_FLOW";
            userField = "D0_SPORTS_BET_PLACED_USER";
          } else if (dim === "game") {
            flowField = "D0_GAMES_BET_FLOW";
            userField = "D0_GAMES_BET_PLACED_USER";
          } else {
            flowField = "D0_TOTAL_BET_FLOW";
            userField = "D0_TOTAL_BET_PLACED_USER";
          }
        } else {
          if (dim === "sports") {
            flowField = "D7_SPORTS_BET_FLOW";
            userField = "D7_SPORTS_BET_PLACED_USER";
          } else if (dim === "game") {
            flowField = "D7_GAMES_BET_FLOW";
            userField = "D7_GAMES_BET_PLACED_USER";
          } else {
            flowField = "D7_TOTAL_BET_FLOW";
            userField = "D7_TOTAL_BET_PLACED_USER";
          }
        }
        return safeDivide(agg[flowField], agg[userField], 1);
      }

      function flowPerUserFromRow(row, day, dim) {
        let flowField;
        let userField;
        if (day === "D0") {
          if (dim === "sports") {
            flowField = "D0_SPORTS_BET_FLOW";
            userField = "D0_SPORTS_BET_PLACED_USER";
          } else if (dim === "game") {
            flowField = "D0_GAMES_BET_FLOW";
            userField = "D0_GAMES_BET_PLACED_USER";
          } else {
            flowField = "D0_TOTAL_BET_FLOW";
            userField = "D0_TOTAL_BET_PLACED_USER";
          }
        } else {
          if (dim === "sports") {
            flowField = "D7_SPORTS_BET_FLOW";
            userField = "D7_SPORTS_BET_PLACED_USER";
          } else if (dim === "game") {
            flowField = "D7_GAMES_BET_FLOW";
            userField = "D7_GAMES_BET_PLACED_USER";
          } else {
            flowField = "D7_TOTAL_BET_FLOW";
            userField = "D7_TOTAL_BET_PLACED_USER";
          }
        }
        return safeDivide(row[flowField], row[userField], 1);
      }

      function ratioFromAgg(agg, day) {
        const sportsField =
          day === "D0"
            ? "D0_SPORTS_BET_PLACED_USER"
            : "D7_SPORTS_BET_PLACED_USER";
        const gameField =
          day === "D0"
            ? "D0_GAMES_BET_PLACED_USER"
            : "D7_GAMES_BET_PLACED_USER";
        return safeDivide(agg[sportsField], agg[gameField], 1);
      }

      function ratioFromRow(row, day) {
        const sportsField =
          day === "D0"
            ? "D0_SPORTS_BET_PLACED_USER"
            : "D7_SPORTS_BET_PLACED_USER";
        const gameField =
          day === "D0"
            ? "D0_GAMES_BET_PLACED_USER"
            : "D7_GAMES_BET_PLACED_USER";
        return safeDivide(row[sportsField], row[gameField], 1);
      }

      function retentionFromAgg(agg, which) {
        const retained =
          which === "D1" ? agg.D1_retained_users : agg.D7_retained_users;
        return safeDivide(retained, agg.registration, 100);
      }

      function retentionFromRow(row, which) {
        const retained =
          which === "D1" ? row.D1_retained_users : row.D7_retained_users;
        return safeDivide(retained, row.registration, 100);
      }
      // ===========================
      // 3. 图下方数据表渲染工具
      // ===========================

      function formatMonthShort(month) {
        if (!month) return "";
        var parts = String(month).split("-");
        if (parts.length === 2) {
          var m = parseInt(parts[1], 10);
          if (!isNaN(m)) return m + "月";
        }
        return String(month);
      }

      function formatPercent(v) {
        if (v == null || !isFinite(v)) return "-";
        return v.toFixed(1) + "%";
      }

      function formatNumber1(v) {
        if (v == null || !isFinite(v)) return "-";
        return v.toFixed(1);
      }

      function formatInteger(v) {
        if (v == null || !isFinite(v)) return "-";
        return Math.round(v).toLocaleString();
      }

      function getAgg(month, country) {
        var byMonth = AGG_MONTH[month];
        if (!byMonth) return null;
        return byMonth[country] || null;
      }

      function renderEmptyTable(tableEl) {
        if (!tableEl) return;
        tableEl.innerHTML =
          "<tbody><tr><td>无数据：请先在上方选择国家和月份</td></tr></tbody>";
      }

      // 1）自然注册量表：国家 × 月注册总数
      function updateRegTable(months, countries) {
        var table = document.getElementById("table-registrations");
        if (!table) return;

        var ms = months && months.length ? months : [];
        var cs = countries && countries.length ? countries : [];
        if (!ms.length || !cs.length) {
          renderEmptyTable(table);
          return;
        }

        var thead = document.createElement("thead");
        var headRow = document.createElement("tr");
        var headHtml = "<th>国家</th>";
        ms.forEach(function (m) {
          headHtml += "<th>" + formatMonthShort(m) + " 注册</th>";
        });
        headRow.innerHTML = headHtml;
        thead.appendChild(headRow);

        var tbody = document.createElement("tbody");
        var sortedCountries = Array.from(cs).sort();

        sortedCountries.forEach(function (c) {
          var tr = document.createElement("tr");
          var tdCountry = document.createElement("td");
          tdCountry.textContent = c;
          tr.appendChild(tdCountry);

          ms.forEach(function (m) {
            var td = document.createElement("td");
            td.className = "num";
            var agg = getAgg(m, c);
            var v = agg ? Number(agg.registration || 0) : null;
            td.textContent = v == null ? "-" : formatInteger(v);
            tr.appendChild(td);
          });

          tbody.appendChild(tr);
        });

        table.innerHTML = "";
        table.appendChild(thead);
        table.appendChild(tbody);
      }

      // 2）付费率表：国家 × (每月 D0 / D7 付费率)
      function updatePayTable(months, countries) {
        var table = document.getElementById("table-payrate");
        if (!table) return;

        var ms = months && months.length ? months : [];
        var cs = countries && countries.length ? countries : [];
        if (!ms.length || !cs.length) {
          renderEmptyTable(table);
          return;
        }

        var thead = document.createElement("thead");
        var headRow = document.createElement("tr");
        var headHtml = "<th>国家</th>";
        ms.forEach(function (m) {
          var label = formatMonthShort(m);
          headHtml += "<th>" + label + " D0</th><th>" + label + " D7</th>";
        });
        headRow.innerHTML = headHtml;
        thead.appendChild(headRow);

        var tbody = document.createElement("tbody");
        var sortedCountries = Array.from(cs).sort();

        sortedCountries.forEach(function (c) {
          var tr = document.createElement("tr");
          var tdCountry = document.createElement("td");
          tdCountry.textContent = c;
          tr.appendChild(tdCountry);

          ms.forEach(function (m) {
            var agg = getAgg(m, c);
            var d0 = null;
            var d7 = null;
            if (agg && agg.registration > 0) {
              d0 = payRateFromAgg(agg, "D0"); // 0–100
              d7 = payRateFromAgg(agg, "D7");
            }

            var td0 = document.createElement("td");
            td0.className = "num";
            td0.textContent = d0 == null ? "-" : formatPercent(d0);
            tr.appendChild(td0);

            var td7 = document.createElement("td");
            td7.className = "num";
            td7.textContent = d7 == null ? "-" : formatPercent(d7);
            tr.appendChild(td7);
          });

          tbody.appendChild(tr);
        });

        table.innerHTML = "";
        table.appendChild(thead);
        table.appendChild(tbody);
      }

      // 3）ARPPU 表：国家 × (每月 D0 / D7 ARPPU)
      function updateArppuTable(months, countries) {
        var table = document.getElementById("table-arppu");
        if (!table) return;

        var ms = months && months.length ? months : [];
        var cs = countries && countries.length ? countries : [];
        if (!ms.length || !cs.length) {
          renderEmptyTable(table);
          return;
        }

        var thead = document.createElement("thead");
        var headRow = document.createElement("tr");
        var headHtml = "<th>国家</th>";
        ms.forEach(function (m) {
          var label = formatMonthShort(m);
          headHtml += "<th>" + label + " D0</th><th>" + label + " D7</th>";
        });
        headRow.innerHTML = headHtml;
        thead.appendChild(headRow);

        var tbody = document.createElement("tbody");
        var sortedCountries = Array.from(cs).sort();

        sortedCountries.forEach(function (c) {
          var tr = document.createElement("tr");
          var tdCountry = document.createElement("td");
          tdCountry.textContent = c;
          tr.appendChild(tdCountry);

          ms.forEach(function (m) {
            var agg = getAgg(m, c);
            var d0 = null;
            var d7 = null;
            if (agg) {
              d0 = arppuFromAgg(agg, "D0");
              d7 = arppuFromAgg(agg, "D7");
            }

            var td0 = document.createElement("td");
            td0.className = "num";
            td0.textContent = d0 == null ? "-" : formatNumber1(d0);
            tr.appendChild(td0);

            var td7 = document.createElement("td");
            td7.className = "num";
            td7.textContent = d7 == null ? "-" : formatNumber1(d7);
            tr.appendChild(td7);
          });

          tbody.appendChild(tr);
        });

        table.innerHTML = "";
        table.appendChild(thead);
        table.appendChild(tbody);
      }

      // 4）体育 vs 游戏比例表：国家 × (每月 D0 / D7 比例，>1 标红)
      function updateRatioTable(months, countries) {
        var table = document.getElementById("table-ratio");
        if (!table) return;

        var ms = months && months.length ? months : [];
        var cs = countries && countries.length ? countries : [];
        if (!ms.length || !cs.length) {
          renderEmptyTable(table);
          return;
        }

        var thead = document.createElement("thead");
        var headRow = document.createElement("tr");
        var headHtml = "<th>国家</th>";
        ms.forEach(function (m) {
          var label = formatMonthShort(m);
          headHtml += "<th>" + label + " D0</th><th>" + label + " D7</th>";
        });
        headRow.innerHTML = headHtml;
        thead.appendChild(headRow);

        var tbody = document.createElement("tbody");
        var sortedCountries = Array.from(cs).sort();

        sortedCountries.forEach(function (c) {
          var tr = document.createElement("tr");
          var tdCountry = document.createElement("td");
          tdCountry.textContent = c;
          tr.appendChild(tdCountry);

          ms.forEach(function (m) {
            var agg = getAgg(m, c);
            var d0 = null;
            var d7 = null;
            if (agg) {
              d0 = ratioFromAgg(agg, "D0");
              d7 = ratioFromAgg(agg, "D7");
            }

            var td0 = document.createElement("td");
            td0.className = "num";
            if (d0 == null || !isFinite(d0)) {
              td0.textContent = "-";
            } else {
              td0.textContent = d0.toFixed(1);
              if (d0 > 1) td0.className += " highlight";
            }
            tr.appendChild(td0);

            var td7 = document.createElement("td");
            td7.className = "num";
            if (d7 == null || !isFinite(d7)) {
              td7.textContent = "-";
            } else {
              td7.textContent = d7.toFixed(1);
              if (d7 > 1) td7.className += " highlight";
            }
            tr.appendChild(td7);
          });

          tbody.appendChild(tr);
        });

        table.innerHTML = "";
        table.appendChild(thead);
        table.appendChild(tbody);
      }

      // 5）留存表：国家 × (每月 D1 / D7 留存率 + D1→D7 流失率)
      function updateRetentionTable(months, countries) {
        var table = document.getElementById("table-retention");
        if (!table) return;

        var ms = months && months.length ? months : [];
        var cs = countries && countries.length ? countries : [];
        if (!ms.length || !cs.length) {
          renderEmptyTable(table);
          return;
        }

        var thead = document.createElement("thead");
        var headRow = document.createElement("tr");
        var headHtml = "<th>国家</th>";
        ms.forEach(function (m) {
          var label = formatMonthShort(m);
          headHtml +=
            "<th>" +
            label +
            " 次日留存</th><th>" +
            label +
            " 7日留存</th><th>" +
            label +
            " 次日至7日流失率</th>";
        });
        headRow.innerHTML = headHtml;
        thead.appendChild(headRow);

        var tbody = document.createElement("tbody");
        var sortedCountries = Array.from(cs).sort();

        sortedCountries.forEach(function (c) {
          var tr = document.createElement("tr");
          var tdCountry = document.createElement("td");
          tdCountry.textContent = c;
          tr.appendChild(tdCountry);

          ms.forEach(function (m) {
            var agg = getAgg(m, c);
            var d1 = null;
            var d7 = null;
            var churn = null;

            if (agg && agg.registration > 0) {
              d1 = retentionFromAgg(agg, "D1"); // 0–100
              d7 = retentionFromAgg(agg, "D7");
              var d1User = Number(agg.D1_retained_users || 0);
              var d7User = Number(agg.D7_retained_users || 0);
              if (d1User > 0) {
                churn = safeDivide(d1User - d7User, d1User, 100);
              }
            }

            var tdD1 = document.createElement("td");
            tdD1.className = "num";
            tdD1.textContent = d1 == null ? "-" : formatPercent(d1);
            tr.appendChild(tdD1);

            var tdD7 = document.createElement("td");
            tdD7.className = "num";
            tdD7.textContent = d7 == null ? "-" : formatPercent(d7);
            tr.appendChild(tdD7);

            var tdChurn = document.createElement("td");
            tdChurn.className = "num";
            tdChurn.textContent = churn == null ? "-" : formatPercent(churn);
            tr.appendChild(tdChurn);
          });

          tbody.appendChild(tr);
        });

        table.innerHTML = "";
        table.appendChild(thead);
        table.appendChild(tbody);
      }

      // ===========================
      // 4. 各图表 init + update
      // ===========================

      // 4.1 注册
      function updateRegChart(chart, st) {
        if (!chart) return;
        const months =
          st.months && st.months.length
            ? st.months.slice(0, 3)
            : ALL_MONTHS.slice(-3);
        const countries =
          st.countries && st.countries.length ? st.countries : ALL_COUNTRIES;
        updateRegTable(months, countries);
        if (st.view === "line") {
          const metricDefs = [
            {
              label: "注册",
              getValue: (row) => Number(row.registration || 0),
              lineStyle: {},
            },
          ];
          const { dates, series } = buildDailySeries(
            months,
            countries,
            metricDefs
          );
          chart.setOption(
            {
              tooltip: { trigger: "axis" },
              legend: { type: "scroll" },
              grid: { left: 40, right: 20, top: 40, bottom: 40 },
              xAxis: {
                type: "category",
                data: dates,
                axisLabel: { formatter: (v) => v.slice(5) },
              },
              yAxis: {
                type: "value",
                name: "注册数",
                axisLabel: {
                  formatter: function (v) {
                    return v >= 1000 ? (v / 1000).toFixed(1) + "k" : v;
                  },
                },
              },
              series,
            },
            true
          );
        } else {
          const metricDefs = [
            {
              label: "注册",
              getValue: (agg) => agg.registration || 0,
              getItemStyle: (month, idx) => ({
                color: getColorForMonth(month, idx),
              }),
            },
          ];
          const series = buildMonthlyBarSeries(months, countries, metricDefs);
          chart.setOption(
            {
              tooltip: { trigger: "axis", axisPointer: { type: "shadow" } },
              legend: { type: "scroll" },
              grid: { left: 40, right: 20, top: 40, bottom: 40 },
              xAxis: { type: "category", data: countries },
              yAxis: {
                type: "value",
                name: "注册数",
                axisLabel: {
                  formatter: function (v) {
                    return v >= 1000 ? (v / 1000).toFixed(1) + "k" : v;
                  },
                },
              },
              series,
            },
            true
          );
        }
      }

      function initRegCard() {
        const dom = document.getElementById("chart-registrations");
        if (!dom) return;
        const chart = echarts.init(dom);
        charts.push(chart);
        const st = chartState.reg;

        createMultiSelectChips({
          containerId: "reg-months",
          values: ALL_MONTHS,
          getLabel: (m) => m,
          stateArray: st.months,
          max: 3,
          preselect: 2,
          onChange: () => updateRegChart(chart, st),
        });

        createMultiSelectChips({
          containerId: "reg-countries",
          values: ALL_COUNTRIES,
          getLabel: (c) => c,
          stateArray: st.countries,
          preselect: "all",
          onChange: () => updateRegChart(chart, st),
        });

        bindRadioGroup("reg-view", st, "view", () => updateRegChart(chart, st));
        updateRegChart(chart, st);
      }

      // 4.2 付费率
      function updatePayChart(chart, st) {
        if (!chart) return;
        const months =
          st.months && st.months.length
            ? st.months.slice(0, 3)
            : ALL_MONTHS.slice(-3);
        const countries =
          st.countries && st.countries.length ? st.countries : ALL_COUNTRIES;
        const dayType = st.dayType || "both";

        updatePayTable(months, countries);

        if (st.view === "line") {
          const metricDefs = [];
          if (dayType === "both" || dayType === "D0") {
            metricDefs.push({
              label: "D0",
              getValue: (row) => payRateFromRow(row, "D0"),
              lineStyle: { type: "dashed" },
            });
          }
          if (dayType === "both" || dayType === "D7") {
            metricDefs.push({
              label: "D7",
              getValue: (row) => payRateFromRow(row, "D7"),
              lineStyle: { type: "solid" },
            });
          }
          const { dates, series } = buildDailySeries(
            months,
            countries,
            metricDefs
          );
          chart.setOption(
            {
              tooltip: {
                trigger: "axis",
                valueFormatter: (val) =>
                  val == null ? "" : Number(val).toFixed(1) + "%",
              },
              legend: { type: "scroll" },
              grid: { left: 40, right: 20, top: 40, bottom: 40 },
              xAxis: {
                type: "category",
                data: dates,
                axisLabel: { formatter: (v) => v.slice(5) },
              },
              yAxis: {
                type: "value",
                name: "付费率 %",
                axisLabel: {
                  formatter: function (v) {
                    return v.toFixed(0) + "%";
                  },
                },
              },
              series,
            },
            true
          );
        } else {
          const metricDefs = [];
          if (dayType === "both" || dayType === "D0") {
            metricDefs.push({
              label: "D0 付费率",
              getValue: (agg) => payRateFromAgg(agg, "D0"),
              getItemStyle: (month, idx) => ({
                color: getColorForMonth(month, idx),
                opacity: 0.9,
              }),
            });
          }
          if (dayType === "both" || dayType === "D7") {
            metricDefs.push({
              label: "D7 付费率",
              getValue: (agg) => payRateFromAgg(agg, "D7"),
              getItemStyle: (month, idx) => ({
                color: getColorForMonth(month, idx),
                opacity: 0.45,
              }),
            });
          }
          const series = buildMonthlyBarSeries(months, countries, metricDefs);
          chart.setOption(
            {
              tooltip: {
                trigger: "axis",
                axisPointer: { type: "shadow" },
                valueFormatter: (val) =>
                  val == null ? "" : Number(val).toFixed(1) + "%",
              },
              legend: { type: "scroll" },
              grid: { left: 40, right: 20, top: 40, bottom: 40 },
              xAxis: { type: "category", data: countries },
              yAxis: {
                type: "value",
                name: "付费率 %",
                axisLabel: {
                  formatter: function (v) {
                    return v.toFixed(0) + "%";
                  },
                },
              },
              series,
            },
            true
          );
        }
      }

      function initPayCard() {
        const dom = document.getElementById("chart-payrate");
        if (!dom) return;
        const chart = echarts.init(dom);
        charts.push(chart);
        const st = chartState.pay;

        createMultiSelectChips({
          containerId: "pay-months",
          values: ALL_MONTHS,
          getLabel: (m) => m,
          stateArray: st.months,
          max: 3,
          preselect: 2,
          onChange: () => updatePayChart(chart, st),
        });

        createMultiSelectChips({
          containerId: "pay-countries",
          values: ALL_COUNTRIES,
          getLabel: (c) => c,
          stateArray: st.countries,
          preselect: "all",
          onChange: () => updatePayChart(chart, st),
        });

        bindRadioGroup("pay-view", st, "view", () => updatePayChart(chart, st));
        bindRadioGroup("pay-day-type", st, "dayType", () =>
          updatePayChart(chart, st)
        );
        updatePayChart(chart, st);
      }

      // 4.3 ARPPU
      function updateArppuChart(chart, st) {
        if (!chart) return;
        const months =
          st.months && st.months.length
            ? st.months.slice(0, 3)
            : ALL_MONTHS.slice(-3);
        const countries =
          st.countries && st.countries.length ? st.countries : ALL_COUNTRIES;
        const dayType = st.dayType || "both";
        updateArppuTable(months, countries);
        if (st.view === "line") {
          const metricDefs = [];
          if (dayType === "both" || dayType === "D0") {
            metricDefs.push({
              label: "D0",
              getValue: (row) => arppuFromRow(row, "D0"),
              lineStyle: { type: "dashed" },
            });
          }
          if (dayType === "both" || dayType === "D7") {
            metricDefs.push({
              label: "D7",
              getValue: (row) => arppuFromRow(row, "D7"),
              lineStyle: { type: "solid" },
            });
          }
          const { dates, series } = buildDailySeries(
            months,
            countries,
            metricDefs
          );
          chart.setOption(
            {
              tooltip: {
                trigger: "axis",
                valueFormatter: (val) =>
                  val == null ? "" : "$" + Number(val).toFixed(2),
              },
              legend: { type: "scroll" },
              grid: { left: 40, right: 20, top: 40, bottom: 40 },
              xAxis: {
                type: "category",
                data: dates,
                axisLabel: { formatter: (v) => v.slice(5) },
              },
              yAxis: {
                type: "value",
                name: "ARPPU",
                axisLabel: {
                  formatter: function (v) {
                    return "$" + v.toFixed(1);
                  },
                },
              },
              series,
            },
            true
          );
        } else {
          const metricDefs = [];
          if (dayType === "both" || dayType === "D0") {
            metricDefs.push({
              label: "D0 ARPPU",
              getValue: (agg) => arppuFromAgg(agg, "D0"),
              getItemStyle: (month, idx) => ({
                color: getColorForMonth(month, idx),
                opacity: 0.9,
              }),
            });
          }
          if (dayType === "both" || dayType === "D7") {
            metricDefs.push({
              label: "D7 ARPPU",
              getValue: (agg) => arppuFromAgg(agg, "D7"),
              getItemStyle: (month, idx) => ({
                color: getColorForMonth(month, idx),
                opacity: 0.45,
              }),
            });
          }
          const series = buildMonthlyBarSeries(months, countries, metricDefs);
          chart.setOption(
            {
              tooltip: {
                trigger: "axis",
                axisPointer: { type: "shadow" },
                valueFormatter: (val) =>
                  val == null ? "" : "$" + Number(val).toFixed(2),
              },
              legend: { type: "scroll" },
              grid: { left: 40, right: 20, top: 40, bottom: 40 },
              xAxis: { type: "category", data: countries },
              yAxis: {
                type: "value",
                name: "ARPPU",
                axisLabel: {
                  formatter: function (v) {
                    return "$" + v.toFixed(1);
                  },
                },
              },
              series,
            },
            true
          );
        }
      }

      function initArppuCard() {
        const dom = document.getElementById("chart-arppu");
        if (!dom) return;
        const chart = echarts.init(dom);
        charts.push(chart);
        const st = chartState.arppu;

        createMultiSelectChips({
          containerId: "arppu-months",
          values: ALL_MONTHS,
          getLabel: (m) => m,
          stateArray: st.months,
          max: 3,
          preselect: 2,
          onChange: () => updateArppuChart(chart, st),
        });

        createMultiSelectChips({
          containerId: "arppu-countries",
          values: ALL_COUNTRIES,
          getLabel: (c) => c,
          stateArray: st.countries,
          preselect: "all",
          onChange: () => updateArppuChart(chart, st),
        });

        bindRadioGroup("arppu-view", st, "view", () =>
          updateArppuChart(chart, st)
        );
        bindRadioGroup("arppu-day-type", st, "dayType", () =>
          updateArppuChart(chart, st)
        );
        updateArppuChart(chart, st);
      }

      // 4.4 人均流水
      function updateFlowChart(chart, st) {
        if (!chart) return;
        const months =
          st.months && st.months.length
            ? st.months.slice(0, 3)
            : ALL_MONTHS.slice(-3);
        const countries =
          st.countries && st.countries.length ? st.countries : ALL_COUNTRIES;
        const dayType = st.dayType || "both";
        const dim = st.dim || "sports";

        const dimLabelMap = {
          sports: "体育",
          game: "游戏",
          total: "总计",
        };
        const dimLabel = dimLabelMap[dim] || dim;

        if (st.view === "line") {
          const metricDefs = [];
          if (dayType === "both" || dayType === "D0") {
            metricDefs.push({
              label: "D0 " + dimLabel,
              getValue: (row) => flowPerUserFromRow(row, "D0", dim),
              lineStyle: { type: "dashed" },
            });
          }
          if (dayType === "both" || dayType === "D7") {
            metricDefs.push({
              label: "D7 " + dimLabel,
              getValue: (row) => flowPerUserFromRow(row, "D7", dim),
              lineStyle: { type: "solid" },
            });
          }
          const { dates, series } = buildDailySeries(
            months,
            countries,
            metricDefs
          );
          chart.setOption(
            {
              tooltip: {
                trigger: "axis",
                valueFormatter: (val) =>
                  val == null ? "" : "$" + Number(val).toFixed(2),
              },
              legend: { type: "scroll" },
              grid: { left: 40, right: 20, top: 40, bottom: 40 },
              xAxis: {
                type: "category",
                data: dates,
                axisLabel: { formatter: (v) => v.slice(5) },
              },
              yAxis: {
                type: "value",
                name: dimLabel + "人均流水",
                axisLabel: {
                  formatter: function (v) {
                    return "$" + v.toFixed(1);
                  },
                },
              },
              series,
            },
            true
          );
        } else {
          const metricDefs = [];
          if (dayType === "both" || dayType === "D0") {
            metricDefs.push({
              label: "D0 " + dimLabel,
              getValue: (agg) => flowPerUserFromAgg(agg, "D0", dim),
              getItemStyle: (month, idx) => ({
                color: getColorForMonth(month, idx),
                opacity: 0.9,
              }),
            });
          }
          if (dayType === "both" || dayType === "D7") {
            metricDefs.push({
              label: "D7 " + dimLabel,
              getValue: (agg) => flowPerUserFromAgg(agg, "D7", dim),
              getItemStyle: (month, idx) => ({
                color: getColorForMonth(month, idx),
                opacity: 0.45,
              }),
            });
          }
          const series = buildMonthlyBarSeries(months, countries, metricDefs);
          chart.setOption(
            {
              tooltip: {
                trigger: "axis",
                axisPointer: { type: "shadow" },
                valueFormatter: (val) =>
                  val == null ? "" : "$" + Number(val).toFixed(2),
              },
              legend: { type: "scroll" },
              grid: { left: 40, right: 20, top: 40, bottom: 40 },
              xAxis: { type: "category", data: countries },
              yAxis: {
                type: "value",
                name: dimLabel + "人均流水",
                axisLabel: {
                  formatter: function (v) {
                    return "$" + v.toFixed(1);
                  },
                },
              },
              series,
            },
            true
          );
        }
      }

      function initFlowCard() {
        const dom = document.getElementById("chart-flow");
        if (!dom) return;
        const chart = echarts.init(dom);
        charts.push(chart);
        const st = chartState.flow;

        createMultiSelectChips({
          containerId: "flow-months",
          values: ALL_MONTHS,
          getLabel: (m) => m,
          stateArray: st.months,
          max: 3,
          preselect: 2,
          onChange: () => updateFlowChart(chart, st),
        });

        createMultiSelectChips({
          containerId: "flow-countries",
          values: ALL_COUNTRIES,
          getLabel: (c) => c,
          stateArray: st.countries,
          preselect: "all",
          onChange: () => updateFlowChart(chart, st),
        });

        bindRadioGroup("flow-view", st, "view", () =>
          updateFlowChart(chart, st)
        );
        bindRadioGroup("flow-day-type", st, "dayType", () =>
          updateFlowChart(chart, st)
        );
        bindRadioGroup("flow-dim", st, "dim", () => updateFlowChart(chart, st));
        updateFlowChart(chart, st);
      }

      // 4.5 体育 vs 游戏比例
      function updateRatioChart(chart, st) {
        if (!chart) return;
        const months =
          st.months && st.months.length
            ? st.months.slice(0, 3)
            : ALL_MONTHS.slice(-3);
        const countries =
          st.countries && st.countries.length ? st.countries : ALL_COUNTRIES;
        const dayType = st.dayType || "both";
        updateRatioTable(months, countries);
        if (st.view === "line") {
          const metricDefs = [];
          if (dayType === "both" || dayType === "D0") {
            metricDefs.push({
              label: "D0",
              getValue: (row) => ratioFromRow(row, "D0"),
              lineStyle: { type: "dashed" },
            });
          }
          if (dayType === "both" || dayType === "D7") {
            metricDefs.push({
              label: "D7",
              getValue: (row) => ratioFromRow(row, "D7"),
              lineStyle: { type: "solid" },
            });
          }
          const { dates, series } = buildDailySeries(
            months,
            countries,
            metricDefs
          );
          chart.setOption(
            {
              tooltip: {
                trigger: "axis",
                valueFormatter: (val) =>
                  val == null ? "" : Number(val).toFixed(2),
              },
              legend: { type: "scroll" },
              grid: { left: 40, right: 20, top: 40, bottom: 40 },
              xAxis: {
                type: "category",
                data: dates,
                axisLabel: { formatter: (v) => v.slice(5) },
              },
              yAxis: {
                type: "value",
                name: "体育/游戏",
                axisLabel: {
                  formatter: function (v) {
                    return v.toFixed(2);
                  },
                },
              },
              series,
            },
            true
          );
        } else {
          const metricDefs = [];
          if (dayType === "both" || dayType === "D0") {
            metricDefs.push({
              label: "D0 比例",
              getValue: (agg) => ratioFromAgg(agg, "D0"),
              getItemStyle: (month, idx) => ({
                color: getColorForMonth(month, idx),
                opacity: 0.9,
              }),
            });
          }
          if (dayType === "both" || dayType === "D7") {
            metricDefs.push({
              label: "D7 比例",
              getValue: (agg) => ratioFromAgg(agg, "D7"),
              getItemStyle: (month, idx) => ({
                color: getColorForMonth(month, idx),
                opacity: 0.45,
              }),
            });
          }
          const series = buildMonthlyBarSeries(months, countries, metricDefs);
          chart.setOption(
            {
              tooltip: {
                trigger: "axis",
                axisPointer: { type: "shadow" },
                valueFormatter: (val) =>
                  val == null ? "" : Number(val).toFixed(2),
              },
              legend: { type: "scroll" },
              grid: { left: 40, right: 20, top: 40, bottom: 40 },
              xAxis: { type: "category", data: countries },
              yAxis: {
                type: "value",
                name: "体育/游戏",
                axisLabel: {
                  formatter: function (v) {
                    return v.toFixed(2);
                  },
                },
              },
              series,
            },
            true
          );
        }
      }

      function initRatioCard() {
        const dom = document.getElementById("chart-ratio");
        if (!dom) return;
        const chart = echarts.init(dom);
        charts.push(chart);
        const st = chartState.ratio;

        createMultiSelectChips({
          containerId: "ratio-months",
          values: ALL_MONTHS,
          getLabel: (m) => m,
          stateArray: st.months,
          max: 3,
          preselect: 2,
          onChange: () => updateRatioChart(chart, st),
        });

        createMultiSelectChips({
          containerId: "ratio-countries",
          values: ALL_COUNTRIES,
          getLabel: (c) => c,
          stateArray: st.countries,
          preselect: "all",
          onChange: () => updateRatioChart(chart, st),
        });

        bindRadioGroup("ratio-view", st, "view", () =>
          updateRatioChart(chart, st)
        );
        bindRadioGroup("ratio-day-type", st, "dayType", () =>
          updateRatioChart(chart, st)
        );
        updateRatioChart(chart, st);
      }

      // 4.6 留存
      function updateRetentionChart(chart, st) {
        if (!chart) return;
        const months =
          st.months && st.months.length
            ? st.months.slice(0, 3)
            : ALL_MONTHS.slice(-3);
        const countries =
          st.countries && st.countries.length ? st.countries : ALL_COUNTRIES;
        updateRetentionTable(months, countries);
        if (st.view === "line") {
          const metricDefs = [
            {
              label: "D1",
              getValue: (row) => retentionFromRow(row, "D1"),
              lineStyle: { type: "dashed" },
            },
            {
              label: "D7",
              getValue: (row) => retentionFromRow(row, "D7"),
              lineStyle: { type: "solid" },
            },
          ];
          const { dates, series } = buildDailySeries(
            months,
            countries,
            metricDefs
          );
          chart.setOption(
            {
              tooltip: {
                trigger: "axis",
                valueFormatter: (val) =>
                  val == null ? "" : Number(val).toFixed(1) + "%",
              },
              legend: { type: "scroll" },
              grid: { left: 40, right: 20, top: 40, bottom: 40 },
              xAxis: {
                type: "category",
                data: dates,
                axisLabel: { formatter: (v) => v.slice(5) },
              },
              yAxis: {
                type: "value",
                name: "留存率 %",
                axisLabel: {
                  formatter: function (v) {
                    return v.toFixed(0) + "%";
                  },
                },
              },
              series,
            },
            true
          );
        } else {
          const metricDefs = [
            {
              label: "D1 留存率",
              getValue: (agg) => retentionFromAgg(agg, "D1"),
              getItemStyle: (month, idx) => ({
                color: getColorForMonth(month, idx),
                opacity: 0.9,
              }),
            },
            {
              label: "D7 留存率",
              getValue: (agg) => retentionFromAgg(agg, "D7"),
              getItemStyle: (month, idx) => ({
                color: getColorForMonth(month, idx),
                opacity: 0.45,
              }),
            },
          ];
          const series = buildMonthlyBarSeries(months, countries, metricDefs);
          chart.setOption(
            {
              tooltip: {
                trigger: "axis",
                axisPointer: { type: "shadow" },
                valueFormatter: (val) =>
                  val == null ? "" : Number(val).toFixed(1) + "%",
              },
              legend: { type: "scroll" },
              grid: { left: 40, right: 20, top: 40, bottom: 40 },
              xAxis: { type: "category", data: countries },
              yAxis: {
                type: "value",
                name: "留存率 %",
                axisLabel: {
                  formatter: function (v) {
                    return v.toFixed(0) + "%";
                  },
                },
              },
              series,
            },
            true
          );
        }
      }

      function initRetentionCard() {
        const dom = document.getElementById("chart-retention");
        if (!dom) return;
        const chart = echarts.init(dom);
        charts.push(chart);
        const st = chartState.ret;

        createMultiSelectChips({
          containerId: "ret-months",
          values: ALL_MONTHS,
          getLabel: (m) => m,
          stateArray: st.months,
          max: 3,
          preselect: 2,
          onChange: () => updateRetentionChart(chart, st),
        });

        createMultiSelectChips({
          containerId: "ret-countries",
          values: ALL_COUNTRIES,
          getLabel: (c) => c,
          stateArray: st.countries,
          preselect: "all",
          onChange: () => updateRetentionChart(chart, st),
        });

        bindRadioGroup("ret-view", st, "view", () =>
          updateRetentionChart(chart, st)
        );
        updateRetentionChart(chart, st);
      }

      // ===========================
      // 5. 备注保存：本地 + 链接共享
      // ===========================

      function initCommentBlocks() {
        const STORAGE_KEY = "organic_comments_v1";

        function loadFromUrl() {
          const hash = window.location.hash || "";
          const prefix = "#comments=";
          if (!hash.startsWith(prefix)) return null;
          const encoded = hash.slice(prefix.length);
          if (!encoded) return null;
          try {
            const json = decodeURIComponent(encoded);
            const obj = JSON.parse(json);
            if (obj && typeof obj === "object") return obj;
          } catch (e) {
            console.warn("解析 URL 备注失败", e);
          }
          return null;
        }

        function saveToUrl(comments) {
          try {
            const json = JSON.stringify(comments || {});
            const encoded = encodeURIComponent(json);
            const base = window.location.href.split("#")[0];
            const newUrl = base + "#comments=" + encoded;
            window.history.replaceState(null, "", newUrl);
          } catch (e) {
            console.warn("写入 URL 备注失败", e);
          }
        }

        function loadFromStorage() {
          try {
            const raw = window.localStorage.getItem(STORAGE_KEY);
            if (!raw) return null;
            const obj = JSON.parse(raw);
            if (obj && typeof obj === "object") return obj;
          } catch (e) {
            console.warn("读取本地备注失败", e);
          }
          return null;
        }

        function saveToStorage(comments) {
          try {
            window.localStorage.setItem(STORAGE_KEY, JSON.stringify(comments));
          } catch (e) {
            console.warn("写入本地备注失败", e);
          }
        }

        const comments = loadFromUrl() || loadFromStorage() || {};
        const blocks = document.querySelectorAll(".chart-comment");

        blocks.forEach((block) => {
          const key = block.getAttribute("data-comment-key");
          if (!key) return;
          const textarea = block.querySelector("textarea");
          const btn = block.querySelector(".btn-save");
          const status = block.querySelector(".comment-status");
          if (!textarea || !btn) return;

          if (typeof comments[key] === "string") {
            textarea.value = comments[key];
          }

          btn.addEventListener("click", () => {
            const allComments = {};
            document.querySelectorAll(".chart-comment").forEach((b2) => {
              const k2 = b2.getAttribute("data-comment-key");
              const t2 = b2.querySelector("textarea");
              if (!k2 || !t2) return;
              const val = t2.value.trim();
              if (val) allComments[k2] = val;
            });

            saveToStorage(allComments);
            saveToUrl(allComments);

            const now = new Date();
            const hh = String(now.getHours()).padStart(2, "0");
            const mm = String(now.getMinutes()).padStart(2, "0");
            if (status) {
              status.textContent =
                "已保存 " + hh + ":" + mm + " · 当前浏览器 + 链接可见";
            }
          });
        });
      }
      // ===========================
      // 6. 图表下方：按月份的数据分析块
      // ===========================

      // 把 "2025-09" 转成 "9月"
      function formatMonthLabel(monthKey) {
        if (!monthKey || typeof monthKey !== "string") return monthKey || "";
        const parts = monthKey.split("-");
        const mm = parts[1] || "";
        const mNum = Number(mm) || 0;
        return (mNum > 0 ? mNum : mm) + "月";
      }

      // 默认展示的月份：电脑当前月份的上一个月；若没有该月数据，则用最近一月
      function getDefaultAnalysisMonth() {
        if (!Array.isArray(ALL_MONTHS) || ALL_MONTHS.length === 0) return null;

        const now = new Date();
        // JS 月份从 0 开始，这里取「当前月份 - 1」
        const prevMonthDate = new Date(
          now.getFullYear(),
          now.getMonth() - 1,
          1
        );
        const prevKey = prevMonthDate.toISOString().slice(0, 7); // YYYY-MM

        if (ALL_MONTHS.includes(prevKey)) return prevKey;

        // 找到 <= prevKey 的最新一月
        let candidate = null;
        ALL_MONTHS.forEach((m) => {
          if (m <= prevKey) candidate = m;
        });

        return candidate || ALL_MONTHS[ALL_MONTHS.length - 1];
      }

      function initAnalysisBlocks() {
        const defaultMonth = getDefaultAnalysisMonth();
        const summaries = document.querySelectorAll(
          ".chart-summary[data-analysis-key]"
        );

        summaries.forEach((summaryEl) => {
          const key = summaryEl.getAttribute("data-analysis-key");
          if (!key) return;

          // 清空原有示例文案
          summaryEl.innerHTML = "";

          const box = document.createElement("div");
          box.className = "chart-analysis-box";

          const monthsCol = document.createElement("div");
          monthsCol.className = "chart-analysis-months";

          const titleCol = document.createElement("div");
          titleCol.className = "chart-analysis-body";

          const title = document.createElement("div");
          title.className = "chart-analysis-title";
          title.textContent = "数据分析";

          const text = document.createElement("div");
          text.className = "chart-analysis-text";

          titleCol.appendChild(title);
          titleCol.appendChild(text);

          box.appendChild(monthsCol);
          box.appendChild(titleCol);
          summaryEl.appendChild(box);

          // 按 ALL_MONTHS 生成所有月份按钮，新月份自动出现
          const btns = [];

          ALL_MONTHS.forEach((monthKey) => {
            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = "chart-analysis-month-btn";
            btn.dataset.month = monthKey;
            btn.textContent = formatMonthLabel(monthKey);
            btn.title = monthKey;

            btn.addEventListener("click", () => {
              btns.forEach((b) => b.classList.remove("active"));
              btn.classList.add("active");

              const content =
                ANALYSIS_TEXT[key] &&
                typeof ANALYSIS_TEXT[key][monthKey] === "string" &&
                ANALYSIS_TEXT[key][monthKey].trim()
                  ? ANALYSIS_TEXT[key][monthKey]
                  : "暂未填写该月份的数据分析文案。";

              text.textContent = content;
            });

            monthsCol.appendChild(btn);
            btns.push(btn);
          });

          if (btns.length === 0) {
            text.textContent =
              "当前没有可用月份；请确认 RAW_ORGANIC_BY_MONTH 是否已填入数据。";
            return;
          }

          // 默认选中：优先 defaultMonth，否则最后一个月
          const initialMonth =
            (defaultMonth &&
              ALL_MONTHS.includes(defaultMonth) &&
              defaultMonth) ||
            ALL_MONTHS[ALL_MONTHS.length - 1];

          const initialBtn =
            btns.find((b) => b.dataset.month === initialMonth) ||
            btns[btns.length - 1];

          initialBtn.click();
        });
      }

      // ===========================
      // 8. 新功能入口（扩展用）
      // ===========================
      //
      // 以后如果想新增一张图（例如“自然 GGR 趋势”）：
      //
      // 1）在 HTML 中复制一份 <section class="chart-card"> 结构，
      //    修改外层 id="card-ggr"、图表容器 id="chart-ggr" 等。
      // 2）在 JS 里仿照上面的 initRegCard / updateRegChart：
      //      - 写一个 updateGgrChart(chart, state) 负责算数 + setOption。
      //      - 写一个 initGgrCard() 负责绑定筛选控件 + 调用 update。
      // 3）在 initDashboard() 里追加一行 initGgrCard()。
      //
      // 所有新图表建议只读取 RAW_ORGANIC_BY_MONTH / AGG_MONTH，
      // 不修改这两个结构本身，这样每月只需要更新源数据区就能带动所有图。

      // ===========================
      // 7. 看板初始化入口
      // ===========================

      function initDashboard() {
        initRegCard();
        initPayCard();
        initArppuCard();
        initFlowCard();
        initRatioCard();
        initRetentionCard();
        initAnalysisBlocks();
        initCommentBlocks();

        window.addEventListener("resize", () => {
          charts.forEach((c) => {
            try {
              c.resize();
            } catch (e) {}
          });
        });
      }

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initDashboard);
      } else {
        initDashboard();
      }
    </script>
  </body>
</html>
