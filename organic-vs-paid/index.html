<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>自然量 vs 买量 · 月度对比</title>

  <!-- Fallback minimalist theme (will be overridden if organic-monthly theme is loaded) -->
  <style>
  :root{
    /* organic-monthly 的浅色体系（兜底：即使没注入样式也好看） */
    --bg-main:#f3f5f9;
    --bg-card:#ffffff;
    --border-subtle:rgba(148, 163, 184, 0.40);
    --text-main:#0f172a;
    --text-sub:#6b7280;
    --shadow-soft:0 18px 45px rgba(15, 23, 42, 0.10);
    --radius-lg:18px;
    --radius-md:12px;

    /* 兼容你现在各模块用的变量名（最关键：把白字改成黑字） */
    --bg: var(--bg-main);
    --card: rgba(255,255,255,0.97);
    --text: var(--text-main);
    --muted: var(--text-sub);
    --border: rgba(148, 163, 184, 0.60);
    --shadow: 0 18px 40px rgba(15, 23, 42, 0.08);
    --radius: var(--radius-lg);
    --container: 1400px;

    /* 图表配色（模块1在用） */
    --ovp-yellow:#F6C344;
    --ovp-blue:#2563eb;
  }

  *{ box-sizing:border-box; }
  html,body{ height:100%; }

  body{
    margin:0;
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang SC","Microsoft YaHei",Arial,sans-serif;
    background: radial-gradient(circle at 0 0, #f9fbff 0, #edf1f9 45%, #e5ebf7 100%);
    color: var(--text);
    -webkit-font-smoothing: antialiased;
  }

  a{ color:inherit; text-decoration:none; }
  a:hover{ text-decoration:underline; }

  /* 页面内容区：对齐 organic-monthly 的宽度/留白 */
  .ovp-shell{
    max-width: var(--container);
    margin: 0 auto;
    padding: 0 24px 22px;
  }

  .ovp-page-title{
    display:flex;
    align-items:flex-end;
    justify-content:space-between;
    gap:12px;
    margin: 0 0 12px;
  }
  .ovp-page-title h1{
    margin:0;
    font-size:18px;
    letter-spacing:.2px;
    color:var(--text);
  }
  .ovp-page-title .ovp-meta{
    font-size:11px;
    color:var(--muted);
  }
  .ovp-note{
    margin:0 0 18px;
    color:var(--muted);
    font-size:11px;
    line-height:1.55;
  }

  /* 模块布局：改成单列卡片（更像 organic-monthly） */
  .ovp-grid{
    display:grid;
    grid-template-columns: minmax(0, 1fr);
    gap: 22px;
    align-items:flex-start;
  }

  /* 卡片：白底 + 细边框 + 柔阴影 */
  .ovp-card{
    background: var(--card);
    border: 1px solid rgba(148, 163, 184, 0.60);
    box-shadow: 0 18px 40px rgba(15, 23, 42, 0.08);
    border-radius: var(--radius);
    overflow:hidden;
  }
  .ovp-card-head{
    padding: 18px 18px 0;
    border-bottom:none;
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap:12px;
  }
  .ovp-card-title{ font-size:14px; margin:0; color:var(--text); }
  .ovp-card-sub{ font-size:11px; color:var(--muted); margin:4px 0 0; line-height:1.45; }
  .ovp-card-body{ padding: 12px 18px 16px; }

  .ovp-placeholder{
    border:1px dashed rgba(148, 163, 184, 0.60);
    border-radius:12px;
    padding:14px;
    color:var(--muted);
    line-height:1.55;
    background: rgba(249, 250, 251, 0.90);
  }
  .ovp-skeleton{
    margin-top:10px;
    height:180px;
    border-radius:10px;
    background: linear-gradient(90deg,
      rgba(148, 163, 184, 0.12),
      rgba(148, 163, 184, 0.22),
      rgba(148, 163, 184, 0.12)
    );
  }
  .ovp-alert{
    padding:10px 12px;
    border:1px solid rgba(148, 163, 184, 0.60);
    border-radius:12px;
    background: rgba(249, 250, 251, 0.90);
    color: var(--muted);
    font-size:11px;
    line-height:1.5;
  }

      /* 右侧悬浮模块导航（悬停展开 + 点击滚动到模块居中） */
  .ovp-float-nav{
    position:fixed;
    right:16px;
    top:50%;
    transform:translateY(-50%);
    z-index:999;
  }
  .ovp-float-nav-handle{
    width:46px;
    height:46px;
    border-radius:14px;
    border:1px solid rgba(148,163,184,.60);
    background:rgba(255,255,255,.92);
    box-shadow:0 18px 40px rgba(15,23,42,.08);
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:12px;
    font-weight:600;
    color:var(--text, #0f172a);
    user-select:none;
  }
  .ovp-float-nav-panel{
    position:absolute;
    right:56px;
    top:50%;
    transform:translateY(-50%) scale(.98);
    opacity:0;
    pointer-events:none;
    transition:opacity .16s ease, transform .16s ease;
    min-width:220px;
    max-height:70vh;
    overflow:auto;
    padding:10px;
    border-radius:14px;
    border:1px solid rgba(148,163,184,.60);
    background:rgba(255,255,255,.95);
    box-shadow:0 18px 40px rgba(15,23,42,.10);
  }
  .ovp-float-nav:hover .ovp-float-nav-panel{
    opacity:1;
    pointer-events:auto;
    transform:translateY(-50%) scale(1);
  }
  .ovp-float-nav-item{
    width:100%;
    display:block;
    text-align:left;
    padding:8px 10px;
    border-radius:10px;
    border:1px solid transparent;
    background:transparent;
    color:var(--text, #0f172a);
    font-size:12px;
    cursor:pointer;
  }
  .ovp-float-nav-item:hover{
    background:rgba(37,99,235,.10);
    border-color:rgba(37,99,235,.22);
  }

  /* 点击跳转后，模块卡片轻微高亮一下 */
  .ovp-card-focus{
    outline:2px solid rgba(37,99,235,.35);
    outline-offset:2px;
  }

  @media (max-width: 640px){
    .ovp-float-nav{
      top:auto;
      bottom:16px;
      transform:none;
    }
    .ovp-float-nav-panel{
      top:auto;
      bottom:56px;
      right:0;
      transform:scale(.98);
    }
    .ovp-float-nav:hover .ovp-float-nav-panel{
      transform:scale(1);
    }
  }

</style>

</head>

<body>

  <!-- 返回目录按钮（固定顶部左侧） -->
<style>
  .back-to-index {
    position: fixed;
    top: 16px;
    left: 16px;
    z-index: 9999;
    background: rgba(255,255,255,0.92);
    border: 1px solid rgba(148,163,184,.45);
    padding: 8px 14px;
    border-radius: 12px;
    font-size: 12px;
    color: #0f172a;
    box-shadow: 0 6px 20px rgba(0,0,0,.06);
    backdrop-filter: blur(6px);
    cursor: pointer;
    text-decoration: none;
  }
  .back-to-index:hover{
    background: rgba(255,255,255,1);
    border-color: rgba(37,99,235,.45);
  }
</style>

<a class="back-to-index" href="../index.html">← 返回目录</a>

  <!-- Will be replaced by organic-monthly header if available -->
  <div id="header-slot"></div>

  <div class="ovp-shell">
    <div class="ovp-page-title">
      <h1>自然量 vs 买量 · 月度对比看板</h1>
      <div class="ovp-meta" id="ovp-meta">数据加载中…</div>
    </div>

    <p class="ovp-note">
      指标模块：1 注册量对比；2 D0/D7 付费率；3 D0/D7 ARPPU；
      4 D0/D7 人均流水（体育/游戏/总）；5 体育 vs 游戏玩家比例；6 次日/7日留存率。
    </p>

    <div id="ovp-data-status" class="ovp-alert" style="display:none;"></div>

    <div id="modules-grid" class="ovp-grid"></div>
  </div>

  <!-- Will be replaced by organic-monthly footer if available -->
  <div id="footer-slot"></div>

  <script>
    // Namespace + registry
    window.OVP = window.OVP || {};
    OVP.modules = OVP.modules || [];
    OVP.registerModule = function registerModule(mod) {
      if (!mod || !mod.id) return;
      OVP.modules.push(mod);
    };

    OVP.utils = {
      safeNumber(v){ const n = Number(v); return Number.isFinite(n) ? n : null; },
      fmtInt(v){ const n = this.safeNumber(v); return n===null ? '—' : n.toLocaleString('en-US'); },
      fmtPct(v, digits=2){ const n = this.safeNumber(v); return n===null ? '—' : `${(n*100).toFixed(digits)}%`; },
      fmtMoney(v, currency='USD', digits=0){
        const n = this.safeNumber(v);
        if (n===null) return '—';
        try{
          return new Intl.NumberFormat('en-US',{style:'currency',currency,maximumFractionDigits:digits}).format(n);
        }catch(_){
          return `${n.toLocaleString('en-US',{maximumFractionDigits:digits})} ${currency}`;
        }
      }
    };

    // Inherit theme/header/footer from organic-monthly at runtime (GitHub Pages friendly)
    (async function inheritOrganicMonthlyTheme(){
      const target = '../organic-monthly/index.html';
      try{
        const res = await fetch(target, { cache:'no-store' });
        if(!res.ok) return;

        const html = await res.text();
        const doc = new DOMParser().parseFromString(html, 'text/html');
        const base = new URL('../organic-monthly/', location.href);
        const isAbs = (u)=>/^(https?:|data:|blob:|mailto:|tel:|\/)/i.test(u);

        const rewriteCssUrls = (cssText)=>cssText.replace(/url\(\s*(['"]?)([^'")]+)\1\s*\)/g,(m,q,url)=>{
          const raw = (url||'').trim();
          if(!raw || raw.startsWith('#') || isAbs(raw)) return m;
          return `url(${q}${new URL(raw, base).href}${q})`;
        });

        // Copy external style links
        for (const link of doc.querySelectorAll('link[rel="stylesheet"]')){
          const href = link.getAttribute('href');
          if(!href) continue;
          const cloned = document.createElement('link');
          cloned.rel = 'stylesheet';
          cloned.href = isAbs(href) ? href : new URL(href, base).href;
          cloned.setAttribute('data-inherited-from','organic-monthly');
          document.head.appendChild(cloned);
        }

        // Copy inline styles
        const styles = [...doc.querySelectorAll('style')].map(s=>s.textContent||'').join('\n\n');
        if(styles.trim()){
          const styleEl = document.createElement('style');
          styleEl.setAttribute('data-inherited-from','organic-monthly');
          styleEl.textContent = rewriteCssUrls(styles);
          document.head.appendChild(styleEl);
        }

        // Fix relative src/href in injected header/footer
        const fixRelativeAttrs = (root)=>{
          for (const el of root.querySelectorAll('[src],[href],[poster]')){
            for (const attr of ['src','href','poster']){
              const val = el.getAttribute(attr);
              if(!val || val.startsWith('#') || isAbs(val)) continue;
              el.setAttribute(attr, new URL(val, base).href);
            }
          }
        };

        const header = doc.querySelector('header');
        if(header){
          const injected = header.cloneNode(true);
          fixRelativeAttrs(injected);
          const slot = document.getElementById('header-slot');
          slot.innerHTML = '';
          slot.appendChild(injected);
        }

        const footer = doc.querySelector('footer');
        if(footer){
          const injected = footer.cloneNode(true);
          fixRelativeAttrs(injected);
          const slot = document.getElementById('footer-slot');
          slot.innerHTML = '';
          slot.appendChild(injected);
        }
      }catch(_e){
        // keep fallback theme silently
      }
    })();
  </script>

   <!-- Chart library (ECharts) : load BEFORE modules render -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.5.0/echarts.min.js"></script>
  <script>
    // fallback if cdnjs is blocked/unavailable
    if (!window.echarts) {
      document.write('<script src="https://unpkg.com/echarts@5.5.0/dist/echarts.min.js"><\/script>');
    }
  </script>

  <!-- Data sources (you already prepared) -->
  
  <script src="./organic-data.js"></script>
  <script src="./paid-data.js"></script>

  <!-- Module placeholders -->
  <script src="./module-registration-compare.js"></script>
  <script src="./module-payrate.js"></script>
  <script src="./module-arppu.js"></script>
  <script src="./module-betflow-percapita.js"></script>
  <script src="./module-player-mix.js"></script>
  <script src="./module-retention.js"></script>
<script src="./insights-copy.js"></script>
  <script>
    (function initDashboard(){
      const statusEl = document.getElementById('ovp-data-status');
      const metaEl = document.getElementById('ovp-meta');
      const grid = document.getElementById('modules-grid');

      function readGlobal(name){
        // Works for global var/let/const in non-module scripts
        try{
          return Function(`return (typeof ${name} !== "undefined") ? ${name} : undefined;`)();
        }catch(_){
          return undefined;
        }
      }

      function resolveData(which){
        const candidates = which === 'organic'
          ? ['organicData','organic_data','ORGANIC_DATA','organicMonthlyData','ORGANIC_MONTHLY_DATA']
          : ['paidData','paid_data','PAID_DATA','paidMonthlyData','PAID_MONTHLY_DATA'];

        for(const key of candidates){
          const v = readGlobal(key);
          if(v !== undefined) return v;
        }
        return undefined;
      }

      const organic = resolveData('organic');
      const paid = resolveData('paid');

      const problems = [];
      if (organic === undefined) problems.push('未检测到自然量数据（organic-data.js 需暴露一个全局变量，如 organicData / organicMonthlyData / ORGANIC_DATA）');
      if (paid === undefined) problems.push('未检测到买量数据（paid-data.js 需暴露一个全局变量，如 paidData / paidMonthlyData / PAID_DATA）');

      if (problems.length){
        statusEl.style.display = '';
        statusEl.textContent = problems.join('；');
        metaEl.textContent = '数据未就绪';
      } else {
        metaEl.textContent = '数据已就绪 · 载入：自然量 + 买量（月度）';
      }

      const modules = Array.isArray(OVP.modules) ? OVP.modules : [];
      if (!modules.length){
        const empty = document.createElement('div');
        empty.className = 'ovp-alert';
        empty.textContent = '模块未注册：请检查 6 个 module-*.js 是否正常加载。';
        grid.appendChild(empty);
        return;
      }

            const ctxBase = { organic, paid, utils: OVP.utils };
      const spanOf = (m)=> (m && (m.span==='full' || m.span==='half')) ? m.span : 'half';

      function setupFloatingNav(modules){
        // 防重复：刷新/热更新时先移除旧的
        const old = document.getElementById('ovp-float-nav');
        if (old && old.parentNode) old.parentNode.removeChild(old);

        const nav = document.createElement('div');
        nav.id = 'ovp-float-nav';
        nav.className = 'ovp-float-nav';
        nav.innerHTML = `
          <div class="ovp-float-nav-handle" title="模块导航">模块快速导航</div>
          <div class="ovp-float-nav-panel" role="menu" aria-label="模块导航列表"></div>
        `;

        const panel = nav.querySelector('.ovp-float-nav-panel');
        for (const m of modules){
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'ovp-float-nav-item';
          btn.textContent = m.title || m.id || '';
          btn.addEventListener('click', function (e) {
            e.preventDefault();
            e.stopPropagation();
            scrollToCardCentered('card-' + m.id);
          });
          panel.appendChild(btn);
        }

        document.body.appendChild(nav);
      }

      function scrollToCardCentered(cardId){
        const el = document.getElementById(cardId);
        if (!el) return;

        const rect = el.getBoundingClientRect();
        const currentY = window.pageYOffset || document.documentElement.scrollTop || 0;
        const top = rect.top + currentY;
        const target = top + rect.height / 2 - window.innerHeight / 2;

        window.scrollTo({ top: Math.max(0, target), behavior: 'smooth' });

        // 轻微高亮一下，方便肉眼定位
        el.classList.add('ovp-card-focus');
        clearTimeout(scrollToCardCentered._t);
        scrollToCardCentered._t = setTimeout(function () {
          el.classList.remove('ovp-card-focus');
        }, 900);
      }

      for (const m of modules){
        const card = document.createElement('section');
        card.className = `ovp-card ${spanOf(m)}`;
        card.id = `card-${m.id}`;

        const head = document.createElement('div');
        head.className = 'ovp-card-head';
        head.innerHTML = `
          <div>
            <h2 class="ovp-card-title">${m.title || m.id}</h2>
            <div class="ovp-card-sub">${m.subtitle || '模块占位：下一步接入图表与计算逻辑'}</div>
          </div>
        `;

        const body = document.createElement('div');
        body.className = 'ovp-card-body';
        const mount = document.createElement('div');
        mount.id = `mount-${m.id}`;
        body.appendChild(mount);

        card.appendChild(head);
        card.appendChild(body);
        grid.appendChild(card);

        try{
          if (typeof m.render === 'function'){
            m.render({ mountEl: mount, ...ctxBase });
          } else {
            mount.innerHTML = `
              <div class="ovp-placeholder">
                <div>本模块未提供 render()。</div>
                <div class="ovp-skeleton"></div>
              </div>
            `;
          }
        }catch(e){
          mount.innerHTML = `
            <div class="ovp-placeholder">
              <div>模块渲染出错：${(e && e.message) ? e.message : 'unknown error'}</div>
            </div>
          `;
        }
      }

      setupFloatingNav(modules);
    })();

   

  </script>
</body>
</html>

