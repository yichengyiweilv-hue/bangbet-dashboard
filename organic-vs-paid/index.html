<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>Bangbet 自然量&买量月度数据对比</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="Bangbet 海外自然量&买量月度数据对比看板" />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --bg-main: #f3f5f9;
        --bg-card: #ffffff;
        --border-subtle: rgba(148, 163, 184, 0.4);

        --accent: #2563eb;
        --accent-soft: #e0edff;
        --accent-strong: #1d4ed8;

        --text-main: #0f172a;
        --text-sub: #6b7280;

        --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.1);

        --radius-lg: 18px;
        --radius-md: 12px;
        --radius-sm: 10px;
        --radius-pill: 999px;

        --transition-fast: 0.18s ease-out;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica,
          Arial, "Apple Color Emoji", "Segoe UI Emoji";
        background: radial-gradient(
          circle at 0 0,
          #f9fbff 0,
          #eff6ff 25%,
          #f3f5f9 55%,
          #eef2ff 100%
        );
        color: var(--text-main);
      }

      .page {
        max-width: 1220px;
        margin: 0 auto;
        padding: 18px 16px 26px;
      }

      .top-bar {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 14px;
        padding: 12px 14px;
        border-radius: 18px;
        background: rgba(255, 255, 255, 0.82);
        border: 1px solid rgba(148, 163, 184, 0.35);
        box-shadow: 0 12px 30px rgba(15, 23, 42, 0.06);
        backdrop-filter: blur(10px);
      }

      .top-left {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .brand-mark {
        width: 34px;
        height: 34px;
        border-radius: 12px;
        background: radial-gradient(
            circle at 30% 30%,
            rgba(37, 99, 235, 0.95),
            rgba(29, 78, 216, 0.95)
          ),
          linear-gradient(135deg, rgba(37, 99, 235, 0.2), rgba(34, 197, 94, 0.2));
        border: 1px solid rgba(37, 99, 235, 0.25);
        box-shadow: 0 14px 32px rgba(37, 99, 235, 0.18);
        position: relative;
        overflow: hidden;
      }

      .brand-mark-inner {
        position: absolute;
        inset: 7px;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.92);
        box-shadow: inset 0 0 0 1px rgba(148, 163, 184, 0.25);
      }

      .brand-text-main {
        font-weight: 700;
        font-size: 13px;
        letter-spacing: 0.02em;
      }

      .brand-text-sub {
        font-size: 11px;
        color: var(--text-sub);
        margin-top: 1px;
      }

      .breadcrumb {
        font-size: 11px;
        margin-top: 1px;
        color: var(--text-sub);
      }

      .breadcrumb a {
        color: var(--accent-strong);
        text-decoration: none;
      }

      .breadcrumb a:hover {
        text-decoration: underline;
      }

      .top-right {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 4px;
        font-size: 11px;
        color: var(--text-sub);
      }

      .badge-env {
        padding: 4px 10px;
        border-radius: var(--radius-pill);
        border: 1px solid rgba(148, 163, 184, 0.5);
        background: rgba(255, 255, 255, 0.9);
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .badge-dot {
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: radial-gradient(circle at 30% 30%, #22c55e, #16a34a);
        box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.22);
      }

      .hero {
        margin: 4px auto 20px;
        padding: 18px 20px 16px;
        border-radius: 22px;
        background: radial-gradient(
            circle at 0 0,
            rgba(59, 130, 246, 0.16) 0,
            transparent 50%
          ),
          linear-gradient(
            120deg,
            rgba(255, 255, 255, 0.86),
            rgba(255, 255, 255, 0.62)
          );
        border: 1px solid rgba(148, 163, 184, 0.28);
        box-shadow: 0 16px 38px rgba(15, 23, 42, 0.06);
        display: grid;
        grid-template-columns: 1.3fr 0.7fr;
        gap: 14px;
      }

      .hero-title {
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 700;
        font-size: 16px;
      }

      .hero-title .bar {
        width: 6px;
        height: 18px;
        border-radius: 999px;
        background: linear-gradient(180deg, var(--accent), #60a5fa);
        box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.16);
      }

      .hero-sub {
        margin-top: 8px;
        font-size: 12px;
        color: var(--text-sub);
        line-height: 1.55;
      }

      .hero-tags {
        margin-top: 10px;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .hero-tag {
        font-size: 11px;
        padding: 6px 10px;
        border-radius: var(--radius-pill);
        border: 1px solid rgba(148, 163, 184, 0.35);
        background: rgba(255, 255, 255, 0.75);
        color: rgba(15, 23, 42, 0.85);
      }

      .hero-side {
        display: flex;
        flex-direction: column;
        gap: 8px;
        font-size: 11px;
        color: var(--text-sub);
        line-height: 1.55;
      }

      .hero-pill {
        padding: 10px 12px;
        border-radius: 14px;
        border: 1px solid rgba(191, 219, 254, 0.9);
        background: rgba(239, 246, 255, 0.85);
        color: rgba(29, 78, 216, 0.92);
      }

      .content {
        display: grid;
        gap: 14px;
      }

      .chart-card {
        border-radius: var(--radius-lg);
        background: rgba(255, 255, 255, 0.92);
        border: 1px solid rgba(148, 163, 184, 0.3);
        box-shadow: var(--shadow-soft);
        overflow: hidden;
      }

      .chart-card-header {
        padding: 12px 14px;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 12px;
      }

      .chart-title-block {
        display: flex;
        flex-direction: column;
        gap: 2px;
        max-width: 60%;
      }

      .chart-kicker {
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 0.16em;
        color: var(--text-sub);
      }

      .chart-title {
        font-size: 14px;
        font-weight: 600;
      }

      .chart-sub {
        font-size: 11px;
        color: var(--text-sub);
      }

      .chart-controls {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 6px;
        min-width: 300px;
      }

      .chart-badge {
        font-size: 10px;
        border-radius: var(--radius-pill);
        padding: 3px 7px;
        background: rgba(239, 246, 255, 0.9);
        border: 1px solid rgba(191, 219, 254, 0.9);
        color: var(--accent-strong);
      }

      .chart-mini-filter {
        display: flex;
        gap: 8px;
        align-items: center;
        justify-content: flex-end;
        width: 100%;
        flex-wrap: wrap;
      }

      .chart-mini-label {
        font-size: 11px;
        color: var(--text-sub);
        white-space: nowrap;
      }

      .chart-mini-radio {
        display: inline-flex;
        gap: 10px;
        padding: 5px 8px;
        border-radius: var(--radius-pill);
        border: 1px solid rgba(148, 163, 184, 0.35);
        background: rgba(255, 255, 255, 0.78);
        font-size: 11px;
        color: var(--text-main);
      }

      .chart-mini-radio label {
        display: inline-flex;
        gap: 6px;
        align-items: center;
        cursor: pointer;
      }

      .chart-mini-radio input {
        accent-color: var(--accent);
      }

      .chart-mini-chips {
        display: inline-flex;
        flex-wrap: wrap;
        gap: 6px;
        justify-content: flex-end;
        max-width: 520px;
      }

      .filter-chip {
        display: inline-flex;
        align-items: center;
        cursor: pointer;
        user-select: none;
      }

      .filter-chip input {
        display: none;
      }

      .filter-chip span {
        font-size: 11px;
        padding: 5px 10px;
        border-radius: var(--radius-pill);
        border: 1px solid rgba(148, 163, 184, 0.35);
        background: rgba(255, 255, 255, 0.72);
        color: rgba(15, 23, 42, 0.86);
        transition: transform var(--transition-fast),
          background var(--transition-fast);
      }

      .filter-chip input:checked + span {
        border-color: rgba(37, 99, 235, 0.5);
        background: rgba(224, 237, 255, 0.85);
        color: rgba(29, 78, 216, 0.95);
        transform: translateY(-1px);
      }

      .chart-area {
        padding: 10px 14px 2px;
      }

      .chart {
        width: 100%;
        height: 360px;
      }

      .chart-table-section {
        padding: 8px 14px 10px;
      }

      .chart-table-title {
        font-size: 12px;
        font-weight: 600;
        margin-bottom: 8px;
      }

      .chart-table-wrapper {
        overflow: auto;
        border-radius: var(--radius-md);
        border: 1px solid rgba(148, 163, 184, 0.28);
        background: rgba(255, 255, 255, 0.85);
      }

      table.chart-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
      }

      table.chart-table thead th {
        text-align: left;
        padding: 10px 10px;
        background: rgba(241, 245, 249, 0.9);
        color: rgba(15, 23, 42, 0.8);
        border-bottom: 1px solid rgba(148, 163, 184, 0.25);
        white-space: nowrap;
      }

      table.chart-table td {
        padding: 10px 10px;
        border-bottom: 1px solid rgba(148, 163, 184, 0.18);
        white-space: nowrap;
      }

      table.chart-table td.num,
      table.chart-table th.num {
        text-align: right;
        font-variant-numeric: tabular-nums;
      }

      .chart-summary {
        padding: 10px 14px 14px;
      }

      .chart-analysis-box {
        border-radius: var(--radius-md);
        border: 1px solid rgba(148, 163, 184, 0.28);
        background: rgba(255, 255, 255, 0.78);
        display: flex;
        gap: 12px;
        padding: 12px;
        align-items: stretch;
      }

      .chart-analysis-months {
        min-width: 120px;
        max-width: 140px;
        border-right: 1px dashed rgba(148, 163, 184, 0.3);
        padding-right: 12px;
      }

      .chart-analysis-months-title {
        font-size: 11px;
        color: var(--text-sub);
        margin-bottom: 8px;
      }

      .chart-analysis-month-btn {
        width: 100%;
        padding: 7px 10px;
        border-radius: var(--radius-sm);
        border: 1px solid rgba(148, 163, 184, 0.35);
        background: rgba(255, 255, 255, 0.85);
        font-size: 11px;
        color: rgba(15, 23, 42, 0.85);
        cursor: default;
      }

      .chart-analysis-body {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .chart-analysis-title {
        font-size: 12px;
        font-weight: 600;
      }

      .chart-analysis-text {
        font-size: 12px;
        color: rgba(15, 23, 42, 0.76);
        line-height: 1.65;
        white-space: pre-line;
      }

      .chart-card.is-placeholder {
        opacity: 0.9;
      }

      .placeholder-body {
        padding: 14px;
        color: var(--text-sub);
        font-size: 12px;
        line-height: 1.6;
      }

      .footer {
        margin-top: 14px;
        padding: 10px 12px;
        border-radius: var(--radius-md);
        background: rgba(255, 255, 255, 0.82);
        border: 1px solid rgba(148, 163, 184, 0.28);
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: space-between;
        color: var(--text-sub);
        font-size: 11px;
      }

      @media (max-width: 980px) {
        .hero {
          grid-template-columns: 1fr;
        }
        .chart-card-header {
          flex-direction: column;
          align-items: flex-start;
        }
        .chart-title-block {
          max-width: 100%;
        }
        .chart-controls {
          min-width: auto;
          align-items: flex-start;
          width: 100%;
        }
        .chart-mini-chips {
          max-width: 100%;
          justify-content: flex-start;
        }
      }
    </style>
  </head>

  <body>
    <div class="page">
      <!-- 页眉（按旧看板保持一致） -->
      <header class="top-bar">
        <div class="top-left">
          <div class="brand-mark" aria-hidden="true">
            <div class="brand-mark-inner"></div>
          </div>
          <div>
            <div class="brand-text-main">Bangbet Growth Console</div>
            <div class="brand-text-sub">Organic · Monthly Comparison</div>
            <div class="breadcrumb">
              <a href="./index.html">首页目录</a> / 自然量月度数据对比
            </div>
          </div>
        </div>

        <div class="top-right">
          <div class="badge-env">
            <span class="badge-dot"></span>
            <span>Prod · Light · 自然渠道</span>
          </div>
          <div>单位：人数 / % / USD 等值 · 周期：按月 + 按日</div>
        </div>
      </header>

      <!-- Hero -->
      <section class="hero">
        <div class="hero-main">
          <div class="hero-title">
            <span class="bar"></span>
            <span>自然量&买量月度数据对比 · 看板</span>
          </div>
          <div class="hero-sub">
            模块化对比自然量与买量：先做注册量（按月/按日），后续模块按同一套筛选器与版式接入。
          </div>
          <div class="hero-tags">
            <span class="hero-tag">模块1：注册量（自然 vs 买量）</span>
            <span class="hero-tag">数据源：RAW_ORGANIC_BY_MONTH + RAW_PAID_BY_MONTH</span>
            <span class="hero-tag">日折线：</span>
          </div>
        </div>

        <div class="hero-side">
          <div>当前版本：v0.1 · 本页仅完成模块1。</div>
          <div>每月新增数据：在 organic-data.js / paid-data.js 各自新增一个月份数组。</div>
          <div class="hero-pill">
            提示：月筛选单选，国家可多选；（自然/买量）。
          </div>
        </div>
      </section>

      <main class="content">
        <!-- 1. 自然量 vs 买量注册量 -->
        <section class="chart-card" id="card-regcomp">
          <header class="chart-card-header">
            <div class="chart-title-block">
              <div class="chart-kicker">Scale</div>
              <div class="chart-title">自然量 vs 买量注册量 · 月度 / 日度</div>
              <div class="chart-sub">
                月度视图：按国家对比当月自然/买量注册量（橙/蓝）。日度视图：展示所选国家汇总的每日自然/买量两条折线。
              </div>
            </div>

            <div class="chart-controls">
              <span class="chart-badge">单位：人（注册）</span>

              <div class="chart-mini-filter">
                <span class="chart-mini-label">视图：</span>
                <div class="chart-mini-radio">
                  <label>
                    <input type="radio" name="regcomp-view" value="bar" checked />
                    柱状（月度）
                  </label>
                  <label>
                    <input type="radio" name="regcomp-view" value="line" />
                    折线（日度）
                  </label>
                </div>
              </div>

              <div class="chart-mini-filter">
                <span class="chart-mini-label">月份：</span>
                <div class="chart-mini-chips" id="regcomp-months"></div>
              </div>

              <div class="chart-mini-filter">
                <span class="chart-mini-label">国家：</span>
                <div class="chart-mini-chips" id="regcomp-countries"></div>
              </div>
            </div>
          </header>

          <div class="chart-area">
            <div class="chart" id="chart-regcomp"></div>
          </div>

          <div class="chart-table-section">
            <div class="chart-table-title">当月汇总（跟随筛选器）</div>
            <div class="chart-table-wrapper">
              <table class="chart-table" id="table-regcomp"></table>
            </div>
          </div>

          <!-- 数据分析文案（按月份筛选器联动） -->
          <div class="chart-summary">
            <div class="chart-analysis-box">
              <div class="chart-analysis-months">
                <div class="chart-analysis-months-title">当前月份</div>
                <div class="chart-analysis-month-btn" id="analysis-regcomp-month">-</div>
              </div>
              <div class="chart-analysis-body">
                <div class="chart-analysis-title">数据分析</div>
                <div class="chart-analysis-text" id="analysis-regcomp-text">
                  暂未填写该月份文案。
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- 预留：后续模块位置（先别写逻辑） -->
        <section class="chart-card is-placeholder" id="card-placeholder-2">
          <header class="chart-card-header">
            <div class="chart-title-block">
              <div class="chart-kicker">Reserved</div>
              <div class="chart-title">模块2（预留）</div>
              <div class="chart-sub">后续接入：FTD、Spend、ROAS D0/D7/D30、GGR、留存等。</div>
            </div>
          </header>
          <div class="placeholder-body">
            先占位不接逻辑，避免现在把结构写死。等你给模块2口径和展示交互，再按同一套风格往下加。
          </div>
        </section>
      </main>

      <!-- 页脚（按旧看板保持一致） -->
      <footer class="footer">
        <span>Owner：<strong>用户增长部-Jerry Lyu</strong> · 自然量看板 v3.1（从 RAW_ORGANIC_BY_MONTH 聚合）</span>
        <span>数据来源：内部自然量报表 · 时间口径建议统一为 UTC+0 日切。</span>
      </footer>
    </div>

    <!-- ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>

    <!-- 数据源（同级） -->
    <script src="./organic-data.js"></script>
    <script src="./paid-data.js"></script>

    <!-- 文案文件（同级，新增） -->
    <script src="./analysis-reg-vs-paid.js"></script>

    <script>
      "use strict";

      // ============
      // 配色（按需求：自然橙、买量蓝）
      // ============
      const COLOR_ORGANIC = "#f97316";
      const COLOR_PAID = "#2563eb";

      // ============
      // 工具函数
      // ============
      function formatMonthShort(month) {
        if (!month) return "";
        const parts = String(month).split("-");
        if (parts.length === 2) {
          const m = parseInt(parts[1], 10);
          if (!Number.isNaN(m)) return m + "月";
        }
        return String(month);
      }

      function formatInteger(v) {
        if (v == null || !isFinite(v)) return "-";
        return Math.round(Number(v)).toLocaleString();
      }

      function formatPercent(v) {
        if (v == null || !isFinite(v)) return "-";
        return Number(v).toFixed(1) + "%";
      }

      function safeDivide(num, denom) {
        const n = Number(num);
        const d = Number(denom);
        if (!Number.isFinite(n) || !Number.isFinite(d) || d <= 0) return 0;
        return n / d;
      }

      function uniqSorted(arr) {
        return Array.from(new Set(arr)).sort();
      }

      function renderEmptyTable(tableEl, msg) {
        if (!tableEl) return;
        tableEl.innerHTML =
          "<tbody><tr><td>" +
          (msg || "无数据：请先在上方选择国家和月份") +
          "</td></tr></tbody>";
      }

      function renderEmptyChart(chart, msg) {
        chart.clear();
        chart.setOption(
          {
            graphic: [
              {
                type: "text",
                left: "center",
                top: "middle",
                style: {
                  text: msg || "暂无数据",
                  fill: "rgba(15,23,42,0.55)",
                  font: "12px Inter, system-ui, -apple-system, Segoe UI, Roboto",
                },
              },
            ],
          },
          true
        );
      }

      // ============
      // 数据索引（尽量薄：先只聚合 registration，后续模块再扩展）
      // ============
      function buildDatasetIndex(rawByMonth) {
        const months = Object.keys(rawByMonth || {}).sort();
        const aggMonth = {}; // month -> country -> { registration }
        const aggDay = {}; // month -> date -> country -> { registration }

        months.forEach((month) => {
          const rows = rawByMonth[month] || [];
          aggMonth[month] = {};
          aggDay[month] = {};

          rows.forEach((row) => {
            if (!row) return;
            const country = row.country;
            const date = row.date;
            if (!country || !date) return;

            const reg = Number(row.registration || 0);

            if (!aggMonth[month][country]) aggMonth[month][country] = { registration: 0 };
            aggMonth[month][country].registration += reg;

            if (!aggDay[month][date]) aggDay[month][date] = {};
            if (!aggDay[month][date][country]) aggDay[month][date][country] = { registration: 0 };
            aggDay[month][date][country].registration += reg;
          });
        });

        return { months, aggMonth, aggDay };
      }

      function getCountriesForMonth(orgIndex, paidIndex, month) {
        const a = Object.keys((orgIndex.aggMonth && orgIndex.aggMonth[month]) || {});
        const b = Object.keys((paidIndex.aggMonth && paidIndex.aggMonth[month]) || {});
        return uniqSorted(a.concat(b));
      }

      function getAllMonths(orgIndex, paidIndex) {
        return uniqSorted((orgIndex.months || []).concat(paidIndex.months || []));
      }

      // ============
      // Chips
      // ============
      function createSingleSelectChips(containerId, values, selectedValue, getLabel, onChange) {
        const el = document.getElementById(containerId);
        if (!el) return;

        el.innerHTML = "";
        const groupName = "chip-single-" + containerId;

        values.forEach((val) => {
          const label = document.createElement("label");
          label.className = "filter-chip";

          const input = document.createElement("input");
          input.type = "radio";
          input.name = groupName;
          input.value = val;
          input.checked = val === selectedValue;

          const span = document.createElement("span");
          span.textContent = getLabel ? getLabel(val) : String(val);

          input.addEventListener("change", () => {
            if (input.checked) onChange && onChange(val);
          });

          label.appendChild(input);
          label.appendChild(span);
          el.appendChild(label);
        });
      }

      function createMultiSelectChips(containerId, values, selectedValues, getLabel, onChange) {
        const el = document.getElementById(containerId);
        if (!el) return;

        el.innerHTML = "";
        const selectedSet = new Set(selectedValues || []);

        values.forEach((val) => {
          const label = document.createElement("label");
          label.className = "filter-chip";

          const input = document.createElement("input");
          input.type = "checkbox";
          input.value = val;
          input.checked = selectedSet.has(val);

          const span = document.createElement("span");
          span.textContent = getLabel ? getLabel(val) : String(val);

          input.addEventListener("change", () => {
            // 至少保留 1 个国家；如果取消到空，就回滚
            const next = new Set(selectedSet);
            if (input.checked) next.add(val);
            else next.delete(val);

            if (next.size === 0) {
              input.checked = true;
              return;
            }

            selectedSet.clear();
            next.forEach((x) => selectedSet.add(x));
            onChange && onChange(Array.from(selectedSet));
          });

          label.appendChild(input);
          label.appendChild(span);
          el.appendChild(label);
        });
      }

      // ============
      // 文案：按月份联动（analysis-reg-vs-paid.js 提供）
      // ============
      function getAnalysisText(key, month) {
        const root = window.DASHBOARD_ANALYSIS_TEXT || {};
        const byKey = root[key] || {};
        const s = byKey[month];
        return s && String(s).trim() ? String(s) : "暂未填写该月份文案。";
      }

      function updateAnalysisUI(month) {
        const monthEl = document.getElementById("analysis-regcomp-month");
        const textEl = document.getElementById("analysis-regcomp-text");
        if (monthEl) monthEl.textContent = month || "-";
        if (textEl) textEl.textContent = getAnalysisText("reg_vs_paid_registration", month);
      }

      // ============
      // 模块1：图 + 表
      // ============
      function calcMonthlyTotals(index, month, countries) {
        const byCountry = (index.aggMonth && index.aggMonth[month]) || {};
        let sum = 0;
        countries.forEach((c) => {
          sum += Number((byCountry[c] && byCountry[c].registration) || 0);
        });
        return sum;
      }

      function calcDailySeries(index, month, countries) {
        const byDate = (index.aggDay && index.aggDay[month]) || {};
        const dates = Object.keys(byDate || {}).sort();
        const data = dates.map((d) => {
          const byCountry = byDate[d] || {};
          let sum = 0;
          countries.forEach((c) => {
            sum += Number((byCountry[c] && byCountry[c].registration) || 0);
          });
          return sum;
        });
        return { dates, data };
      }

      function unionDates(orgIndex, paidIndex, month) {
        const a = Object.keys(((orgIndex.aggDay || {})[month]) || {});
        const b = Object.keys(((paidIndex.aggDay || {})[month]) || {});
        return uniqSorted(a.concat(b));
      }

      function updateRegCompTable(month, countries, orgIndex, paidIndex) {
  var table = document.getElementById("table-regcomp");
  if (!table) return;

  if (!month || !countries || !countries.length) {
    renderEmptyTable(table);
    return;
  }

  var orgByCountry = (orgIndex.aggMonth && orgIndex.aggMonth[month]) ? orgIndex.aggMonth[month] : {};
  var paidByCountry = (paidIndex.aggMonth && paidIndex.aggMonth[month]) ? paidIndex.aggMonth[month] : {};

  var rowsHtml = countries
    .map(function (c) {
      var organicReg = Number((orgByCountry[c] && orgByCountry[c].registration) || 0);
      var paidReg = Number((paidByCountry[c] && paidByCountry[c].registration) || 0);
      var totalReg = organicReg + paidReg;

      var organicShare = safeDivide(organicReg, totalReg) * 100;
      var paidShare = safeDivide(paidReg, totalReg) * 100;

      return (
        "<tr>" +
          "<td>" + c + "</td>" +
          '<td class="num">' + formatPercent(organicShare) + "</td>" +
          '<td class="num">' + formatPercent(paidShare) + "</td>" +
          '<td class="num">' + formatInteger(organicReg) + "</td>" +
          '<td class="num">' + formatInteger(paidReg) + "</td>" +
          '<td class="num">' + formatInteger(totalReg) + "</td>" +
        "</tr>"
      );
    })
    .join("");

  table.innerHTML =
    "<thead>" +
      "<tr>" +
        "<th>国家</th>" +
        '<th class="num">自然量注册占比 (%)</th>' +
        '<th class="num">买量注册占比 (%)</th>' +
        '<th class="num">自然量注册数</th>' +
        '<th class="num">买量注册数</th>' +
        '<th class="num">总注册数</th>' +
      "</tr>" +
    "</thead>" +
    "<tbody>" +
      rowsHtml +
    "</tbody>";
}


      function updateRegCompChart(chart, view, month, countries, orgIndex, paidIndex) {
        if (!chart) return;

        if (!month || !countries || !countries.length) {
          renderEmptyChart(chart, "无数据：请先选择月份和国家");
          return;
        }

        // table + analysis 先更新，确保一眼就对
        updateRegCompTable(month, countries, orgIndex, paidIndex);
        updateAnalysisUI(month);

        if (view === "line") {
  // 用“全日期”铺底，缺失日期按 0
  var dates = unionDates(orgIndex, paidIndex, month);
  if (!dates.length) {
    renderEmptyChart(chart, "暂无日数据");
    return;
  }

  var orgByDate = (orgIndex.aggDay && orgIndex.aggDay[month]) ? orgIndex.aggDay[month] : {};
  var paidByDate = (paidIndex.aggDay && paidIndex.aggDay[month]) ? paidIndex.aggDay[month] : {};

  // 每个国家两条线：自然量 / 买量
  var lineTypes = ["solid", "dashed", "dotted"];
  var series = [];

  countries.forEach(function (country, idx) {
    var lineType = lineTypes[idx % lineTypes.length];

    var orgData = dates.map(function (d) {
      var m = orgByDate[d] || {};
      return Number((m[country] && m[country].registration) || 0);
    });

    var paidData = dates.map(function (d) {
      var m = paidByDate[d] || {};
      return Number((m[country] && m[country].registration) || 0);
    });

    series.push({
      name: "自然量 · " + country,
      type: "line",
      smooth: true,
      showSymbol: false,
      data: orgData,
      emphasis: { focus: "series" },
      lineStyle: { width: 2, color: COLOR_ORGANIC, type: lineType },
      itemStyle: { color: COLOR_ORGANIC },
    });

    series.push({
      name: "买量 · " + country,
      type: "line",
      smooth: true,
      showSymbol: false,
      data: paidData,
      emphasis: { focus: "series" },
      lineStyle: { width: 2, color: COLOR_PAID, type: lineType },
      itemStyle: { color: COLOR_PAID },
    });
  });

  chart.setOption(
    {
      tooltip: { trigger: "axis", axisPointer: { type: "cross" } },
      legend: { type: "scroll" },
      grid: { left: 40, right: 24, top: 50, bottom: 40, containLabel: true },
      xAxis: {
        type: "category",
        data: dates,
        axisLabel: { formatter: function (v) { return v.slice(8); } },
      },
      yAxis: { type: "value" },
      series: series,
    },
    true
  );
  return;
}


        // bar（月度）：按国家对比（自然/买量两组柱）
        const monthCountries = countries.slice(); // 已筛选
        if (!monthCountries.length) {
          renderEmptyChart(chart, "暂无国家数据");
          return;
        }

        const orgAgg = (orgIndex.aggMonth && orgIndex.aggMonth[month]) || {};
        const paidAgg = (paidIndex.aggMonth && paidIndex.aggMonth[month]) || {};

        // 默认按总注册降序，更符合看规模
        monthCountries.sort((a, b) => {
          const ta = Number((orgAgg[a] && orgAgg[a].registration) || 0) + Number((paidAgg[a] && paidAgg[a].registration) || 0);
          const tb = Number((orgAgg[b] && orgAgg[b].registration) || 0) + Number((paidAgg[b] && paidAgg[b].registration) || 0);
          return tb - ta;
        });

        const orgBars = monthCountries.map((c) => Number((orgAgg[c] && orgAgg[c].registration) || 0));
        const paidBars = monthCountries.map((c) => Number((paidAgg[c] && paidAgg[c].registration) || 0));

        chart.setOption(
          {
            tooltip: { trigger: "axis", axisPointer: { type: "shadow" } },
            legend: { type: "scroll" },
            grid: { left: 40, right: 20, top: 40, bottom: 40 },
            xAxis: { type: "category", data: monthCountries },
            yAxis: {
              type: "value",
              name: "注册数",
              axisLabel: {
                formatter: function (v) {
                  return v >= 1000 ? (v / 1000).toFixed(1) + "k" : v;
                },
              },
            },
            series: [
              {
                name: "自然量",
                type: "bar",
                data: orgBars,
                itemStyle: { color: COLOR_ORGANIC },
                barMaxWidth: 22,
                emphasis: { focus: "series" },
              },
              {
                name: "买量",
                type: "bar",
                data: paidBars,
                itemStyle: { color: COLOR_PAID },
                barMaxWidth: 22,
                emphasis: { focus: "series" },
              },
            ],
          },
          true
        );
      }

      // ============
      // Init
      // ============
      function init() {
        const organicRaw = window.RAW_ORGANIC_BY_MONTH;
        const paidRaw = window.RAW_PAID_BY_MONTH;

        const chartEl = document.getElementById("chart-regcomp");
        const tableEl = document.getElementById("table-regcomp");

        if (!chartEl || !tableEl) return;

        if (!organicRaw || !paidRaw) {
          renderEmptyTable(tableEl, "数据源缺失：请确认 organic-data.js / paid-data.js 已加载并挂到 window");
          const chart = echarts.init(chartEl);
          renderEmptyChart(chart, "数据源缺失：RAW_ORGANIC_BY_MONTH / RAW_PAID_BY_MONTH");
          return;
        }

        const orgIndex = buildDatasetIndex(organicRaw);
        const paidIndex = buildDatasetIndex(paidRaw);

        const allMonths = getAllMonths(orgIndex, paidIndex);
        const defaultMonth = allMonths.length ? allMonths[allMonths.length - 1] : null;

        let view = "bar";
        let month = defaultMonth;
        let countries = month ? getCountriesForMonth(orgIndex, paidIndex, month) : [];

        // chips init
        createSingleSelectChips(
          "regcomp-months",
          allMonths,
          month,
          (m) => formatMonthShort(m),
          (nextMonth) => {
            month = nextMonth;

            const nextCountries = getCountriesForMonth(orgIndex, paidIndex, month);
            // 保留交集，否则全选
            const keep = countries.filter((c) => nextCountries.includes(c));
            countries = keep.length ? keep : nextCountries.slice();

            createMultiSelectChips(
              "regcomp-countries",
              nextCountries,
              countries,
              (c) => c,
              (next) => {
                countries = next.slice();
                updateRegCompChart(chart, view, month, countries, orgIndex, paidIndex);
              }
            );

            updateRegCompChart(chart, view, month, countries, orgIndex, paidIndex);
          }
        );

        if (month) {
          createMultiSelectChips(
            "regcomp-countries",
            countries,
            countries,
            (c) => c,
            (next) => {
              countries = next.slice();
              updateRegCompChart(chart, view, month, countries, orgIndex, paidIndex);
            }
          );
        } else {
          createMultiSelectChips("regcomp-countries", [], [], (c) => c, () => {});
        }

        // chart init
        const chart = echarts.init(chartEl);

        // view toggle
        const viewRadios = document.querySelectorAll('input[name="regcomp-view"]');
        viewRadios.forEach((r) => {
          r.addEventListener("change", () => {
            if (!r.checked) return;
            view = r.value;
            updateRegCompChart(chart, view, month, countries, orgIndex, paidIndex);
          });
        });

        // initial render
        if (!month || !countries.length) {
          renderEmptyTable(tableEl);
          renderEmptyChart(chart, "无数据：请先在数据源里补齐月份/国家");
          updateAnalysisUI(month);
        } else {
          updateRegCompChart(chart, view, month, countries, orgIndex, paidIndex);
        }

        window.addEventListener("resize", () => chart.resize());
      }

      init();
    </script>
  </body>
</html>
