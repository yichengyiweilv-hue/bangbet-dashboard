<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>Bangbet 自然量 vs 买量月度数据对比</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="Bangbet 自然量&买量 月度数据对比看板" />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <style>


      :root {

        --bg-main: #f3f5f9;

        --bg-card: #ffffff;

        --border-subtle: rgba(148, 163, 184, 0.4);

        --accent: #2563eb;

        --accent-soft: #e0edff;

        --accent-strong: #1d4ed8;

        --accent-green: #16a34a;

        --text-main: #0f172a;

        --text-sub: #6b7280;

        --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.1);

        --radius-lg: 18px;

        --radius-md: 12px;

        --radius-pill: 999px;

        --transition-fast: 0.18s ease-out;

      }




      * {

        box-sizing: border-box;

      }




      html,

      body {

        margin: 0;

        padding: 0;

        height: 100%;

        font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont,

          "Segoe UI", sans-serif;

        background: radial-gradient(

          circle at 0 0,

          #f9fbff 0,

          #edf1f9 45%,

          #e5ebf7 100%

        );

        color: var(--text-main);

        -webkit-font-smoothing: antialiased;

      }




      .page {

        min-height: 100vh;

        display: flex;

        flex-direction: column;

      }




      .top-bar {

        padding: 16px 24px 10px;

        display: flex;

        align-items: center;

        justify-content: space-between;

        gap: 10px;

      }




      .top-left {

        display: flex;

        align-items: center;

        gap: 12px;

      }




      .brand-mark {

        width: 34px;

        height: 34px;

        border-radius: 14px;

        background: conic-gradient(

          from 160deg,

          #2563eb,

          #22c55e,

          #38bdf8,

          #2563eb

        );

        position: relative;

        overflow: hidden;

        box-shadow: 0 10px 25px rgba(37, 99, 235, 0.45);

      }




      .brand-mark::after {

        content: "";

        position: absolute;

        inset: 7px;

        border-radius: 10px;

        background: rgba(255, 255, 255, 0.92);

        backdrop-filter: blur(12px);

      }




      .brand-mark-inner {

        position: absolute;

        inset: 10px 11px 10px 9px;

        border-radius: 9px;

        background: linear-gradient(135deg, #2563eb, #22c55e);

        opacity: 0.9;

        clip-path: polygon(0 30%, 60% 0, 100% 40%, 70% 100%, 20% 80%);

      }




      .brand-text-main {

        font-size: 16px;

        font-weight: 600;

        letter-spacing: 0.03em;

      }




      .brand-text-sub {

        font-size: 11px;

        letter-spacing: 0.12em;

        text-transform: uppercase;

        color: var(--text-sub);

      }




      .breadcrumb {

        font-size: 11px;

        color: var(--text-sub);

      }




      .breadcrumb a {

        color: var(--accent-strong);

        text-decoration: none;

      }




      .breadcrumb a:hover {

        text-decoration: underline;

      }




      .top-right {

        display: flex;

        flex-direction: column;

        align-items: flex-end;

        gap: 4px;

        font-size: 11px;

        color: var(--text-sub);

      }




      .badge-env {

        padding: 4px 10px;

        border-radius: var(--radius-pill);

        border: 1px solid rgba(148, 163, 184, 0.5);

        background: rgba(255, 255, 255, 0.9);

        display: inline-flex;

        align-items: center;

        gap: 6px;

      }




      .badge-dot {

        width: 8px;

        height: 8px;

        border-radius: 999px;

        background: radial-gradient(circle at 30% 30%, #22c55e, #16a34a);

        box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.22);

      }




      .hero {

        margin: 4px auto 20px;

        padding: 18px 20px 16px;

        border-radius: 22px;

        background: radial-gradient(

            circle at 0 0,

            rgba(59, 130, 246, 0.16) 0,

            transparent 50%

          ),

          radial-gradient(

            circle at 100% 0,

            rgba(34, 197, 94, 0.15) 0,

            transparent 55%

          ),

          rgba(255, 255, 255, 0.95);

        border: 1px solid rgba(148, 163, 184, 0.45);

        box-shadow: var(--shadow-soft);

        display: flex;

        flex-wrap: wrap;

        justify-content: space-between;

        gap: 16px;

        max-width: 1400px;

      }




      .hero-main {

        max-width: 750px;

      }




      .hero-title {

        font-size: 20px;

        font-weight: 600;

        display: flex;

        align-items: center;

        gap: 8px;

        margin-bottom: 6px;

      }




      .hero-title span.bar {

        width: 3px;

        height: 20px;

        border-radius: 999px;

        background: linear-gradient(180deg, #22c55e, #2563eb);

      }




      .hero-sub {

        font-size: 13px;

        color: var(--text-sub);

        margin-bottom: 10px;

      }




      .hero-tags {

        display: flex;

        flex-wrap: wrap;

        gap: 6px;

      }




      .hero-tag {

        font-size: 11px;

        padding: 4px 9px;

        border-radius: var(--radius-pill);

        background: rgba(15, 23, 42, 0.03);

        border: 1px solid rgba(148, 163, 184, 0.45);

        color: var(--text-sub);

      }




      .hero-side {

        min-width: 240px;

        max-width: 320px;

        font-size: 11px;

        color: var(--text-sub);

        display: flex;

        flex-direction: column;

        gap: 6px;

        align-items: flex-end;

        text-align: right;

      }




      .hero-pill {

        padding: 6px 11px;

        border-radius: var(--radius-pill);

        background: linear-gradient(120deg, var(--accent-strong), #22c55e);

        color: #f9fafb;

        font-size: 11px;

        font-weight: 500;

        box-shadow: 0 10px 30px rgba(37, 99, 235, 0.7);

      }




      .content {

        flex: 1;

        padding: 0 24px 22px;

        max-width: 1400px;

        margin: 0 auto;

        display: grid;

        grid-template-columns: minmax(0, 1fr);

        gap: 22px;

        align-items: flex-start;

      }




      .chart-card {

        border-radius: var(--radius-lg);

        background: rgba(255, 255, 255, 0.97);

        border: 1px solid rgba(148, 163, 184, 0.6);

        box-shadow: 0 18px 40px rgba(15, 23, 42, 0.08);

        padding: 18px 18px 14px;

        display: flex;

        flex-direction: column;

        gap: 12px;

        min-height: 380px;

      }




      .chart-card-header {

        display: flex;

        justify-content: space-between;

        align-items: flex-start;

        gap: 12px;

      }




      .chart-title-block {

        display: flex;

        flex-direction: column;

        gap: 2px;

        max-width: 60%;

      }




      .chart-kicker {

        font-size: 10px;

        text-transform: uppercase;

        letter-spacing: 0.16em;

        color: var(--text-sub);

      }




      .chart-title {

        font-size: 14px;

        font-weight: 600;

      }




      .chart-sub {

        font-size: 11px;

        color: var(--text-sub);

      }




      .chart-badge {

        font-size: 10px;

        border-radius: var(--radius-pill);

        padding: 3px 7px;

        background: rgba(239, 246, 255, 0.9);

        border: 1px solid rgba(191, 219, 254, 0.9);

        color: var(--accent-strong);

      }




      .chart-controls {

        display: flex;

        flex-direction: column;

        align-items: flex-end;

        gap: 6px;

        min-width: 260px;

      }




      .chart-mini-filter {

        display: flex;

        align-items: center;

        gap: 4px;

        flex-wrap: wrap;

        justify-content: flex-end;

      }




      .chart-mini-label {

        font-size: 11px;

        color: var(--text-sub);

      }




      .chart-mini-chips {

        display: flex;

        flex-wrap: wrap;

        justify-content: flex-end;

        gap: 4px;

      }




      .chart-mini-radio {

        font-size: 11px;

        color: var(--text-sub);

        display: inline-flex;

        flex-wrap: wrap;

        gap: 6px;

        justify-content: flex-end;

      }




      .chart-mini-radio label {

        display: inline-flex;

        align-items: center;

        gap: 3px;

        cursor: pointer;

      }




      .chart-mini-radio input {

        accent-color: var(--accent-strong);

        cursor: pointer;

      }




      .chart {

        width: 100%;

        height: 320px;

      }




      .chart-summary {

        font-size: 11px;

        color: var(--text-sub);

        padding-top: 4px;

        border-top: 1px dashed rgba(148, 163, 184, 0.5);

      }




      .chart-summary strong {

        color: var(--text-main);

      }

      /* 图表下方：按月份切换的数据分析块 */

      .chart-analysis-box {

        margin-top: 4px;

        border-radius: var(--radius-md);

        border: 1px solid rgba(209, 213, 219, 0.9);

        background: rgba(249, 250, 251, 0.96);

        display: flex;

        align-items: stretch;

        overflow: hidden;

      }




      .chart-analysis-months {

        flex: 0 0 70px;

        border-right: 1px solid rgba(209, 213, 219, 0.9);

        padding: 6px 4px;

        display: flex;

        flex-direction: column;

        gap: 4px;

        background: rgba(243, 244, 246, 0.95);

      }




      .chart-analysis-months-title {

        font-size: 11px;

        color: var(--text-sub);

        margin-bottom: 2px;

      }




      .chart-analysis-month-btn {

        width: 100%;

        font-size: 11px;

        border-radius: var(--radius-sm);

        border: 1px solid transparent;

        padding: 3px 6px;

        background: transparent;

        color: var(--text-sub);

        text-align: left;

        cursor: pointer;

        white-space: nowrap;

      }




      .chart-analysis-month-btn:hover {

        background: rgba(229, 231, 235, 0.9);

      }




      .chart-analysis-month-btn.active {

        background: rgba(129, 140, 248, 0.08);

        border-color: var(--accent-strong);

        color: var(--text-main);

        font-weight: 500;

      }




      .chart-analysis-body {

        flex: 1;

        padding: 6px 8px;

        display: flex;

        flex-direction: column;

        gap: 4px;

      }




      .chart-analysis-title {

        font-size: 11px;

        color: var(--text-sub);

        font-weight: 500;

      }




      .chart-analysis-text {

        font-size: 11px;

        color: var(--text-main);

        line-height: 1.6;

        white-space: pre-wrap;

      }




      .chart-comment {

        margin-top: 4px;

        border-radius: var(--radius-md);

        border: 1px solid rgba(209, 213, 219, 0.8);

        padding: 6px 8px;

        background: rgba(249, 250, 251, 0.95);

        display: flex;

        flex-direction: column;

        gap: 4px;

      }




      .chart-comment-label {

        font-size: 11px;

        color: var(--text-sub);

        display: flex;

        justify-content: space-between;

        align-items: center;

        gap: 6px;

      }




      .chart-comment textarea {

        width: 100%;

        min-height: 52px;

        max-height: 130px;

        font-size: 11px;

        font-family: inherit;

        border-radius: 8px;

        border: 1px solid rgba(209, 213, 219, 0.9);

        padding: 4px 6px;

        resize: vertical;

        outline: none;

        background-color: #fff;

      }




      .chart-comment textarea:focus {

        border-color: var(--accent-strong);

        box-shadow: 0 0 0 1px rgba(129, 140, 248, 0.15);

      }




      .comment-actions {

        display: flex;

        align-items: center;

        justify-content: space-between;

        gap: 6px;

      }




      .btn-save {

        padding: 3px 10px;

        font-size: 11px;

        border-radius: var(--radius-pill);

        border: none;

        cursor: pointer;

        background: linear-gradient(120deg, var(--accent-strong), #22c55e);

        color: white;

        font-weight: 500;

        box-shadow: 0 8px 18px rgba(37, 99, 235, 0.5);

        transition: transform var(--transition-fast),

          box-shadow var(--transition-fast);

      }




      .btn-save:active {

        transform: translateY(1px);

        box-shadow: 0 5px 12px rgba(37, 99, 235, 0.5);

      }




      .comment-status {

        font-size: 10px;

        color: var(--text-sub);

      }




      .filter-chip {

        font-size: 11px;

        padding: 3px 8px;

        border-radius: var(--radius-pill);

        border: 1px solid rgba(148, 163, 184, 0.6);

        background: rgba(249, 250, 251, 0.9);

        display: inline-flex;

        align-items: center;

        gap: 4px;

        cursor: pointer;

        user-select: none;

        white-space: nowrap;

      }




      .filter-chip input {

        accent-color: var(--accent-strong);

        cursor: pointer;

      }




      .filter-chip-active {

        border-color: rgba(37, 99, 235, 0.9);

        background: var(--accent-soft);

        color: var(--accent-strong);

      }




      .footer {

        padding: 8px 24px 14px;

        font-size: 10px;

        color: var(--text-sub);

        display: flex;

        justify-content: space-between;

        gap: 10px;

        border-top: 1px solid rgba(148, 163, 184, 0.35);

        background: linear-gradient(

          to right,

          rgba(248, 250, 252, 0.92),

          rgba(241, 245, 249, 0.96)

        );

      }




      .footer strong {

        font-weight: 600;

      }




      @media (max-width: 900px) {

        .chart-card-header {

          flex-direction: column;

          align-items: flex-start;

        }

        .chart-title-block {

          max-width: 100%;

        }

        .chart-controls {

          align-items: flex-start;

          min-width: 0;

        }

        .hero {

          flex-direction: column;

          align-items: flex-start;

        }

        .hero-side {

          align-items: flex-start;

          text-align: left;

        }

      }

      /* ========= 图下方数据表 ========= */

      .chart-table-section {

        margin-top: 6px;

        padding-top: 6px;

        border-top: 1px dashed rgba(148, 163, 184, 0.5);

      }




      .chart-table-title {

        font-size: 11px;

        color: var(--text-sub);

        margin-bottom: 4px;

      }




      .chart-table-wrapper {

        max-height: 260px;

        overflow: auto;

        border-radius: 6px;

        border: 1px solid rgba(209, 213, 219, 0.9);

        background: #ffffff;

      }




      table.chart-table {

        width: 100%;

        border-collapse: collapse;

        font-size: 11px;

      }




      .chart-table thead th,

      .chart-table tbody td {

        padding: 4px 8px;

        border-bottom: 1px solid #f3f4f6;

        white-space: nowrap;

      }




      .chart-table thead th {

        position: sticky;

        top: 0;

        z-index: 1;

        background: #f9fafb;

        text-align: center;

        font-weight: 500;

        color: var(--text-sub);

      }




      .chart-table tbody tr:nth-child(odd) td {

        background: #fcfcff;

      }




      .chart-table tbody tr:hover td {

        background: #eef2ff;

      }




      .chart-table td.num {

        text-align: right;

        font-variant-numeric: tabular-nums;

      }




      .chart-table td.highlight {

        color: #d4380d;

        font-weight: 600;

      }

      /* ===========
         OVP 空位样式
         =========== */
      .chart-coming {
        position: relative;
        background: linear-gradient(
          to bottom,
          rgba(241, 245, 249, 0.7),
          rgba(248, 250, 252, 0.95)
        );
        border: 1px dashed rgba(148, 163, 184, 0.6);
        border-radius: var(--radius-md);
        overflow: hidden;
      }

      .chart-coming-inner {
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 14px 10px;
        text-align: center;
      }

      .chart-coming-title {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-main);
      }

      .chart-coming-sub {
        font-size: 11px;
        color: var(--text-sub);
        max-width: 520px;
        line-height: 1.5;
      }

      .inline-kbd {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 1px 8px;
        border-radius: var(--radius-pill);
        border: 1px solid rgba(148, 163, 184, 0.45);
        background: rgba(255, 255, 255, 0.9);
        font-size: 11px;
        color: var(--text-main);
        font-variant-numeric: tabular-nums;
      }
    </style>
  </head>

  <body>
    <div class="page">
<header class="top-bar">

        <div class="top-left">

          <div class="brand-mark">

            <div class="brand-mark-inner"></div>

          </div>

          <div>

            <div class="brand-text-main">Bangbet Growth Console</div>

            <div class="brand-text-sub">Organic · Monthly Comparison</div>

            <div class="breadcrumb">

              <a href="../index.html">首页目录</a> / 自然量月度数据对比

            </div>

          </div>

        </div>

        <div class="top-right">

          <div class="badge-env">

            <span class="badge-dot"></span>

            <span>Prod · Light · 自然渠道</span>

          </div>

          <div>单位：人数 / % / USD 等值 · 周期：按月 + 按日</div>

        </div>

      </header>

      <section class="hero">
        <div class="hero-main">
          <div class="hero-title">
            <span class="bar"></span>
            <span>自然量 vs 买量月度数据对比 · 看板</span>
          </div>
          <div class="hero-sub">
            目标：同口径对比自然量与买量在注册规模、付费、ARPPU、下注深度、玩法结构与留存上的差异。
            数据入口：<span class="inline-kbd">organic-data.js</span> 与 <span class="inline-kbd">paid-data.js</span>（均为日维度明细，按月分包）。
          </div>
          <div class="hero-tags">
            <span class="hero-tag">范围：GH / KE / NG / TZ / UG</span>
            <span class="hero-tag">模块：注册 · 付费率 · ARPPU · 人均流水 · 玩法结构 · 留存</span>
            <span class="hero-tag">来源：自然渠道 + 买量渠道</span>
          </div>
        </div>

        <div class="hero-side">
          <div>当前版本：v0.1 · 先搭结构，图表逻辑按模块逐步接入。</div>
          <div>
            每月新增数据：在两个数据文件里各新增一个月份 key（YYYY-MM），把当月对象列表粘贴进数组即可。
          </div>
          <div class="hero-pill" id="data-health">
            数据加载状态：等待读取（请确保数据文件已放在同级目录）。
          </div>
        </div>
      </section>

      <main class="content">
       <!-- 模块 1：自然量 vs 买量注册量 -->
<section class="chart-card" id="card-m1-registrations">
  <header class="chart-card-header">
    <div class="chart-title-block">
      <div class="chart-title">模块 1｜自然量 vs 买量注册量</div>
      <div class="chart-sub">
        口径：当月按国家汇总注册（自然=organic-data.js，买量=paid-data.js；买量跨 media/productType 自动累加）
      </div>
    </div>

    <div class="chart-controls">
      <span class="chart-badge">单位：人（注册）</span>

      <div class="chart-mini-filter">
        <span class="chart-mini-label">视图：</span>
        <div class="chart-mini-radio">
          <label>
            <input type="radio" name="m1-reg-view" value="bar" checked />
            柱状（月度）
          </label>
          <label>
            <input type="radio" name="m1-reg-view" value="line" />
            折线（日度）
          </label>
        </div>
      </div>

      <div class="chart-mini-filter">
        <span class="chart-mini-label">月份：</span>
        <div class="chart-mini-chips" id="m1-reg-months"></div>
      </div>

      <div class="chart-mini-filter">
        <span class="chart-mini-label">国家：</span>
        <div class="chart-mini-chips" id="m1-reg-countries"></div>
      </div>
    </div>
  </header>

  <div class="chart" id="chart-m1-registrations"></div>

  <div class="chart-table-section">
    <div class="chart-table-title">
      当前筛选 · 注册量拆分（占比=自然/买量 ÷ 当月总注册）
    </div>
    <div class="chart-table-wrapper">
      <table id="table-m1-registrations" class="chart-table"></table>
    </div>
  </div>

  <!-- 先留空：你后面要写分析结论也方便复用原样式 -->
  <div class="chart-summary" data-analysis-key="m1-reg"></div>
</section>


        <!-- 2、D0 / D7 付费率（自然 vs 买量） -->
<section class="chart-card" id="card-payrate">
  <header class="chart-card-header">
    <div class="chart-title-row">
      <div>
        <div class="chart-title">2、D0 / D7 付费率</div>
        <div class="chart-subtitle">口径：Unique Purchasers ÷ 注册（单位：%）</div>
      </div>
    </div>

    <div class="chart-controls">
      <span class="chart-badge">单位：%</span>

      <div class="chart-mini-filter">
        <span class="chart-mini-label">视图：</span>
        <div class="chart-mini-radio">
          <label><input type="radio" name="payrate-view" value="bar" checked />月度柱状图</label>
          <label><input type="radio" name="payrate-view" value="line" />日级折线图</label>
        </div>
      </div>

      <div class="chart-mini-filter">
        <span class="chart-mini-label">天数：</span>
        <div class="chart-mini-radio">
          <label><input type="radio" name="payrate-day-type" value="both" checked />D0 + D7</label>
          <label><input type="radio" name="payrate-day-type" value="D0" />仅 D0</label>
          <label><input type="radio" name="payrate-day-type" value="D7" />仅 D7</label>
        </div>
      </div>

      <div class="chart-mini-filter">
        <span class="chart-mini-label">月份（单选）：</span>
        <div class="chart-mini-chips" id="payrate-month"></div>
      </div>

      <div class="chart-mini-filter">
        <span class="chart-mini-label">国家：</span>
        <div class="chart-mini-chips" id="payrate-countries"></div>
      </div>
    </div>
  </header>

  <div class="chart" id="chart-payrate"></div>
  <div class="chart-summary" data-analysis-key="payrate"></div>

  <div class="chart-table-section">
    <div class="chart-table-title">当前筛选 · D0 / D7 付费率（月度汇总，单月）</div>
    <div class="chart-table-wrapper">
      <table id="table-payrate" class="chart-table"></table>
    </div>
  </div>
</section>


        <!-- 3. D0 / D7 ARPPU -->
        <section class="chart-card" id="card-arppu">
          <header class="chart-card-header">
            <div class="chart-title-block">
              <div class="chart-kicker">Value</div>
              <div class="chart-title">D0 / D7 ARPPU</div>
              <div class="chart-sub">
                空位：ARPPU = PURCHASE_VALUE / unique_purchase；自然 vs 买量对比。
              </div>
            </div>
            <div class="chart-controls">
              <span class="chart-badge">单位：USD 等值 / 付费用户</span>
              <!-- TODO: 控件区 -->
            </div>
          </header>

          <div class="chart chart-coming" id="chart-arppu">
            <div class="chart-coming-inner">
              <div class="chart-coming-title">模块待接入</div>
              <div class="chart-coming-sub">下一步：实现「D0 / D7 ARPPU」对比（自然 vs 买量）。</div>
            </div>
          </div>

          <div class="chart-summary" data-analysis-key="arppu">
            备注：后续将输出异常值识别（高 ARPPU 是否由少量大额用户驱动等）。
          </div>

          <div class="chart-table-section">
            <div class="chart-table-title">当前筛选 · D0 / D7 ARPPU（月度）</div>
            <div class="chart-table-wrapper">
              <table id="table-arppu" class="chart-table"></table>
            </div>
          </div>
        </section>

        <!-- 4. D0 / D7 人均流水 -->
        <section class="chart-card" id="card-flow">
          <header class="chart-card-header">
            <div class="chart-title-block">
              <div class="chart-kicker">Betting Depth</div>
              <div class="chart-title">D0 / D7 人均流水（体育 / 游戏 / 总）</div>
              <div class="chart-sub">
                空位：人均流水 = BET_FLOW / BET_PLACED_USER；自然 vs 买量对比，可切到体育/游戏/总。
              </div>
            </div>
            <div class="chart-controls">
              <span class="chart-badge">单位：USD 等值 / 下注用户</span>
              <!-- TODO: 控件区 -->
            </div>
          </header>

          <div class="chart chart-coming" id="chart-flow">
            <div class="chart-coming-inner">
              <div class="chart-coming-title">模块待接入</div>
              <div class="chart-coming-sub">下一步：实现「D0 / D7 人均流水」对比（自然 vs 买量）。</div>
            </div>
          </div>

          <div class="chart-summary" data-analysis-key="flow">
            备注：后续将输出玩法维度差异（体育/游戏占比与深度）。
          </div>

          <div class="chart-table-section">
            <div class="chart-table-title">当前筛选 · D0 / D7 人均流水（月度）</div>
            <div class="chart-table-wrapper">
              <table id="table-flow" class="chart-table"></table>
            </div>
          </div>
        </section>

        <!-- 5. 体育 vs 游戏玩家比例 -->
        <section class="chart-card" id="card-ratio">
          <header class="chart-card-header">
            <div class="chart-title-block">
              <div class="chart-kicker">Mix</div>
              <div class="chart-title">体育 vs 游戏玩家比例</div>
              <div class="chart-sub">
                空位：SPORTS_BET_PLACED_USER / GAMES_BET_PLACED_USER；自然 vs 买量对比（D0/D7）。
              </div>
            </div>
            <div class="chart-controls">
              <span class="chart-badge">单位：比值（sports / games）</span>
              <!-- TODO: 控件区 -->
            </div>
          </header>

          <div class="chart chart-coming" id="chart-ratio">
            <div class="chart-coming-inner">
              <div class="chart-coming-title">模块待接入</div>
              <div class="chart-coming-sub">下一步：实现「体育 vs 游戏玩家比例」对比（自然 vs 买量）。</div>
            </div>
          </div>

          <div class="chart-summary" data-analysis-key="ratio">
            备注：后续将输出结构性变化（例如买量偏游戏导致付费/留存波动）。
          </div>

          <div class="chart-table-section">
            <div class="chart-table-title">当前筛选 · 体育 vs 游戏玩家比例（月度）</div>
            <div class="chart-table-wrapper">
              <table id="table-ratio" class="chart-table"></table>
            </div>
          </div>
        </section>

        <!-- 6. 次日 / 7 日留存率 -->
        <section class="chart-card" id="card-retention">
          <header class="chart-card-header">
            <div class="chart-title-block">
              <div class="chart-kicker">Retention</div>
              <div class="chart-title">次日 / 7 日留存率</div>
              <div class="chart-sub">
                空位：次留 = D1_retained_users/registration；七留 = D7_retained_users/registration；自然 vs 买量对比。
              </div>
            </div>
            <div class="chart-controls">
              <span class="chart-badge">单位：%</span>
              <!-- TODO: 控件区 -->
            </div>
          </header>

          <div class="chart chart-coming" id="chart-retention">
            <div class="chart-coming-inner">
              <div class="chart-coming-title">模块待接入</div>
              <div class="chart-coming-sub">下一步：实现「次日 / 7 日留存率」对比（自然 vs 买量）。</div>
            </div>
          </div>

          <div class="chart-summary" data-analysis-key="retention">
            备注：后续将输出留存曲线与关键国家/媒体的流失来源假设。
          </div>

          <div class="chart-table-section">
            <div class="chart-table-title">当前筛选 · 次日 / 7 日留存率（月度）</div>
            <div class="chart-table-wrapper">
              <table id="table-retention" class="chart-table"></table>
            </div>
          </div>
        </section>
      </main>

<footer class="footer">

        <span

          >Owner：<strong>用户增长部-Jerry Lyu</strong> · 自然量看板 v3.1（从

          RAW_ORGANIC_BY_MONTH 聚合）</span

        >

        <span>数据来源：内部自然量报表 · 时间口径建议统一为 UTC+0 日切。</span>

      </footer>
    </div>

    <!-- ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>

    <script src="./organic-data.js"></script>
    <script src="./paid-data.js"></script>

    <script>
      // ===========================
// 模块 1：自然量 vs 买量注册量
// 依赖：window.RAW_ORGANIC_BY_MONTH / window.RAW_PAID_BY_MONTH
// ===========================
(function () {
  const RAW_ORGANIC_BY_MONTH = window.RAW_ORGANIC_BY_MONTH || {};
  const RAW_PAID_BY_MONTH = window.RAW_PAID_BY_MONTH || {};

  // 若你的项目里已经有 COUNTRY_COLOR_MAP，这里会自动复用
  const COUNTRY_COLOR_MAP = window.COUNTRY_COLOR_MAP || {
    GH: "#2563eb",
    KE: "#16a34a",
    NG: "#f97316",
    TZ: "#7c3aed",
    UG: "#ef4444",
  };

  const SERIES_COLOR = {
    organic: "#2563eb", // 柱状图：自然量系列颜色
    paid: "#f97316",    // 柱状图：买量系列颜色
  };

  function uniq(arr) {
    return Array.from(new Set(arr));
  }

  function formatInteger(v) {
    if (v == null || Number.isNaN(Number(v))) return "-";
    return Math.round(Number(v)).toLocaleString("en-US");
  }

  function formatPercent(p) {
    if (p == null || Number.isNaN(Number(p))) return "-";
    return (Number(p) * 100).toFixed(1) + "%";
  }

  function yAxisFormatter(v) {
    const n = Number(v);
    if (!Number.isFinite(n)) return v;
    if (Math.abs(n) >= 1_000_000) return (n / 1_000_000).toFixed(1) + "m";
    if (Math.abs(n) >= 1_000) return (n / 1_000).toFixed(1) + "k";
    return String(n);
  }

  function getAllMonths() {
    const ms = uniq([
      ...Object.keys(RAW_ORGANIC_BY_MONTH || {}),
      ...Object.keys(RAW_PAID_BY_MONTH || {}),
    ]);
    ms.sort(); // YYYY-MM 字符串排序即可
    return ms;
  }

  function getAllCountries() {
    const set = new Set();
    const collect = (byMonth) => {
      Object.values(byMonth || {}).forEach((rows) => {
        (rows || []).forEach((r) => r && r.country && set.add(r.country));
      });
    };
    collect(RAW_ORGANIC_BY_MONTH);
    collect(RAW_PAID_BY_MONTH);
    return Array.from(set).sort();
  }

  function getMonthDateAxis(month) {
    if (!month || month.length !== 7) return [];
    const parts = month.split("-");
    const year = Number(parts[0]);
    const m = Number(parts[1]); // 1-12
    if (!Number.isFinite(year) || !Number.isFinite(m)) return [];
    const lastDay = new Date(year, m, 0).getDate(); // monthIndex=m 表示下月，day=0 -> 当月最后一天
    const dates = [];
    for (let d = 1; d <= lastDay; d++) {
      dates.push(month + "-" + String(d).padStart(2, "0"));
    }
    return dates;
  }

  function getCountryColor(country, idx) {
    const fallback = [
      "#2563eb", "#16a34a", "#f97316", "#7c3aed", "#ef4444",
      "#0ea5e9", "#22c55e", "#f43f5e", "#a855f7", "#64748b",
    ];
    return COUNTRY_COLOR_MAP[country] || fallback[idx % fallback.length];
  }

  // 单选 Chip（radio）：用于月份
  function createSingleSelectChips(options) {
    const {
      containerId,
      values,
      getLabel,
      stateObj,
      key,
      name,
      preselect = "last", // "last" | number | 具体值
      onChange,
    } = options || {};

    const container = document.getElementById(containerId);
    if (!container || !Array.isArray(values)) return;

    container.innerHTML = "";

    // 初始化默认选择
    if (!stateObj[key]) {
      if (preselect === "last") {
        stateObj[key] = values[values.length - 1] || "";
      } else if (typeof preselect === "number") {
        stateObj[key] = values[Math.max(0, Math.min(preselect, values.length - 1))] || "";
      } else if (typeof preselect === "string") {
        stateObj[key] = values.indexOf(preselect) !== -1 ? preselect : (values[values.length - 1] || "");
      }
    }

    values.forEach((value, idx) => {
      const labelEl = document.createElement("label");
      labelEl.className = "filter-chip";

      const input = document.createElement("input");
      input.type = "radio";
      input.name = name || containerId;
      input.value = value;

      const selected = value === stateObj[key];
      if (selected) {
        input.checked = true;
        labelEl.classList.add("filter-chip-active");
      }

      labelEl.appendChild(input);
      labelEl.appendChild(
        document.createTextNode(typeof getLabel === "function" ? getLabel(value, idx) : value)
      );

      input.addEventListener("change", () => {
        if (!input.checked) return;
        stateObj[key] = value;

        // 刷新 active 状态
        container.querySelectorAll(".filter-chip").forEach((el) => el.classList.remove("filter-chip-active"));
        labelEl.classList.add("filter-chip-active");

        if (typeof onChange === "function") onChange();
      });

      container.appendChild(labelEl);
    });

    if (typeof onChange === "function") onChange();
  }

  // 多选 Chip（checkbox）：用于国家
  function createMultiSelectChips(options) {
    const {
      containerId,
      values,
      getLabel,
      stateArray,
      preselect = "all", // "all" | number
      max,               // 可不传，表示不限制
      onChange,
    } = options || {};

    const container = document.getElementById(containerId);
    if (!container || !Array.isArray(values) || !Array.isArray(stateArray)) return;

    container.innerHTML = "";

    // 初始化默认选中
    if (stateArray.length === 0) {
      if (preselect === "all") {
        values.forEach((v) => stateArray.push(v));
      } else if (typeof preselect === "number") {
        for (let i = 0; i < Math.min(preselect, values.length); i++) stateArray.push(values[i]);
      }
    }

    values.forEach((value, idx) => {
      const labelEl = document.createElement("label");
      labelEl.className = "filter-chip";

      const input = document.createElement("input");
      input.type = "checkbox";
      input.value = value;

      const selected = stateArray.indexOf(value) !== -1;
      if (selected) {
        input.checked = true;
        labelEl.classList.add("filter-chip-active");
      }

      labelEl.appendChild(input);
      labelEl.appendChild(
        document.createTextNode(typeof getLabel === "function" ? getLabel(value, idx) : value)
      );

      input.addEventListener("change", () => {
        const existsIndex = stateArray.indexOf(value);

        if (input.checked) {
          if (max && stateArray.length >= max && existsIndex === -1) {
            input.checked = false;
            return;
          }
          if (existsIndex === -1) stateArray.push(value);
        } else {
          if (existsIndex !== -1) stateArray.splice(existsIndex, 1);
        }

        labelEl.classList.toggle("filter-chip-active", input.checked);
        if (typeof onChange === "function") onChange();
      });

      container.appendChild(labelEl);
    });

    if (typeof onChange === "function") onChange();
  }

  function bindRadioGroup(name, stateObj, key, onChange) {
    const radios = document.querySelectorAll('input[name="' + name + '"]');
    radios.forEach((r) => {
      if (r.checked) stateObj[key] = r.value;
      r.addEventListener("change", () => {
        if (r.checked) {
          stateObj[key] = r.value;
          if (typeof onChange === "function") onChange();
        }
      });
    });
  }

  function renderEmptyTable(table, msg) {
    table.innerHTML = "";
    const thead = document.createElement("thead");
    const tr = document.createElement("tr");
    tr.innerHTML = "<th>暂无数据</th>";
    thead.appendChild(tr);
    const tbody = document.createElement("tbody");
    const tr2 = document.createElement("tr");
    tr2.innerHTML = '<td class="muted">' + (msg || "请先导入数据或调整筛选") + "</td>";
    tbody.appendChild(tr2);
    table.appendChild(thead);
    table.appendChild(tbody);
  }

  // 汇总：当月按国家（自然/买量/总）
  function aggregateMonthlyRegistrations(month, countries) {
    const orgRows = RAW_ORGANIC_BY_MONTH[month] || [];
    const paidRows = RAW_PAID_BY_MONTH[month] || [];

    const orgBy = {};
    const paidBy = {};

    orgRows.forEach((r) => {
      if (!r || !r.country) return;
      if (countries.indexOf(r.country) === -1) return;
      const v = Number(r.registration || 0);
      orgBy[r.country] = (orgBy[r.country] || 0) + (Number.isFinite(v) ? v : 0);
    });

    paidRows.forEach((r) => {
      if (!r || !r.country) return;
      if (countries.indexOf(r.country) === -1) return;
      const v = Number(r.registration || 0);
      paidBy[r.country] = (paidBy[r.country] || 0) + (Number.isFinite(v) ? v : 0);
    });

    const rows = countries.map((c) => {
      const organic = orgBy[c] || 0;
      const paid = paidBy[c] || 0;
      const total = organic + paid;
      return {
        country: c,
        organic,
        paid,
        total,
        organicShare: total > 0 ? organic / total : null,
        paidShare: total > 0 ? paid / total : null,
      };
    });

    // 默认按总注册倒序，看重点国家更直观
    rows.sort((a, b) => b.total - a.total);
    return rows;
  }

  // 索引：当月按国家×日期汇总注册（paid 会跨 media/productType 累加）
  function indexDailyRegistrations(rows, countries) {
    const map = {}; // { country: { date: value } }
    (rows || []).forEach((r) => {
      if (!r || !r.country || !r.date) return;
      if (countries.indexOf(r.country) === -1) return;
      const v = Number(r.registration || 0);
      if (!map[r.country]) map[r.country] = {};
      map[r.country][r.date] = (map[r.country][r.date] || 0) + (Number.isFinite(v) ? v : 0);
    });
    return map;
  }

  function updateM1Table(month, countries) {
    const table = document.getElementById("table-m1-registrations");
    if (!table) return;

    if (!month || !countries || !countries.length) {
      renderEmptyTable(table, "请选择月份/国家");
      return;
    }

    const rows = aggregateMonthlyRegistrations(month, countries);
    if (!rows.length) {
      renderEmptyTable(table, "该筛选下无数据");
      return;
    }

    const thead = document.createElement("thead");
    const headRow = document.createElement("tr");
    headRow.innerHTML =
      "<th>国家</th>" +
      "<th class='num'>自然量占比</th>" +
      "<th class='num'>买量占比</th>" +
      "<th class='num'>自然量注册数</th>" +
      "<th class='num'>买量注册数</th>" +
      "<th class='num'>总注册数</th>";
    thead.appendChild(headRow);

    const tbody = document.createElement("tbody");
    rows.forEach((r) => {
      const tr = document.createElement("tr");
      tr.innerHTML =
        "<td>" + r.country + "</td>" +
        "<td class='num'>" + formatPercent(r.organicShare) + "</td>" +
        "<td class='num'>" + formatPercent(r.paidShare) + "</td>" +
        "<td class='num'>" + formatInteger(r.organic) + "</td>" +
        "<td class='num'>" + formatInteger(r.paid) + "</td>" +
        "<td class='num'><strong>" + formatInteger(r.total) + "</strong></td>";
      tbody.appendChild(tr);
    });

    table.innerHTML = "";
    table.appendChild(thead);
    table.appendChild(tbody);
  }

  function updateM1Chart(chart, month, countries, view) {
    if (!chart) return;

    // 表格永远按“当月汇总”展示，切图表类型不影响表口径
    updateM1Table(month, countries);

    if (!month) {
      chart.clear();
      chart.setOption({
        title: {
          text: "暂无数据",
          left: "center",
          top: "middle",
          textStyle: { color: "#94a3b8", fontSize: 14, fontWeight: 500 },
        },
      });
      return;
    }

    const monthRows = aggregateMonthlyRegistrations(month, countries);
    const orderedCountries = monthRows.map((r) => r.country);

    if (view === "line") {
      const dates = getMonthDateAxis(month);
      const orgRows = RAW_ORGANIC_BY_MONTH[month] || [];
      const paidRows = RAW_PAID_BY_MONTH[month] || [];
      const orgIndex = indexDailyRegistrations(orgRows, orderedCountries);
      const paidIndex = indexDailyRegistrations(paidRows, orderedCountries);

      const series = [];
      orderedCountries.forEach((c, idx) => {
        const color = getCountryColor(c, idx);
        const orgData = dates.map((d) => (orgIndex[c] && orgIndex[c][d]) ? orgIndex[c][d] : 0);
        const paidData = dates.map((d) => (paidIndex[c] && paidIndex[c][d]) ? paidIndex[c][d] : 0);

        series.push({
          name: c + " · 自然",
          type: "line",
          smooth: true,
          connectNulls: true,
          symbolSize: 3,
          itemStyle: { color },
          lineStyle: { color, width: 2, type: "solid" },
          data: orgData,
        });

        series.push({
          name: c + " · 买量",
          type: "line",
          smooth: true,
          connectNulls: true,
          symbolSize: 3,
          itemStyle: { color },
          lineStyle: { color, width: 2, type: "dashed" },
          data: paidData,
        });
      });

      chart.setOption(
        {
          tooltip: { trigger: "axis" },
          legend: { type: "scroll", top: 10, left: 12, right: 12 },
          grid: { left: 50, right: 22, top: 60, bottom: 40 },
          xAxis: {
            type: "category",
            data: dates,
            axisLabel: { formatter: (v) => v.slice(8) },
          },
          yAxis: {
            type: "value",
            name: "注册数",
            axisLabel: { formatter: yAxisFormatter },
          },
          series,
        },
        true
      );
    } else {
      const orgData = monthRows.map((r) => r.organic);
      const paidData = monthRows.map((r) => r.paid);

      chart.setOption(
        {
          tooltip: { trigger: "axis", axisPointer: { type: "shadow" } },
          legend: { top: 10, left: 12, data: ["自然量", "买量"] },
          grid: { left: 50, right: 22, top: 60, bottom: 40 },
          xAxis: { type: "category", data: orderedCountries },
          yAxis: {
            type: "value",
            name: "注册数",
            axisLabel: { formatter: yAxisFormatter },
          },
          series: [
            {
              name: "自然量",
              type: "bar",
              barMaxWidth: 28,
              itemStyle: { color: SERIES_COLOR.organic },
              emphasis: { focus: "series" },
              data: orgData,
            },
            {
              name: "买量",
              type: "bar",
              barMaxWidth: 28,
              itemStyle: { color: SERIES_COLOR.paid },
              emphasis: { focus: "series" },
              data: paidData,
            },
          ],
        },
        true
      );
    }
  }

  function initM1() {
    const dom = document.getElementById("chart-m1-registrations");
    if (!dom) return;
    if (!window.echarts) {
      console.error("ECharts not found: 请确认已引入 echarts.min.js");
      return;
    }

    const ALL_MONTHS = getAllMonths();
    const ALL_COUNTRIES = getAllCountries();

    const st = {
      month: "",        // 单个月份
      countries: [],    // 多选国家
      view: "bar",      // bar | line
    };

    const chart = echarts.init(dom);
    window.addEventListener("resize", () => chart.resize());

    // 月份：单选
    createSingleSelectChips({
      containerId: "m1-reg-months",
      values: ALL_MONTHS,
      getLabel: (m) => m,
      stateObj: st,
      key: "month",
      name: "m1-reg-month",
      preselect: "last",
      onChange: () => {
        const cs = st.countries && st.countries.length ? st.countries : ALL_COUNTRIES;
        updateM1Chart(chart, st.month, cs, st.view);
      },
    });

    // 国家：多选
    createMultiSelectChips({
      containerId: "m1-reg-countries",
      values: ALL_COUNTRIES,
      getLabel: (c) => c,
      stateArray: st.countries,
      preselect: "all",
      onChange: () => {
        const cs = st.countries && st.countries.length ? st.countries : ALL_COUNTRIES;
        updateM1Chart(chart, st.month, cs, st.view);
      },
    });

    // 视图切换
    bindRadioGroup("m1-reg-view", st, "view", () => {
      const cs = st.countries && st.countries.length ? st.countries : ALL_COUNTRIES;
      updateM1Chart(chart, st.month, cs, st.view);
    });

    // 首次渲染
    const cs = st.countries && st.countries.length ? st.countries : ALL_COUNTRIES;
    updateM1Chart(chart, st.month, cs, st.view);
  }

  document.addEventListener("DOMContentLoaded", initM1);
})();
/***********************
 * 模块2：D0 / D7 付费率（自然 vs 买量）
 * 口径：D0 付费率 = D0_unique_purchase / registration；D7 同理（输出为 %）
 ***********************/
(function () {
  if (typeof echarts === "undefined") {
    console.error("[payrate] echarts 未加载");
    return;
  }

  // === 0) 数据入口（跟你的 data.js 变量名保持一致） ===
  const ORGANIC_DATA = window.ORGANIC_DATA || [];
  const PAID_DATA = window.PAID_DATA || [];

  // === 1) 全局规则（全看板一致） ===
  const COUNTRY_ORDER = ["GH", "KE", "NG", "TZ", "UG"];

  // 月度柱状：颜色编码“自然 vs 买量”
  const CHANNEL_COLOR = { organic: "#2563eb", paid: "#f97316" };

  // 日级折线：颜色编码“国家”，线型编码“自然/买量”
  const COUNTRY_COLOR = {
    GH: "#2563eb",
    KE: "#16a34a",
    NG: "#f97316",
    TZ: "#7c3aed",
    UG: "#ef4444",
  };

  // 先把未来模块需要的数值字段都并进来（不会影响本模块）
  const NUMERIC_FIELDS = [
    "spent",
    "registration",
    "D0_unique_purchase",
    "D7_unique_purchase",
    "D0_PURCHASE_VALUE",
    "D7_PURCHASE_VALUE",
    "D0_TOTAL_BET_PLACED_USER",
    "D7_TOTAL_BET_PLACED_USER",
    "D0_SPORTS_BET_PLACED_USER",
    "D0_GAMES_BET_PLACED_USER",
    "D7_SPORTS_BET_PLACED_USER",
    "D7_GAMES_BET_PLACED_USER",
    "D0_SPORTS_BET_FLOW",
    "D0_GAMES_BET_FLOW",
    "D0_TOTAL_BET_FLOW",
    "D7_SPORTS_BET_FLOW",
    "D7_GAMES_BET_FLOW",
    "D7_TOTAL_BET_FLOW",
    "D1_retained_users",
    "D7_retained_users",
  ];

  // === 2) 工具函数 ===
  function toNumber(v) {
    const n = Number(v);
    return Number.isFinite(n) ? n : 0;
  }

  function safeDivide(n, d) {
    return d > 0 ? n / d : null;
  }

  function getMonthKey(dateStr) {
    return String(dateStr || "").slice(0, 7);
  }

  function formatMonthShort(monthKey) {
    const bits = String(monthKey || "").split("-");
    if (bits.length !== 2) return String(monthKey || "");
    return String(Number(bits[1])) + "月";
  }

  function formatPercent(v) {
    if (v == null || !Number.isFinite(v)) return "-";
    return v.toFixed(1) + "%";
  }

  function getOrderedCountries(selectedArr) {
    const set = new Set((selectedArr || []).filter(Boolean));
    const ordered = COUNTRY_ORDER.filter((c) => set.has(c));
    return ordered.length ? ordered : COUNTRY_ORDER.slice();
  }

  function mergeSortedUnique(a, b) {
    const set = new Set([...(a || []), ...(b || [])]);
    return Array.from(set).sort();
  }

  // === 3) 索引：month/date × country -> agg ===
  function emptyAgg() {
    const obj = {};
    NUMERIC_FIELDS.forEach((k) => (obj[k] = 0));
    return obj;
  }

  function addToAgg(agg, row) {
    if (!agg || !row) return;
    NUMERIC_FIELDS.forEach((k) => {
      if (row[k] != null) agg[k] += toNumber(row[k]);
    });
  }

  function buildIndex(rows) {
    const idx = { monthCountry: {}, dateCountry: {} };
    (rows || []).forEach((r) => {
      const date = String(r.date || "");
      const country = String(r.country || "");
      if (!date || !country) return;

      const month = getMonthKey(date);

      if (!idx.monthCountry[month]) idx.monthCountry[month] = {};
      if (!idx.monthCountry[month][country]) idx.monthCountry[month][country] = emptyAgg();

      if (!idx.dateCountry[date]) idx.dateCountry[date] = {};
      if (!idx.dateCountry[date][country]) idx.dateCountry[date][country] = emptyAgg();

      addToAgg(idx.monthCountry[month][country], r);
      addToAgg(idx.dateCountry[date][country], r);
    });

    idx.allMonths = Object.keys(idx.monthCountry).sort();
    idx.allDates = Object.keys(idx.dateCountry).sort();
    return idx;
  }

  // 缓存到 window，后面模块 3/4/5/6 可以直接复用
  const OVP = (window.__OVP__ = window.__OVP__ || {});
  OVP.idx = OVP.idx || {
    organic: buildIndex(ORGANIC_DATA),
    paid: buildIndex(PAID_DATA),
  };
  OVP.allMonths = OVP.allMonths || mergeSortedUnique(OVP.idx.organic.allMonths, OVP.idx.paid.allMonths);

  function getAgg(idx, grain, key, country) {
    const map = grain === "date" ? idx.dateCountry : idx.monthCountry;
    return map[key] && map[key][country] ? map[key][country] : null;
  }

  function payRateFromAgg(agg, dayType) {
    if (!agg || !Number.isFinite(agg.registration) || agg.registration <= 0) return null;
    const payers = dayType === "D7" ? toNumber(agg.D7_unique_purchase) : toNumber(agg.D0_unique_purchase);
    const r = safeDivide(payers, toNumber(agg.registration));
    return r == null ? null : r * 100; // 0-100
  }

  function listDatesForMonth(monthKey, countries) {
    const set = new Set();
    const cs = countries || COUNTRY_ORDER;

    const addFrom = (idx) => {
      Object.keys(idx.dateCountry).forEach((date) => {
        if (!date.startsWith(monthKey)) return;
        const byCountry = idx.dateCountry[date] || {};
        for (let i = 0; i < cs.length; i++) {
          if (byCountry[cs[i]]) {
            set.add(date);
            break;
          }
        }
      });
    };

    addFrom(OVP.idx.organic);
    addFrom(OVP.idx.paid);

    return Array.from(set).sort();
  }

  // === 4) Chips：单选月份（新） ===
  function createSingleSelectChips(options) {
    const { containerId, values, getLabel, stateObj, stateKey, preselect, onChange } = options || {};
    const container = document.getElementById(containerId);
    if (!container || !Array.isArray(values) || !stateObj || !stateKey) return;

    container.innerHTML = "";
    const radioName = containerId + "-radio";

    // 默认：优先 preselect，否则取最新
    if (!stateObj[stateKey]) {
      if (typeof preselect === "string" && values.indexOf(preselect) !== -1) stateObj[stateKey] = preselect;
      else if (typeof preselect === "number" && values[preselect]) stateObj[stateKey] = values[preselect];
      else stateObj[stateKey] = values.length ? values[values.length - 1] : "";
    }

    values.forEach((value, idx) => {
      const labelEl = document.createElement("label");
      labelEl.className = "filter-chip";

      const input = document.createElement("input");
      input.type = "radio";
      input.name = radioName;
      input.value = value;

      const selected = stateObj[stateKey] === value;
      input.checked = selected;
      labelEl.classList.toggle("filter-chip-active", selected);

      labelEl.appendChild(input);
      labelEl.appendChild(document.createTextNode(typeof getLabel === "function" ? getLabel(value, idx) : value));

      input.addEventListener("change", () => {
        if (!input.checked) return;
        stateObj[stateKey] = value;

        Array.from(container.querySelectorAll("label.filter-chip")).forEach((lab) =>
          lab.classList.remove("filter-chip-active")
        );
        labelEl.classList.add("filter-chip-active");

        if (typeof onChange === "function") onChange();
      });

      container.appendChild(labelEl);
    });

    if (typeof onChange === "function") onChange();
  }

  // === 5) Multi chips + Radio bind（如果你主文件已有同名函数，可删这一段） ===
  function createMultiSelectChips(options) {
    const { containerId, values, getLabel, stateArray, max, preselect, onChange } = options || {};
    const container = document.getElementById(containerId);
    if (!container || !Array.isArray(values) || !Array.isArray(stateArray)) return;

    container.innerHTML = "";

    if (stateArray.length === 0) {
      if (preselect === "all") values.forEach((v) => stateArray.push(v));
      else if (typeof preselect === "number") {
        for (let i = 0; i < Math.min(preselect, values.length); i++) stateArray.push(values[i]);
      }
    }

    values.forEach((value, idx) => {
      const labelEl = document.createElement("label");
      labelEl.className = "filter-chip";

      const input = document.createElement("input");
      input.type = "checkbox";
      input.value = value;

      const selected = stateArray.indexOf(value) !== -1;
      input.checked = selected;
      labelEl.classList.toggle("filter-chip-active", selected);

      labelEl.appendChild(input);
      labelEl.appendChild(document.createTextNode(typeof getLabel === "function" ? getLabel(value, idx) : value));

      input.addEventListener("change", () => {
        const existsIndex = stateArray.indexOf(value);

        if (input.checked) {
          if (max && stateArray.length >= max && existsIndex === -1) {
            input.checked = false;
            return;
          }
          if (existsIndex === -1) stateArray.push(value);
        } else {
          if (existsIndex !== -1) stateArray.splice(existsIndex, 1);
        }

        labelEl.classList.toggle("filter-chip-active", input.checked);
        if (typeof onChange === "function") onChange();
      });

      container.appendChild(labelEl);
    });

    if (typeof onChange === "function") onChange();
  }

  function bindRadioGroup(name, stateObj, key, onChange) {
    const radios = document.querySelectorAll('input[name="' + name + '"]');
    radios.forEach((r) => {
      if (r.checked) stateObj[key] = r.value;
      r.addEventListener("change", () => {
        if (!r.checked) return;
        stateObj[key] = r.value;
        if (typeof onChange === "function") onChange();
      });
    });
  }

  function renderEmptyTable(tableEl, msg) {
    if (!tableEl) return;
    tableEl.innerHTML = "<tbody><tr><td>" + (msg || "无数据：请先在上方选择月份和国家") + "</td></tr></tbody>";
  }

  function renderEmptyChart(chart, msg) {
    chart.setOption(
      {
        title: {
          text: msg || "无数据",
          left: "center",
          top: "middle",
          textStyle: { fontSize: 12, fontWeight: 500, color: "#64748b" },
        },
        xAxis: { show: false },
        yAxis: { show: false },
        series: [],
      },
      true
    );
  }

  // === 6) 月度柱状图 ===
  function renderPayRateBar(chart, monthKey, countries, dayType) {
    const monthLabel = formatMonthShort(monthKey);
    const idxOrg = OVP.idx.organic;
    const idxPaid = OVP.idx.paid;

    const d0Org = countries.map((c) => payRateFromAgg(getAgg(idxOrg, "month", monthKey, c), "D0"));
    const d0Paid = countries.map((c) => payRateFromAgg(getAgg(idxPaid, "month", monthKey, c), "D0"));
    const d7Org = countries.map((c) => payRateFromAgg(getAgg(idxOrg, "month", monthKey, c), "D7"));
    const d7Paid = countries.map((c) => payRateFromAgg(getAgg(idxPaid, "month", monthKey, c), "D7"));

    const series = [];
    const barCommon = { type: "bar", barWidth: 10, emphasis: { focus: "series" } };

    if (dayType === "D0" || dayType === "both") {
      // 顺序固定：自然在左、买量在右
      series.push({ ...barCommon, name: "自然 D0", data: d0Org, itemStyle: { color: CHANNEL_COLOR.organic } });
      series.push({ ...barCommon, name: "买量 D0", data: d0Paid, itemStyle: { color: CHANNEL_COLOR.paid } });
    }

    if (dayType === "D7" || dayType === "both") {
      const d7Style = { opacity: 0.45 };
      const d7Decal = { symbol: "rect", dashArrayX: [1, 2], dashArrayY: [1, 2], rotation: Math.PI / 4 };

      series.push({
        ...barCommon,
        name: "自然 D7",
        data: d7Org,
        itemStyle: { color: CHANNEL_COLOR.organic, ...d7Style },
        decal: d7Decal,
      });
      series.push({
        ...barCommon,
        name: "买量 D7",
        data: d7Paid,
        itemStyle: { color: CHANNEL_COLOR.paid, ...d7Style },
        decal: d7Decal,
      });
    }

    chart.setOption(
      {
        grid: { left: 40, right: 20, top: 50, bottom: 40, containLabel: true },
        legend: { top: 10, left: 0, itemHeight: 10, itemWidth: 14 },
        tooltip: {
          trigger: "axis",
          axisPointer: { type: "shadow" },
          formatter: function (params) {
            const name = (params && params[0] && params[0].axisValue) || "";
            let html = name + "<br/>";
            (params || []).forEach((p) => {
              html += p.marker + p.seriesName + ": " + formatPercent(p.data) + "<br/>";
            });
            return html;
          },
        },
        xAxis: {
          type: "category",
          data: countries, // 固定为 GH/KE/NG/TZ/UG 相对顺序
          axisTick: { alignWithLabel: true },
          axisLabel: { interval: 0 },
        },
        yAxis: {
          type: "value",
          name: monthLabel + " 付费率",
          axisLabel: { formatter: (v) => v + "%" },
          splitLine: { lineStyle: { color: "rgba(148,163,184,0.25)" } },
        },
        series,
      },
      true
    );
  }

  // === 7) 日级折线图 ===
  function buildLineSeries(monthKey, countries, dayType) {
    const dates = listDatesForMonth(monthKey, countries);
    const idxOrg = OVP.idx.organic;
    const idxPaid = OVP.idx.paid;

    const makeData = (idx, c, dType) => dates.map((dt) => payRateFromAgg(getAgg(idx, "date", dt, c), dType));

    const series = [];
    countries.forEach((c) => {
      const color = COUNTRY_COLOR[c] || "#2563eb";

      // 自然：实线
      series.push({
        name: c + " 自然",
        type: "line",
        data: makeData(idxOrg, c, dayType),
        showSymbol: false,
        lineStyle: { width: 2, type: "solid" },
        itemStyle: { color },
        emphasis: { focus: "series" },
      });

      // 买量：虚线
      series.push({
        name: c + " 买量",
        type: "line",
        data: makeData(idxPaid, c, dayType),
        showSymbol: false,
        lineStyle: { width: 2, type: "dashed" },
        itemStyle: { color },
        emphasis: { focus: "series" },
      });
    });

    return { dates, series };
  }

  function renderPayRateLine(chart, monthKey, countries, dayType) {
    const monthLabel = formatMonthShort(monthKey);
    const dayLabel = (v) => String(v || "").slice(8); // 01-31

    // D0+D7：上下双面板，避免一屏 4 条线/国家
    if (dayType === "both") {
      const d0 = buildLineSeries(monthKey, countries, "D0");
      const d7 = buildLineSeries(monthKey, countries, "D7");

      const legendNames = [];
      countries.forEach((c) => {
        legendNames.push(c + " 自然");
        legendNames.push(c + " 买量");
      });

      const series = [];
      d0.series.forEach((s) => series.push({ ...s, xAxisIndex: 0, yAxisIndex: 0 }));
      d7.series.forEach((s) => series.push({ ...s, xAxisIndex: 1, yAxisIndex: 1 }));

      chart.setOption(
        {
          title: [
            { text: monthLabel + " · D0 付费率", left: 0, top: 6, textStyle: { fontSize: 11, fontWeight: 500, color: "#334155" } },
            { text: monthLabel + " · D7 付费率", left: 0, top: "52%", textStyle: { fontSize: 11, fontWeight: 500, color: "#334155" } },
          ],
          legend: { top: 24, left: 0, type: "scroll", data: legendNames, itemHeight: 10, itemWidth: 14 },
          grid: [
            { left: 40, right: 20, top: 46, height: "35%", containLabel: true },
            { left: 40, right: 20, top: "58%", height: "35%", containLabel: true },
          ],
          axisPointer: { link: [{ xAxisIndex: [0, 1] }] },
          tooltip: {
            trigger: "axis",
            axisPointer: { type: "line" },
            formatter: function (params) {
              const byAxis = { 0: [], 1: [] };
              (params || []).forEach((p) => {
                const ax = p.xAxisIndex == null ? 0 : p.xAxisIndex;
                (byAxis[ax] || (byAxis[ax] = [])).push(p);
              });

              const date = (params && params[0] && params[0].axisValue) || "";
              let html = date + "<br/>";

              const appendBlock = (title, arr) => {
                if (!arr || !arr.length) return;
                html += '<span style="color:#64748b">' + title + "</span><br/>";
                arr.forEach((p) => {
                  html += p.marker + p.seriesName + ": " + formatPercent(p.data) + "<br/>";
                });
              };

              appendBlock("D0", byAxis[0]);
              appendBlock("D7", byAxis[1]);
              return html;
            },
          },
          xAxis: [
            { type: "category", data: d0.dates, boundaryGap: false, axisLabel: { show: false }, axisLine: { lineStyle: { color: "rgba(148,163,184,0.45)" } } },
            { type: "category", data: d7.dates, boundaryGap: false, axisLabel: { formatter: dayLabel }, axisLine: { lineStyle: { color: "rgba(148,163,184,0.45)" } } },
          ],
          yAxis: [
            { type: "value", axisLabel: { formatter: (v) => v + "%" }, splitLine: { lineStyle: { color: "rgba(148,163,184,0.25)" } } },
            { type: "value", axisLabel: { formatter: (v) => v + "%" }, splitLine: { lineStyle: { color: "rgba(148,163,184,0.25)" } } },
          ],
          series,
        },
        true
      );
      return;
    }

    // 单口径（D0 或 D7）
    const built = buildLineSeries(monthKey, countries, dayType);

    chart.setOption(
      {
        grid: { left: 40, right: 20, top: 50, bottom: 40, containLabel: true },
        legend: { top: 10, left: 0, type: "scroll", itemHeight: 10, itemWidth: 14 },
        tooltip: {
          trigger: "axis",
          axisPointer: { type: "line" },
          formatter: function (params) {
            const date = (params && params[0] && params[0].axisValue) || "";
            let html = date + "<br/>";
            (params || []).forEach((p) => {
              html += p.marker + p.seriesName + ": " + formatPercent(p.data) + "<br/>";
            });
            return html;
          },
        },
        xAxis: { type: "category", data: built.dates, boundaryGap: false, axisLabel: { formatter: dayLabel }, axisLine: { lineStyle: { color: "rgba(148,163,184,0.45)" } } },
        yAxis: { type: "value", name: monthLabel + " · " + dayType + " 付费率", axisLabel: { formatter: (v) => v + "%" }, splitLine: { lineStyle: { color: "rgba(148,163,184,0.25)" } } },
        series: built.series,
      },
      true
    );
  }

  // === 8) 表格：国家 × (D0/D7 付费率)，每格“自然/买量” ===
  function updatePayRateTable(monthKey, countries) {
    const table = document.getElementById("table-payrate");
    if (!table) return;

    if (!monthKey || !countries || !countries.length) {
      renderEmptyTable(table);
      return;
    }

    const label = formatMonthShort(monthKey);
    const thead = document.createElement("thead");
    const headRow = document.createElement("tr");
    headRow.innerHTML = "<th>国家</th><th>" + label + " D0付费率</th><th>" + label + " D7付费率</th>";
    thead.appendChild(headRow);

    const tbody = document.createElement("tbody");
    const idxOrg = OVP.idx.organic;
    const idxPaid = OVP.idx.paid;

    countries.forEach((c) => {
      const tr = document.createElement("tr");

      const tdC = document.createElement("td");
      tdC.textContent = c;
      tr.appendChild(tdC);

      const orgAgg = getAgg(idxOrg, "month", monthKey, c);
      const paidAgg = getAgg(idxPaid, "month", monthKey, c);

      const d0Org = payRateFromAgg(orgAgg, "D0");
      const d0Paid = payRateFromAgg(paidAgg, "D0");
      const d7Org = payRateFromAgg(orgAgg, "D7");
      const d7Paid = payRateFromAgg(paidAgg, "D7");

      const td0 = document.createElement("td");
      td0.className = "num";
      td0.textContent = "自然 " + formatPercent(d0Org) + " / 买量 " + formatPercent(d0Paid);
      tr.appendChild(td0);

      const td7 = document.createElement("td");
      td7.className = "num";
      td7.textContent = "自然 " + formatPercent(d7Org) + " / 买量 " + formatPercent(d7Paid);
      tr.appendChild(td7);

      tbody.appendChild(tr);
    });

    table.innerHTML = "";
    table.appendChild(thead);
    table.appendChild(tbody);
  }

  // === 9) 模块状态 & 初始化 ===
  window.chartState = window.chartState || {};
  window.chartState.payrate = window.chartState.payrate || { month: "", countries: [], view: "bar", dayType: "both" };

  function updatePayRateModule(chart, st) {
    const monthKey = st.month || (OVP.allMonths.length ? OVP.allMonths[OVP.allMonths.length - 1] : "");
    const countries = getOrderedCountries(st.countries);
    const view = st.view || "bar";
    const dayType = st.dayType || "both";

    if (!monthKey || !countries.length) {
      renderEmptyChart(chart, "请先选择月份和国家");
      renderEmptyTable(document.getElementById("table-payrate"));
      return;
    }

    if (view === "line") renderPayRateLine(chart, monthKey, countries, dayType);
    else renderPayRateBar(chart, monthKey, countries, dayType);

    updatePayRateTable(monthKey, countries);
  }

  function initPayRateModule() {
    const dom = document.getElementById("chart-payrate");
    if (!dom) return;

    const chart = echarts.init(dom);
    const st = window.chartState.payrate;

    createSingleSelectChips({
      containerId: "payrate-month",
      values: OVP.allMonths,
      getLabel: (m) => m,
      stateObj: st,
      stateKey: "month",
      preselect: OVP.allMonths.length ? OVP.allMonths[OVP.allMonths.length - 1] : "",
      onChange: () => updatePayRateModule(chart, st),
    });

    createMultiSelectChips({
      containerId: "payrate-countries",
      values: COUNTRY_ORDER,
      getLabel: (c) => c,
      stateArray: st.countries,
      preselect: "all",
      onChange: () => updatePayRateModule(chart, st),
    });

    bindRadioGroup("payrate-view", st, "view", () => updatePayRateModule(chart, st));
    bindRadioGroup("payrate-day-type", st, "dayType", () => updatePayRateModule(chart, st));

    updatePayRateModule(chart, st);
    window.addEventListener("resize", () => chart.resize());
  }

  document.addEventListener("DOMContentLoaded", initPayRateModule);
})();

    </script>
  </body>
</html>
