<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>Bangbet 自然量 & 买量月度对比</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="Bangbet 海外自然量与买量月度数据对比看板" />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --bg-main: #f3f5f9;
        --bg-card: #ffffff;
        --border-subtle: rgba(148, 163, 184, 0.4);

        --accent: #2563eb;
        --accent-soft: #e0edff;
        --accent-strong: #1d4ed8;

        --text-main: #0f172a;
        --text-sub: #6b7280;

        --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.1);

        --radius-lg: 18px;
        --radius-md: 12px;
        --radius-pill: 999px;

        --transition-fast: 0.18s ease-out;

        /* 业务色：自然=橙、买量=蓝 */
        --organic: #f97316;
        --organic-soft: #fff7ed;
        --paid: #2563eb;
        --paid-soft: #e0edff;
        --danger: #e11d48;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica,
          Arial, "Apple Color Emoji", "Segoe UI Emoji", sans-serif;
        background: radial-gradient(
            circle at 15% 0%,
            rgba(37, 99, 235, 0.08),
            transparent 40%
          ),
          radial-gradient(
            circle at 85% 0%,
            rgba(249, 115, 22, 0.07),
            transparent 45%
          ),
          var(--bg-main);
        color: var(--text-main);
      }

      a {
        color: var(--accent);
        text-decoration: none;
      }
      a:hover {
        text-decoration: underline;
      }

      .page {
        max-width: 1180px;
        margin: 0 auto;
        padding: 26px 18px 44px;
      }

      .topbar {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 16px;
        padding: 18px 18px;
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-lg);
        background: rgba(255, 255, 255, 0.86);
        backdrop-filter: blur(10px);
        box-shadow: var(--shadow-soft);
      }

      .top-left {
        display: flex;
        gap: 12px;
        align-items: center;
      }

      .brand-mark {
        width: 44px;
        height: 44px;
        border-radius: 14px;
        background: linear-gradient(145deg, var(--accent), #7c3aed);
        position: relative;
        box-shadow: 0 10px 28px rgba(37, 99, 235, 0.25);
        flex: 0 0 auto;
      }
      .brand-mark-inner {
        position: absolute;
        inset: 10px;
        border-radius: 10px;
        background: linear-gradient(145deg, rgba(255, 255, 255, 0.95), #dbeafe);
      }

      .brand-text-main {
        font-weight: 700;
        font-size: 15px;
        letter-spacing: 0.2px;
      }
      .brand-text-sub {
        margin-top: 2px;
        font-size: 12px;
        color: var(--text-sub);
      }
      .breadcrumb {
        margin-top: 6px;
        font-size: 12px;
        color: rgba(107, 114, 128, 0.9);
      }

      .top-right {
        text-align: right;
        font-size: 12px;
        color: var(--text-sub);
        line-height: 1.5;
      }

      .badge-env {
        display: inline-flex;
        gap: 8px;
        align-items: center;
        padding: 6px 10px;
        border-radius: var(--radius-pill);
        border: 1px solid var(--border-subtle);
        background: rgba(255, 255, 255, 0.7);
        margin-bottom: 6px;
      }
      .badge-dot {
        width: 8px;
        height: 8px;
        border-radius: 99px;
        background: var(--accent-green, #16a34a);
        box-shadow: 0 0 0 4px rgba(22, 163, 74, 0.12);
      }

      .hero {
        display: grid;
        grid-template-columns: 1.3fr 0.7fr;
        gap: 16px;
        margin-top: 16px;
      }

      .hero-main,
      .hero-side {
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-lg);
        background: rgba(255, 255, 255, 0.86);
        backdrop-filter: blur(10px);
        box-shadow: var(--shadow-soft);
        padding: 18px;
      }

      .hero-title {
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 800;
        font-size: 18px;
        letter-spacing: 0.2px;
      }
      .hero-title .bar {
        width: 8px;
        height: 18px;
        border-radius: 6px;
        background: linear-gradient(180deg, var(--accent), var(--organic));
        box-shadow: 0 10px 22px rgba(37, 99, 235, 0.2);
      }

      .hero-sub {
        margin-top: 10px;
        color: var(--text-sub);
        font-size: 13px;
        line-height: 1.55;
      }

      .hero-tags {
        margin-top: 12px;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }
      .hero-tag {
        font-size: 12px;
        padding: 6px 10px;
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-pill);
        background: rgba(255, 255, 255, 0.7);
        color: rgba(15, 23, 42, 0.82);
      }

      .hero-pill {
        margin-top: 12px;
        padding: 10px 12px;
        border-radius: var(--radius-md);
        border: 1px dashed rgba(148, 163, 184, 0.55);
        background: rgba(224, 237, 255, 0.35);
        color: rgba(15, 23, 42, 0.75);
        font-size: 12px;
        line-height: 1.45;
      }

      .content {
        margin-top: 16px;
        display: grid;
        gap: 14px;
      }

      .chart-card {
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-lg);
        background: rgba(255, 255, 255, 0.92);
        backdrop-filter: blur(10px);
        box-shadow: var(--shadow-soft);
        overflow: hidden;
      }

      .chart-card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 16px;
        padding: 16px 16px 12px;
        border-bottom: 1px solid rgba(148, 163, 184, 0.25);
      }

      .chart-title-block {
        min-width: 280px;
      }
      .chart-kicker {
        font-size: 12px;
        color: rgba(107, 114, 128, 0.95);
        letter-spacing: 0.6px;
        text-transform: uppercase;
        margin-bottom: 6px;
      }
      .chart-title {
        font-size: 16px;
        font-weight: 800;
        letter-spacing: 0.2px;
      }
      .chart-sub {
        margin-top: 6px;
        font-size: 12px;
        color: var(--text-sub);
        line-height: 1.5;
      }

      .chart-controls {
        display: flex;
        flex-wrap: wrap;
        justify-content: flex-end;
        gap: 10px 12px;
        align-items: center;
        text-align: right;
      }

      .chart-badge {
        font-size: 12px;
        padding: 6px 10px;
        border-radius: var(--radius-pill);
        border: 1px solid var(--border-subtle);
        background: rgba(255, 255, 255, 0.75);
        color: rgba(15, 23, 42, 0.85);
        white-space: nowrap;
      }

      .chart-mini-filter {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 10px;
        border-radius: var(--radius-pill);
        border: 1px solid var(--border-subtle);
        background: rgba(255, 255, 255, 0.75);
      }
      .chart-mini-label {
        font-size: 12px;
        color: var(--text-sub);
        white-space: nowrap;
      }

      .chart-mini-chips {
        display: inline-flex;
        flex-wrap: wrap;
        gap: 6px;
        justify-content: flex-end;
      }

      .filter-chip {
        position: relative;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        border-radius: var(--radius-pill);
        border: 1px solid rgba(148, 163, 184, 0.55);
        padding: 5px 10px;
        font-size: 12px;
        cursor: pointer;
        user-select: none;
        transition: transform var(--transition-fast),
          background var(--transition-fast), border-color var(--transition-fast);
        background: rgba(255, 255, 255, 0.85);
        color: rgba(15, 23, 42, 0.86);
      }
      .filter-chip:hover {
        transform: translateY(-1px);
      }
      .filter-chip input {
        display: none;
      }
      .filter-chip-active {
        border-color: rgba(37, 99, 235, 0.65);
        background: rgba(224, 237, 255, 0.9);
        color: rgba(29, 78, 216, 0.95);
      }

      .chart-mini-radio {
        display: inline-flex;
        gap: 10px;
        align-items: center;
        font-size: 12px;
        color: rgba(15, 23, 42, 0.85);
      }
      .chart-mini-radio label {
        display: inline-flex;
        gap: 6px;
        align-items: center;
        cursor: pointer;
        user-select: none;
      }

      .btn {
        padding: 8px 12px;
        border-radius: var(--radius-md);
        border: 1px solid rgba(148, 163, 184, 0.55);
        background: rgba(255, 255, 255, 0.86);
        cursor: pointer;
        font-size: 12px;
        transition: transform var(--transition-fast),
          border-color var(--transition-fast), background var(--transition-fast);
      }
      .btn:hover {
        transform: translateY(-1px);
        border-color: rgba(37, 99, 235, 0.55);
        background: rgba(224, 237, 255, 0.6);
      }

      .chart {
        height: 340px;
        padding: 0;
      }

      .chart-summary {
        padding: 10px 16px 12px;
        font-size: 12px;
        color: rgba(107, 114, 128, 0.98);
        border-top: 1px solid rgba(148, 163, 184, 0.18);
      }

      .chart-table-section {
        padding: 12px 16px 16px;
        border-top: 1px solid rgba(148, 163, 184, 0.18);
      }
      .chart-table-title {
        font-size: 12px;
        color: rgba(15, 23, 42, 0.86);
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .chart-table-title::before {
        content: "";
        width: 8px;
        height: 8px;
        border-radius: 99px;
        background: rgba(37, 99, 235, 0.8);
        box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
      }
      .chart-table-wrapper {
        overflow: auto;
        border: 1px solid rgba(148, 163, 184, 0.35);
        border-radius: var(--radius-md);
        background: rgba(255, 255, 255, 0.9);
      }
      table.chart-table {
        width: 100%;
        border-collapse: collapse;
        min-width: 720px;
      }
      .chart-table th,
      .chart-table td {
        border-bottom: 1px solid rgba(148, 163, 184, 0.2);
        padding: 10px 10px;
        font-size: 12px;
        text-align: left;
        white-space: nowrap;
      }
      .chart-table th {
        position: sticky;
        top: 0;
        background: rgba(243, 245, 249, 0.95);
        color: rgba(15, 23, 42, 0.85);
        font-weight: 700;
        z-index: 1;
      }
      .chart-table td.num {
        text-align: right;
        font-variant-numeric: tabular-nums;
      }
      .highlight {
        color: var(--danger);
        font-weight: 800;
      }

      .analysis-block {
        padding: 14px 16px 18px;
        border-top: 1px solid rgba(148, 163, 184, 0.18);
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.92),
          rgba(224, 237, 255, 0.14)
        );
        color: rgba(15, 23, 42, 0.88);
        font-size: 12px;
        line-height: 1.6;
      }
      .analysis-block .analysis-title {
        font-weight: 800;
        margin-bottom: 6px;
      }
      .analysis-block .analysis-meta {
        color: rgba(107, 114, 128, 0.95);
        margin-bottom: 8px;
      }

      .global-filter-grid {
        padding: 12px 16px 16px;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }
      .global-filter-label {
        font-size: 12px;
        color: rgba(107, 114, 128, 0.98);
        margin-bottom: 8px;
      }

      .disabled {
        opacity: 0.55;
        pointer-events: none;
        filter: grayscale(0.15);
      }

      .footer {
        margin-top: 16px;
        padding: 14px 18px;
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-lg);
        background: rgba(255, 255, 255, 0.86);
        backdrop-filter: blur(10px);
        box-shadow: var(--shadow-soft);
        display: flex;
        justify-content: space-between;
        gap: 10px;
        flex-wrap: wrap;
        color: rgba(107, 114, 128, 0.98);
        font-size: 12px;
      }

      @media (max-width: 920px) {
        .hero {
          grid-template-columns: 1fr;
        }
        .chart-card-header {
          flex-direction: column;
          align-items: stretch;
        }
        .chart-controls {
          justify-content: flex-start;
          text-align: left;
        }
        .global-filter-grid {
          grid-template-columns: 1fr;
        }
        table.chart-table {
          min-width: 560px;
        }
      }
    </style>
  </head>

  <body>
    <noscript
      >这页看板需要浏览器启用 JavaScript。请用 Chrome / Edge 打开，并确认未禁用脚本。</noscript
    >

    <div class="page">
      <header class="topbar">
        <div class="top-left">
          <div class="brand-mark"><div class="brand-mark-inner"></div></div>
          <div>
            <div class="brand-text-main">Bangbet Growth Console</div>
            <div class="brand-text-sub">Organic vs Paid · Monthly Comparison</div>
            <div class="breadcrumb">
              <a href="./index.html">首页目录</a> / 自然量&买量月度数据对比
            </div>
          </div>
        </div>

        <div class="top-right">
          <div class="badge-env">
            <span class="badge-dot"></span>
            <span>Prod · Light · 自然&买量</span>
          </div>
          <div>单位：人数 / % / USD 等值 · 周期：按月 + 按日</div>
        </div>
      </header>

      <section class="hero">
        <div class="hero-main">
          <div class="hero-title">
            <span class="bar"></span>
            <span>自然量 & 买量月度数据对比 · 看板</span>
          </div>
          <div class="hero-sub">
            按国家和月份对比自然/买量的注册规模、付费率、ARPPU、人均流水、玩法结构和留存表现。
            总筛选器在第一张卡片，后续每张图会有子筛选器：默认跟随总筛选器，但互不影响。
          </div>
          <div class="hero-tags">
            <span class="hero-tag">指标：注册 · 付费率 · ARPPU · 人均流水 · 玩法结构 · 留存</span>
            <span class="hero-tag">颜色：自然=橙色｜买量=蓝色</span>
            <span class="hero-tag">数据源：organic-data.js / paid-data.js</span>
          </div>
        </div>

        <div class="hero-side">
          <div>当前版本：v0.4 · Step4 付费率模块接真实数据（注册量 + 付费率双模块联动）。</div>
          <div class="hero-pill" id="data-status-pill">数据状态：等待加载…</div>
        </div>
      </section>

      <main class="content">
        <!-- ===========================
             GLOBAL FILTER (Step1)
             =========================== -->
        <section class="chart-card" id="card-global-filter">
          <header class="chart-card-header">
            <div class="chart-title-block">
              <div class="chart-kicker">Global</div>
              <div class="chart-title">总筛选器（默认条件下发到所有模块）</div>
              <div class="chart-sub">
                月份：单选；国家：单选/多选。后续 Step 会实现：改总筛选器 → 同步子筛选器；改单个模块子筛选器
                → 不影响总筛选器和其他模块。
              </div>
            </div>

            <div class="chart-controls">
              <span class="chart-badge" id="global-selection-preview"
                >当前筛选：-</span
              >
              <button class="btn" type="button" id="btn-global-reset">
                重置（全国家 + 最新月份）
              </button>
            </div>
          </header>

          <div class="global-filter-grid">
            <div class="global-filter-item">
              <div class="global-filter-label">月份（单选）</div>
              <div class="chart-mini-chips" id="global-months"></div>
            </div>

            <div class="global-filter-item">
              <div class="global-filter-label">国家（可多选）</div>
              <div class="chart-mini-chips" id="global-countries"></div>
            </div>
          </div>
        </section>

        <!-- ===========================
             MODULE 1 (placeholder)
             =========================== -->
        <section class="chart-card" id="card-reg">
          <header class="chart-card-header">
            <div class="chart-title-block">
              <div class="chart-kicker">Scale</div>
              <div class="chart-title">自然量 vs 买量注册量 · 月度 / 日度</div>
              <div class="chart-sub">
                月度：自然(橙) 与 买量(蓝) 注册数对比；日度：折线图（选中国家展示自然/买量两条线）。
              </div>
            </div>

            <div class="chart-controls">
              <span class="chart-badge">单位：人数 / %</span>
              <div class="chart-mini-filter">
  <div class="chart-mini-label">月份</div>
  <div class="filter-chips" id="reg-month"></div>
</div>
<div class="chart-mini-filter">
  <div class="chart-mini-label">国家（可多选）</div>
  <div class="filter-chips" id="reg-countries"></div>
</div>
<div class="chart-inline-note">子筛选器默认跟随总筛选器，单独修改不会影响总筛选器</div>

                <span class="chart-mini-label">视图：</span>
                <div class="chart-mini-radio">
                  <label>
                    <input type="radio" name="reg-view" value="month" checked />
                    月度
                  </label>
                  <label>
                    <input type="radio" name="reg-view" value="day" /> 日度
                  </label>
                </div>
              </div>
            </div>
          </header>

          <div class="chart" id="chart-reg"></div>
          <div class="chart-summary" id="summary-reg"></div>

          <div class="chart-table-section">
            <div class="chart-table-title">当前筛选 · 自然量 vs 买量注册量</div>
            <div class="chart-table-wrapper">
              <table id="table-reg" class="chart-table"></table>
            </div>
          </div>

          <div class="analysis-block" id="analysis-reg">
            <div class="analysis-title">数据分析（Step10 后接入「按月文案文件」）</div>
            <div class="analysis-meta">当前：占位内容</div>
            <div>这里会按“筛选月份”显示对应的分析文案。</div>
          </div>
        </section>

        <!-- ===========================
             MODULE 2 (placeholder)
             =========================== -->
        <section class="chart-card" id="card-payrate">
          <header class="chart-card-header">
            <div class="chart-title-block">
              <div class="chart-kicker">Conversion</div>
              <div class="chart-title">D0 / D7 付费率 · 自然量 vs 买量</div>
              <div class="chart-sub">
                D0 与 D7 用两根柱子展示（不堆叠）；D7 通过阴影/样式区分。
              </div>
            </div>

            <div class="chart-controls">
              <span class="chart-badge">单位：%</span>
              <div class="chart-mini-filter">
                <span class="chart-mini-label">月份：</span>
                <div class="chart-mini-chips" id="payrate-month"></div>
              </div>
              <div class="chart-mini-filter">
                <span class="chart-mini-label">国家：</span>
                <div class="chart-mini-chips" id="payrate-countries"></div>
              </div>
            </div>
          </header>

          <div class="chart" id="chart-payrate"></div>
          <div class="chart-summary" id="summary-payrate"></div>

          <div class="chart-table-section">
            <div class="chart-table-title">当前筛选 · D0 / D7 付费率</div>
            <div class="chart-table-wrapper">
              <table id="table-payrate" class="chart-table"></table>
            </div>
          </div>

          <div class="analysis-block" id="analysis-payrate">
            <div class="analysis-title">数据分析（占位）</div>
            <div class="analysis-meta">当前：占位内容</div>
            <div>这里会按“筛选月份”显示对应的分析文案。</div>
          </div>
        </section>

        <!-- ===========================
             MODULE 3 (placeholder)
             =========================== -->
        <section class="chart-card" id="card-arppu">
          <header class="chart-card-header">
            <div class="chart-title-block">
              <div class="chart-kicker">Monetization</div>
              <div class="chart-title">D0 / D7 ARPPU · 自然量 vs 买量</div>
              <div class="chart-sub">
                ARPPU = purchase value / 付费人数。对比自然(橙)与买量(蓝)。
              </div>
            </div>

            <div class="chart-controls">
              <span class="chart-badge">单位：USD 等值</span>
              <div class="chart-mini-filter disabled" title="Step3 后启用">
                <span class="chart-mini-label">月份：</span>
                <div class="chart-mini-chips" id="arppu-month"></div>
              </div>
              <div class="chart-mini-filter disabled" title="Step3 后启用">
                <span class="chart-mini-label">国家：</span>
                <div class="chart-mini-chips" id="arppu-countries"></div>
              </div>
            </div>
          </header>

          <div class="chart" id="chart-arppu"></div>
          <div class="chart-summary" id="summary-arppu"></div>

          <div class="chart-table-section">
            <div class="chart-table-title">当前筛选 · D0 / D7 ARPPU</div>
            <div class="chart-table-wrapper">
              <table id="table-arppu" class="chart-table"></table>
            </div>
          </div>

          <div class="analysis-block" id="analysis-arppu">
            <div class="analysis-title">数据分析（占位）</div>
            <div class="analysis-meta">当前：占位内容</div>
            <div>这里会按“筛选月份”显示对应的分析文案。</div>
          </div>
        </section>

        <!-- ===========================
             MODULE 4 (placeholder)
             =========================== -->
        <section class="chart-card" id="card-flow">
          <header class="chart-card-header">
            <div class="chart-title-block">
              <div class="chart-kicker">Betting Depth</div>
              <div class="chart-title">D0 / D7 人均流水（体育 / 游戏 / 总）· 自然量 vs 买量</div>
              <div class="chart-sub">
                人均流水按子筛选器选择：体育/游戏/总。D0 与 D7 并列展示。
              </div>
            </div>

            <div class="chart-controls">
              <span class="chart-badge">单位：USD 等值 / 下注用户</span>
              <div class="chart-mini-filter disabled" title="Step3 后启用">
                <span class="chart-mini-label">玩法：</span>
                <div class="chart-mini-radio">
                  <label>
                    <input type="radio" name="flow-dim" value="sports" checked />
                    体育
                  </label>
                  <label>
                    <input type="radio" name="flow-dim" value="games" /> 游戏
                  </label>
                  <label>
                    <input type="radio" name="flow-dim" value="total" /> 总
                  </label>
                </div>
              </div>
              <div class="chart-mini-filter disabled" title="Step3 后启用">
                <span class="chart-mini-label">月份：</span>
                <div class="chart-mini-chips" id="flow-month"></div>
              </div>
              <div class="chart-mini-filter disabled" title="Step3 后启用">
                <span class="chart-mini-label">国家：</span>
                <div class="chart-mini-chips" id="flow-countries"></div>
              </div>
            </div>
          </header>

          <div class="chart" id="chart-flow"></div>
          <div class="chart-summary" id="summary-flow"></div>

          <div class="chart-table-section">
            <div class="chart-table-title">当前筛选 · 人均流水（随玩法切换）</div>
            <div class="chart-table-wrapper">
              <table id="table-flow" class="chart-table"></table>
            </div>
          </div>

          <div class="analysis-block" id="analysis-flow">
            <div class="analysis-title">数据分析（占位）</div>
            <div class="analysis-meta">当前：占位内容</div>
            <div>这里会按“筛选月份”显示对应的分析文案。</div>
          </div>
        </section>

        <!-- ===========================
             MODULE 5 (placeholder)
             =========================== -->
        <section class="chart-card" id="card-ratio">
          <header class="chart-card-header">
            <div class="chart-title-block">
              <div class="chart-kicker">Structure</div>
              <div class="chart-title">体育 vs 游戏玩家比例 · 自然量 vs 买量</div>
              <div class="chart-sub">
                ratio = 体育下注用户 / 游戏下注用户。表格中 ratio &gt; 1 的值加粗标红。
              </div>
            </div>

            <div class="chart-controls">
              <span class="chart-badge">单位：倍数（ratio）</span>
              <div class="chart-mini-filter disabled" title="Step3 后启用">
                <span class="chart-mini-label">月份：</span>
                <div class="chart-mini-chips" id="ratio-month"></div>
              </div>
              <div class="chart-mini-filter disabled" title="Step3 后启用">
                <span class="chart-mini-label">国家：</span>
                <div class="chart-mini-chips" id="ratio-countries"></div>
              </div>
            </div>
          </header>

          <div class="chart" id="chart-ratio"></div>
          <div class="chart-summary" id="summary-ratio"></div>

          <div class="chart-table-section">
            <div class="chart-table-title">当前筛选 · 体/游比例（D0 / D7）</div>
            <div class="chart-table-wrapper">
              <table id="table-ratio" class="chart-table"></table>
            </div>
          </div>

          <div class="analysis-block" id="analysis-ratio">
            <div class="analysis-title">数据分析（占位）</div>
            <div class="analysis-meta">当前：占位内容</div>
            <div>这里会按“筛选月份”显示对应的分析文案。</div>
          </div>
        </section>

        <!-- ===========================
             MODULE 6 (placeholder)
             =========================== -->
        <section class="chart-card" id="card-retention">
          <header class="chart-card-header">
            <div class="chart-title-block">
              <div class="chart-kicker">Retention</div>
              <div class="chart-title">次日 / 7 日留存率 · 自然量 vs 买量</div>
              <div class="chart-sub">留存率 = retained_users / registration。对比自然(橙)与买量(蓝)。</div>
            </div>

            <div class="chart-controls">
              <span class="chart-badge">单位：%</span>
              <div class="chart-mini-filter disabled" title="Step3 后启用">
                <span class="chart-mini-label">月份：</span>
                <div class="chart-mini-chips" id="ret-month"></div>
              </div>
              <div class="chart-mini-filter disabled" title="Step3 后启用">
                <span class="chart-mini-label">国家：</span>
                <div class="chart-mini-chips" id="ret-countries"></div>
              </div>
            </div>
          </header>

          <div class="chart" id="chart-retention"></div>
          <div class="chart-summary" id="summary-retention"></div>

          <div class="chart-table-section">
            <div class="chart-table-title">当前筛选 · D1 / D7 留存率</div>
            <div class="chart-table-wrapper">
              <table id="table-retention" class="chart-table"></table>
            </div>
          </div>

          <div class="analysis-block" id="analysis-retention">
            <div class="analysis-title">数据分析（占位）</div>
            <div class="analysis-meta">当前：占位内容</div>
            <div>这里会按“筛选月份”显示对应的分析文案。</div>
          </div>
        </section>
      </main>

      <footer class="footer">
        <span
          >Owner：<strong>用户增长部-Jerry Lyu</strong> · 自然量&买量对比看板 v0.1（从
          RAW_ORGANIC_BY_MONTH + RAW_PAID_BY_MONTH 聚合）</span
        >
        <span>数据来源：内部自然量报表 + 内部买量报表 · 时间口径建议统一为 UTC+0 日切。</span>
      </footer>
    </div>

    <!-- ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>

    <!-- 数据源：必须与 index.html 同级 -->
    <script src="./organic-data.js"></script>
    <script src="./paid-data.js"></script>

    <script>
  // ===========================
  // Step2：落地「模块1 注册量」(月度/日度 + 表格联动)
  // - 总筛选器：月份单选、国家多选（空选视为全选）
  // - 其他模块仍保持占位，Step3+ 逐步接入
  // ===========================

  const RAW_ORGANIC_BY_MONTH = window.RAW_ORGANIC_BY_MONTH;
  const RAW_PAID_BY_MONTH = window.RAW_PAID_BY_MONTH;

  const charts = [];
  const chartsById = {};

  function safeArray(v) {
    return Array.isArray(v) ? v : [];
  }

  function monthSort(a, b) {
    // "YYYY-MM" 字符串直接比较即可
    return a < b ? -1 : a > b ? 1 : 0;
  }

  function uniqSorted(arr) {
    return Array.from(new Set(arr)).sort();
  }

  function asNumber(v) {
    const n = Number(v);
    return Number.isFinite(n) ? n : 0;
  }

  function fmtInt(n) {
    const x = Math.round(asNumber(n));
    return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  }

  function fmtPct01(ratio01, digits = 1) {
    const r = asNumber(ratio01);
    const pct = r * 100;
    return pct.toFixed(digits) + "%";
  }

  function cssVar(name, fallback) {
    const v = getComputedStyle(document.documentElement)
      .getPropertyValue(name)
      .trim();
    return v || fallback;
  }

  function countRows(byMonth) {
    if (!byMonth) return 0;
    return Object.keys(byMonth).reduce(
      (acc, m) => acc + safeArray(byMonth[m]).length,
      0
    );
  }

  function buildAllMonths() {
    const m1 = RAW_ORGANIC_BY_MONTH ? Object.keys(RAW_ORGANIC_BY_MONTH) : [];
    const m2 = RAW_PAID_BY_MONTH ? Object.keys(RAW_PAID_BY_MONTH) : [];
    return uniqSorted(m1.concat(m2)).sort(monthSort);
  }

  function buildAllCountries(allMonths) {
    const set = new Set();
    safeArray(allMonths).forEach((m) => {
      safeArray(RAW_ORGANIC_BY_MONTH && RAW_ORGANIC_BY_MONTH[m]).forEach(
        (r) => r && r.country && set.add(r.country)
      );
      safeArray(RAW_PAID_BY_MONTH && RAW_PAID_BY_MONTH[m]).forEach((r) => {
        r && r.country && set.add(r.country);
      });
    });
    return Array.from(set).sort();
  }

  function createMultiSelectChips(options) {
    const { containerId, values, getLabel, stateArray, preselect, onChange } =
      options || {};
    const container = document.getElementById(containerId);
    if (!container) return;

    container.innerHTML = "";
    if (!Array.isArray(values) || values.length === 0) {
      container.textContent = "-";
      return;
    }

    if (Array.isArray(stateArray) && stateArray.length === 0) {
      if (preselect === "all") values.forEach((v) => stateArray.push(v));
      if (typeof preselect === "number") {
        for (let i = 0; i < Math.min(preselect, values.length); i++) {
          stateArray.push(values[i]);
        }
      }
    }

    values.forEach((value) => {
      const labelEl = document.createElement("label");
      labelEl.className = "filter-chip";

      const input = document.createElement("input");
      input.type = "checkbox";
      input.value = value;

      const selected =
        Array.isArray(stateArray) && stateArray.indexOf(value) !== -1;
      if (selected) {
        input.checked = true;
        labelEl.classList.add("filter-chip-active");
      }

      labelEl.appendChild(input);
      labelEl.appendChild(document.createTextNode(getLabel(value)));

      input.addEventListener("change", (e) => {
        const checked = e.target.checked;

        if (Array.isArray(stateArray)) {
          const existsIndex = stateArray.indexOf(value);
          if (checked && existsIndex === -1) stateArray.push(value);
          if (!checked && existsIndex !== -1) stateArray.splice(existsIndex, 1);
        }

        labelEl.classList.toggle("filter-chip-active", input.checked);
        if (typeof onChange === "function") onChange();
      });

      container.appendChild(labelEl);
    });
  }

  function createSingleSelectChips(options) {
    const { containerId, values, getLabel, stateObj, key, preselect, onChange } =
      options || {};
    const container = document.getElementById(containerId);
    if (!container) return;

    container.innerHTML = "";
    if (!Array.isArray(values) || values.length === 0) {
      container.textContent = "-";
      return;
    }

    if (!stateObj[key]) {
      stateObj[key] = preselect === "latest" ? values[values.length - 1] : values[0];
    }

    const groupName = `${containerId}__single`;

    values.forEach((value) => {
      const labelEl = document.createElement("label");
      labelEl.className = "filter-chip";

      const input = document.createElement("input");
      input.type = "radio";
      input.name = groupName;
      input.value = value;

      const selected = stateObj[key] === value;
      if (selected) {
        input.checked = true;
        labelEl.classList.add("filter-chip-active");
      }

      labelEl.appendChild(input);
      labelEl.appendChild(document.createTextNode(getLabel(value)));

      input.addEventListener("change", () => {
        stateObj[key] = value;

        container.querySelectorAll(".filter-chip").forEach((el) => {
          el.classList.remove("filter-chip-active");
        });
        labelEl.classList.add("filter-chip-active");

        if (typeof onChange === "function") onChange();
      });

      container.appendChild(labelEl);
    });
  }

  function setDataStatus(text, ok) {
    const pill = document.getElementById("data-status-pill");
    if (!pill) return;
    pill.textContent = text;
    pill.style.background = ok
      ? "rgba(224, 237, 255, 0.35)"
      : "rgba(225, 29, 72, 0.08)";
    pill.style.borderColor = ok
      ? "rgba(148, 163, 184, 0.55)"
      : "rgba(225, 29, 72, 0.28)";
  }

  function placeholderOption(title) {
    return {
      animation: false,
      grid: { left: 16, right: 16, top: 22, bottom: 12 },
      xAxis: { show: false },
      yAxis: { show: false },
      series: [],
      graphic: [
        {
          type: "group",
          left: "center",
          top: "middle",
          children: [
            {
              type: "rect",
              shape: { width: 260, height: 78, r: 14 },
              style: {
                fill: "rgba(2, 6, 23, 0.06)",
                stroke: "rgba(148, 163, 184, 0.35)",
                lineWidth: 1,
              },
            },
            {
              type: "text",
              style: {
                text: title,
                fill: "rgba(71, 85, 105, 0.92)",
                font: "600 13px Inter, system-ui, -apple-system, Segoe UI, sans-serif",
              },
              left: 18,
              top: 18,
            },
            {
              type: "text",
              style: {
                text: "Step2：模块1 已接入（注册量）\n其他模块：占位中",
                fill: "rgba(71, 85, 105, 0.72)",
                font: "12px Inter, system-ui, -apple-system, Segoe UI, sans-serif",
              },
              left: 18,
              top: 40,
            },
          ],
        },
      ],
    };
  }

  function fillTableSkeleton(tableId, headers) {
    const el = document.getElementById(tableId);
    if (!el) return;
    const ths = (headers || []).map((h) => `<th>${h}</th>`).join("");
    const tds = (headers || [])
      .map((_, idx) => (idx === 0 ? `<td>-</td>` : `<td class="num">-</td>`))
      .join("");
    el.innerHTML = `
      <thead><tr>${ths}</tr></thead>
      <tbody><tr>${tds}</tr></tbody>
    `;
  }

  // ===========================
  // Module 1：注册量（月度/日度）
  // ===========================

  function getRegViewMode() {
    const el = document.querySelector('input[name="reg-view"]:checked');
    return el ? el.value : "month";
  }

  function sumByCountry(rows, field) {
    const out = Object.create(null);
    safeArray(rows).forEach((r) => {
      if (!r || !r.country) return;
      const c = r.country;
      out[c] = (out[c] || 0) + asNumber(r[field]);
    });
    return out;
  }

  function sumByDate(rows, field) {
    const out = Object.create(null);
    safeArray(rows).forEach((r) => {
      if (!r || !r.date) return;
      const d = r.date; // "YYYY-MM-DD"
      out[d] = (out[d] || 0) + asNumber(r[field]);
    });
    return out;
  }

  function renderRegTable({ month, countries, allCountries }) {
    const table = document.getElementById("table-reg");
    if (!table) return;

    const useCountries = countries && countries.length ? countries : allCountries;

    const orgRows = safeArray(RAW_ORGANIC_BY_MONTH && RAW_ORGANIC_BY_MONTH[month]).filter(
      (r) => r && r.country && useCountries.indexOf(r.country) !== -1
    );
    const paidRows = safeArray(RAW_PAID_BY_MONTH && RAW_PAID_BY_MONTH[month]).filter(
      (r) => r && r.country && useCountries.indexOf(r.country) !== -1
    );

    const orgBy = sumByCountry(orgRows, "registration");
    const paidBy = sumByCountry(paidRows, "registration");

    const headers = [
      "国家",
      "自然量注册占比 (%)",
      "买量注册占比 (%)",
      "自然量注册数",
      "买量注册数",
      "总注册数",
    ];

    const rowsHtml = useCountries
      .slice()
      .sort()
      .map((c) => {
        const o = asNumber(orgBy[c] || 0);
        const p = asNumber(paidBy[c] || 0);
        const t = o + p;

        const oShare = t > 0 ? o / t : 0;
        const pShare = t > 0 ? p / t : 0;

        return `
          <tr>
            <td>${c}</td>
            <td class="num">${fmtPct01(oShare)}</td>
            <td class="num">${fmtPct01(pShare)}</td>
            <td class="num">${fmtInt(o)}</td>
            <td class="num">${fmtInt(p)}</td>
            <td class="num">${fmtInt(t)}</td>
          </tr>
        `;
      })
      .join("");

    const ths = headers.map((h) => `<th>${h}</th>`).join("");
    table.innerHTML = `
      <thead><tr>${ths}</tr></thead>
      <tbody>${rowsHtml}</tbody>
    `;
  }

  function renderRegChart({ month, countries, allCountries }) {
    const chart = chartsById["chart-reg"];
    if (!chart || !month) return;

    const organicColor = cssVar("--organic", "#f97316");
    const paidColor = cssVar("--paid", "#2563eb");

    const view = getRegViewMode();
    const useCountries = countries && countries.length ? countries : allCountries;

    const orgAll = safeArray(RAW_ORGANIC_BY_MONTH && RAW_ORGANIC_BY_MONTH[month]);
    const paidAll = safeArray(RAW_PAID_BY_MONTH && RAW_PAID_BY_MONTH[month]);

    if (view === "day") {
      const orgRows = orgAll.filter((r) => r && r.country && useCountries.indexOf(r.country) !== -1);
      const paidRows = paidAll.filter((r) => r && r.country && useCountries.indexOf(r.country) !== -1);

      const orgMap = sumByDate(orgRows, "registration");
      const paidMap = sumByDate(paidRows, "registration");
      const dates = uniqSorted(Object.keys(orgMap).concat(Object.keys(paidMap))).sort();

      const orgSeries = dates.map((d) => asNumber(orgMap[d] || 0));
      const paidSeries = dates.map((d) => asNumber(paidMap[d] || 0));

      chart.setOption(
        {
          color: [organicColor, paidColor],
          tooltip: { trigger: "axis", axisPointer: { type: "line" } },
          legend: {
            data: ["自然量", "买量"],
            top: 2,
            right: 10,
            textStyle: { color: "rgba(71,85,105,0.86)", fontSize: 11 },
          },
          grid: { left: 46, right: 18, top: 36, bottom: 40 },
          xAxis: {
            type: "category",
            data: dates,
            axisLabel: {
              color: "rgba(71,85,105,0.74)",
              fontSize: 11,
              formatter: (v) => (typeof v === "string" ? v.slice(5) : v),
            },
            axisTick: { alignWithLabel: true },
          },
          yAxis: {
            type: "value",
            axisLabel: { color: "rgba(71,85,105,0.74)", fontSize: 11 },
            splitLine: { lineStyle: { color: "rgba(148,163,184,0.25)" } },
          },
          series: [
            { name: "自然量", type: "line", data: orgSeries, smooth: true, showSymbol: false, lineStyle: { width: 2 } },
            { name: "买量", type: "line", data: paidSeries, smooth: true, showSymbol: false, lineStyle: { width: 2 } },
          ],
        },
        { notMerge: true }
      );
    } else {
      const orgRows = orgAll.filter((r) => r && r.country && useCountries.indexOf(r.country) !== -1);
      const paidRows = paidAll.filter((r) => r && r.country && useCountries.indexOf(r.country) !== -1);

      const orgBy = sumByCountry(orgRows, "registration");
      const paidBy = sumByCountry(paidRows, "registration");

      const xCats = useCountries.slice().sort();
      const orgData = xCats.map((c) => asNumber(orgBy[c] || 0));
      const paidData = xCats.map((c) => asNumber(paidBy[c] || 0));

      chart.setOption(
        {
          color: [organicColor, paidColor],
          tooltip: { trigger: "axis", axisPointer: { type: "shadow" } },
          legend: {
            data: ["自然量", "买量"],
            top: 2,
            right: 10,
            textStyle: { color: "rgba(71,85,105,0.86)", fontSize: 11 },
          },
          grid: { left: 46, right: 18, top: 36, bottom: 54 },
          xAxis: {
            type: "category",
            data: xCats,
            axisLabel: { color: "rgba(71,85,105,0.74)", fontSize: 11 },
            axisTick: { alignWithLabel: true },
          },
          yAxis: {
            type: "value",
            axisLabel: { color: "rgba(71,85,105,0.74)", fontSize: 11 },
            splitLine: { lineStyle: { color: "rgba(148,163,184,0.25)" } },
          },
          series: [
            { name: "自然量", type: "bar", data: orgData, barMaxWidth: 22, itemStyle: { color: organicColor } },
            { name: "买量", type: "bar", data: paidData, barMaxWidth: 22, itemStyle: { color: paidColor } },
          ],
        },
        { notMerge: true }
      );
    }
  }

  function renderRegSummary({ month, countries, allCountries }) {
    const el = document.getElementById("summary-reg");
    if (!el) return;

    const useCountries = countries && countries.length ? countries : allCountries;

    const orgRows = safeArray(RAW_ORGANIC_BY_MONTH && RAW_ORGANIC_BY_MONTH[month]).filter(
      (r) => r && r.country && useCountries.indexOf(r.country) !== -1
    );
    const paidRows = safeArray(RAW_PAID_BY_MONTH && RAW_PAID_BY_MONTH[month]).filter(
      (r) => r && r.country && useCountries.indexOf(r.country) !== -1
    );

    const totalOrg = orgRows.reduce((acc, r) => acc + asNumber(r.registration), 0);
    const totalPaid = paidRows.reduce((acc, r) => acc + asNumber(r.registration), 0);
    const total = totalOrg + totalPaid;

    const view = getRegViewMode();
    const viewText = view === "day" ? "日度折线（所选国家合计）" : "月度柱状（按国家）";

    const orgShare = total > 0 ? totalOrg / total : 0;
    const paidShare = total > 0 ? totalPaid / total : 0;

    const countryLabel =
      countries && countries.length ? `${useCountries.length} 个国家` : `全量国家（${useCountries.length}）`;

    el.textContent =
      `视图：${viewText}｜月份：${month}｜国家：${countryLabel}｜` +
      `自然：${fmtInt(totalOrg)}（${fmtPct01(orgShare)}）｜买量：${fmtInt(totalPaid)}（${fmtPct01(paidShare)}）｜总计：${fmtInt(total)}`;
  }
      
// ===========================
// MODULE 2: D0/D7 付费率（自然 vs 买量）
// 口径：付费率 = unique_purchase / registration
// ===========================

function renderPayrateAll() {
  renderPayrateChart({
    month: moduleState.payrate.month,
    countries: moduleState.payrate.countries,
    allCountries: ALL_COUNTRIES,
  });
  renderPayrateTable({
    month: moduleState.payrate.month,
    countries: moduleState.payrate.countries,
    allCountries: ALL_COUNTRIES,
  });
  renderPayrateSummary({
    month: moduleState.payrate.month,
    countries: moduleState.payrate.countries,
    allCountries: ALL_COUNTRIES,
  });
}

function renderPayrateChart({ month, countries, allCountries }) {
  const chart = chartsById["chart-payrate"];
  if (!chart || !month) return;

  const organicColor = cssVar("--organic", "#f97316");
  const paidColor = cssVar("--paid", "#2563eb");

  const useCountries = countries && countries.length ? countries : allCountries;

  const orgRows = safeArray(RAW_ORGANIC_BY_MONTH && RAW_ORGANIC_BY_MONTH[month]).filter(
    (r) => r && r.country && useCountries.includes(r.country)
  );
  const paidRows = safeArray(RAW_PAID_BY_MONTH && RAW_PAID_BY_MONTH[month]).filter(
    (r) => r && r.country && useCountries.includes(r.country)
  );

  const orgRegBy = sumByCountry(orgRows, "registration");
  const paidRegBy = sumByCountry(paidRows, "registration");

  const orgD0PayBy = sumByCountry(orgRows, "D0_unique_purchase");
  const orgD7PayBy = sumByCountry(orgRows, "D7_unique_purchase");
  const paidD0PayBy = sumByCountry(paidRows, "D0_unique_purchase");
  const paidD7PayBy = sumByCountry(paidRows, "D7_unique_purchase");

  const xCats = useCountries.slice().sort();

  const rate = (pay, reg) => {
    const r = asNumber(reg || 0);
    const p = asNumber(pay || 0);
    return r > 0 ? p / r : 0;
  };

  const orgD0 = xCats.map((c) => rate(orgD0PayBy[c], orgRegBy[c]));
  const orgD7 = xCats.map((c) => rate(orgD7PayBy[c], orgRegBy[c]));
  const paidD0 = xCats.map((c) => rate(paidD0PayBy[c], paidRegBy[c]));
  const paidD7 = xCats.map((c) => rate(paidD7PayBy[c], paidRegBy[c]));

  const d7Shadow = {
    shadowBlur: 10,
    shadowOffsetY: 3,
    shadowColor: "rgba(0,0,0,0.22)",
  };

  chart.setOption(
    {
      tooltip: {
        trigger: "axis",
        axisPointer: { type: "shadow" },
        formatter: (params) => {
          if (!params || !params.length) return "";
          const title = params[0].axisValueLabel || params[0].name || "";
          const lines = params
            .map((p) => `${p.marker}${p.seriesName}：${fmtPct01(p.value, 1)}`)
            .join("<br/>");
          return `${title}<br/>${lines}`;
        },
      },
      legend: { top: 0, right: 0 },
      grid: { left: 36, right: 16, top: 36, bottom: 28, containLabel: true },
      xAxis: { type: "category", data: xCats, axisTick: { alignWithLabel: true } },
      yAxis: {
        type: "value",
        min: 0,
        axisLabel: { formatter: (v) => fmtPct01(v, 0) },
        splitLine: { lineStyle: { color: "rgba(148,163,184,0.25)" } },
      },
      series: [
        { name: "自然量 D0", type: "bar", data: orgD0, itemStyle: { color: organicColor }, barMaxWidth: 18 },
        { name: "自然量 D7", type: "bar", data: orgD7, itemStyle: { color: organicColor, ...d7Shadow }, barMaxWidth: 18 },
        { name: "买量 D0", type: "bar", data: paidD0, itemStyle: { color: paidColor }, barMaxWidth: 18 },
        { name: "买量 D7", type: "bar", data: paidD7, itemStyle: { color: paidColor, ...d7Shadow }, barMaxWidth: 18 },
      ],
    },
    { notMerge: true }
  );
}

function renderPayrateTable({ month, countries, allCountries }) {
  const table = document.getElementById("table-payrate");
  if (!table || !month) return;

  const useCountries = countries && countries.length ? countries : allCountries;

  const orgRows = safeArray(RAW_ORGANIC_BY_MONTH && RAW_ORGANIC_BY_MONTH[month]).filter(
    (r) => r && r.country && useCountries.includes(r.country)
  );
  const paidRows = safeArray(RAW_PAID_BY_MONTH && RAW_PAID_BY_MONTH[month]).filter(
    (r) => r && r.country && useCountries.includes(r.country)
  );

  const orgRegBy = sumByCountry(orgRows, "registration");
  const paidRegBy = sumByCountry(paidRows, "registration");

  const orgD0PayBy = sumByCountry(orgRows, "D0_unique_purchase");
  const orgD7PayBy = sumByCountry(orgRows, "D7_unique_purchase");
  const paidD0PayBy = sumByCountry(paidRows, "D0_unique_purchase");
  const paidD7PayBy = sumByCountry(paidRows, "D7_unique_purchase");

  const headers = ["国家", "自然量 D0 付费率", "自然量 D7 付费率", "买量 D0 付费率", "买量 D7 付费率"];

  const rate = (pay, reg) => {
    const r = asNumber(reg || 0);
    const p = asNumber(pay || 0);
    return r > 0 ? p / r : 0;
  };

  const rowsHtml = useCountries
    .slice()
    .sort()
    .map((c) => {
      const oReg = asNumber(orgRegBy[c] || 0);
      const pReg = asNumber(paidRegBy[c] || 0);
      const o0 = rate(orgD0PayBy[c], oReg);
      const o7 = rate(orgD7PayBy[c], oReg);
      const p0 = rate(paidD0PayBy[c], pReg);
      const p7 = rate(paidD7PayBy[c], pReg);

      return `
        <tr>
          <td>${c}</td>
          <td class="num">${fmtPct01(o0, 1)}</td>
          <td class="num">${fmtPct01(o7, 1)}</td>
          <td class="num">${fmtPct01(p0, 1)}</td>
          <td class="num">${fmtPct01(p7, 1)}</td>
        </tr>
      `;
    })
    .join("");

  const ths = headers.map((h) => `<th>${h}</th>`).join("");
  table.innerHTML = `<thead><tr>${ths}</tr></thead><tbody>${rowsHtml}</tbody>`;
}

function renderPayrateSummary({ month, countries, allCountries }) {
  const el = document.getElementById("summary-payrate");
  if (!el || !month) return;

  const useCountries = countries && countries.length ? countries : allCountries;

  const orgRows = safeArray(RAW_ORGANIC_BY_MONTH && RAW_ORGANIC_BY_MONTH[month]).filter(
    (r) => r && r.country && useCountries.includes(r.country)
  );
  const paidRows = safeArray(RAW_PAID_BY_MONTH && RAW_PAID_BY_MONTH[month]).filter(
    (r) => r && r.country && useCountries.includes(r.country)
  );

  const sum = (rows, field) => rows.reduce((acc, r) => acc + asNumber(r && r[field]), 0);

  const orgReg = sum(orgRows, "registration");
  const paidReg = sum(paidRows, "registration");

  const orgD0Pay = sum(orgRows, "D0_unique_purchase");
  const orgD7Pay = sum(orgRows, "D7_unique_purchase");
  const paidD0Pay = sum(paidRows, "D0_unique_purchase");
  const paidD7Pay = sum(paidRows, "D7_unique_purchase");

  const rate = (pay, reg) => (reg > 0 ? pay / reg : 0);
  const orgD0 = rate(orgD0Pay, orgReg);
  const orgD7 = rate(orgD7Pay, orgReg);
  const paidD0 = rate(paidD0Pay, paidReg);
  const paidD7 = rate(paidD7Pay, paidReg);

  const fmtPP = (diff) => `${(diff * 100).toFixed(1)}pp`;

  el.textContent =
    `月份 ${month} · ${useCountries.length} 国｜` +
    `自然 D0 ${fmtPct01(orgD0, 1)} / D7 ${fmtPct01(orgD7, 1)}（${fmtPP(orgD7 - orgD0)}）｜` +
    `买量 D0 ${fmtPct01(paidD0, 1)} / D7 ${fmtPct01(paidD7, 1)}（${fmtPP(paidD7 - paidD0)}）｜` +
    `买量-自然：D0 ${fmtPP(paidD0 - orgD0)} / D7 ${fmtPP(paidD7 - orgD7)}｜` +
    `注册：自然 ${fmtInt(orgReg)} · 买量 ${fmtInt(paidReg)}`;
}

  // ===========================
  // 初始化
  // ===========================
  (function init() {
    const okOrganic = !!RAW_ORGANIC_BY_MONTH;
    const okPaid = !!RAW_PAID_BY_MONTH;

    if (!okOrganic || !okPaid) {
      setDataStatus(
        "数据状态：未加载。请确认同级目录存在 organic-data.js / paid-data.js，并且分别定义 RAW_ORGANIC_BY_MONTH / RAW_PAID_BY_MONTH。",
        false
      );
      return;
    }

    const ALL_MONTHS = buildAllMonths();
    const ALL_COUNTRIES = buildAllCountries(ALL_MONTHS);

    const organicRows = countRows(RAW_ORGANIC_BY_MONTH);
    const paidRows = countRows(RAW_PAID_BY_MONTH);

    setDataStatus(
      `数据状态：OK · 月份 ${ALL_MONTHS.length} 个 · 国家 ${ALL_COUNTRIES.length} 个 · 自然 ${organicRows} 行 · 买量 ${paidRows} 行`,
      true
    );

    const globalState = { month: null, countries: [] };

    function renderGlobalPreview() {
      const el = document.getElementById("global-selection-preview");
      if (!el) return;
      const m = globalState.month || "-";
      const cs =
        globalState.countries && globalState.countries.length
          ? globalState.countries.join(", ")
          : "全量国家";
      el.textContent = `当前筛选：${m}｜${cs}`;
    }

        function onGlobalChange() {
  // 总筛选器改动：同步到所有模块子筛选器，但只让“已接入真实计算”的模块刷新出图/表
  syncAllModulesFromGlobal();
  renderAllModuleFilters();

  // Step4：注册量 + 付费率 两个模块真联动
  renderRegAll();
  renderPayrateAll();

  // 其余模块先维持“预览摘要”（后续 Step 再接真实计算）
  ["arppu", "flow", "ratio", "retention"].forEach((k) => {
    const el = document.getElementById(`summary-${k}`);
    if (!el) return;
    el.textContent = `当前筛选（预览）：月份 ${globalState.month} · 国家 ${globalState.countries.length} 个`;
  });
}


    createSingleSelectChips({
      containerId: "global-months",
      values: ALL_MONTHS,
      getLabel: (m) => m,
      stateObj: globalState,
      key: "month",
      preselect: "latest",
      onChange: onGlobalChange,
    });

    createMultiSelectChips({
      containerId: "global-countries",
      values: ALL_COUNTRIES,
      getLabel: (c) => c,
      stateArray: globalState.countries,
      preselect: "all",
      onChange: onGlobalChange,
    });

    const resetBtn = document.getElementById("btn-global-reset");
    if (resetBtn) {
      resetBtn.addEventListener("click", () => {
        globalState.month = ALL_MONTHS.length ? ALL_MONTHS[ALL_MONTHS.length - 1] : null;
        globalState.countries.length = 0;
        ALL_COUNTRIES.forEach((c) => globalState.countries.push(c));

        createSingleSelectChips({
          containerId: "global-months",
          values: ALL_MONTHS,
          getLabel: (m) => m,
          stateObj: globalState,
          key: "month",
          preselect: "latest",
          onChange: onGlobalChange,
        });
        createMultiSelectChips({
          containerId: "global-countries",
          values: ALL_COUNTRIES,
          getLabel: (c) => c,
          stateArray: globalState.countries,
          preselect: "all",
          onChange: onGlobalChange,
        });

        onGlobalChange();
      });
    }

    document.querySelectorAll('input[name="reg-view"]').forEach((el) => {
      el.addEventListener("change", renderRegAll);

    });

        // ===========================
    // Step3：模块级筛选器状态（与总筛选器解耦）
    // - 总筛选器变更：同步覆盖到各模块
    // - 模块自己改：不反向影响总筛选器/其他模块
    // ===========================
    const moduleState = {
      reg: { month: null, countries: [] },
      payrate: { month: null, countries: [] },
      arppu: { month: null, countries: [] },
      flow: { month: null, countries: [] },
      ratio: { month: null, countries: [] },
      retention: { month: null, countries: [] },
    };

    const MODULE_FILTER_CONFIG = [
      {
        key: "reg",
        monthId: "reg-month",
        countriesId: "reg-countries",
        onChange: () => renderRegAll(),
      },
      { key: "payrate", monthId: "payrate-month", countriesId: "payrate-countries", onChange: () => renderPayrateAll() },
      { key: "arppu", monthId: "arppu-month", countriesId: "arppu-countries", onChange: () => {} },
      { key: "flow", monthId: "flow-month", countriesId: "flow-countries", onChange: () => {} },
      { key: "ratio", monthId: "ratio-month", countriesId: "ratio-countries", onChange: () => {} },
      { key: "retention", monthId: "ret-month", countriesId: "ret-countries", onChange: () => {} },
    ];

    function copyArray(target, source) {
      target.length = 0;
      if (Array.isArray(source)) source.forEach((v) => target.push(v));
    }

    function syncAllModulesFromGlobal() {
      MODULE_FILTER_CONFIG.forEach((cfg) => {
        const st = moduleState[cfg.key];
        st.month = globalState.month;
        copyArray(st.countries, globalState.countries);
      });
    }

    function renderAllModuleFilters() {
      MODULE_FILTER_CONFIG.forEach((cfg) => {
        const st = moduleState[cfg.key];

        createSingleSelectChips({
          containerId: cfg.monthId,
          values: ALL_MONTHS,
          getLabel: (m) => m,
          stateObj: st,
          key: "month",
          preselect: "latest",
          onChange: cfg.onChange,
        });

        createMultiSelectChips({
          containerId: cfg.countriesId,
          values: ALL_COUNTRIES,
          getLabel: (c) => c,
          stateArray: st.countries,
          preselect: "all",
          onChange: cfg.onChange,
        });
      });
    }

    function renderRegAll() {
      const st = moduleState.reg;
      renderRegChart({ month: st.month, countries: st.countries, allCountries: ALL_COUNTRIES });
      renderRegTable({ month: st.month, countries: st.countries, allCountries: ALL_COUNTRIES });
      renderRegSummary({ month: st.month, countries: st.countries, allCountries: ALL_COUNTRIES });
    }


    fillTableSkeleton("table-reg", [
      "国家",
      "自然量注册占比 (%)",
      "买量注册占比 (%)",
      "自然量注册数",
      "买量注册数",
      "总注册数",
    ]);

    fillTableSkeleton("table-payrate", [
      "国家",
      "自然量 D0 付费率",
      "自然量 D7 付费率",
      "买量 D0 付费率",
      "买量 D7 付费率",
    ]);

    fillTableSkeleton("table-arppu", [
      "国家",
      "自然量 D0 ARPPU",
      "自然量 D7 ARPPU",
      "买量 D0 ARPPU",
      "买量 D7 ARPPU",
    ]);

    fillTableSkeleton("table-flow", [
      "国家",
      "自然量 D0 人均流水",
      "自然量 D7 人均流水",
      "买量 D0 人均流水",
      "买量 D7 人均流水",
    ]);

    fillTableSkeleton("table-ratio", [
      "国家",
      "自然量体/游D0",
      "自然量体/游D7",
      "买量体/游D0",
      "买量体/游D7",
    ]);

    fillTableSkeleton("table-retention", [
      "国家",
      "自然量 D1 留存率",
      "自然量 D7 留存率",
      "买量 D1 留存率",
      "买量 D7 留存率",
    ]);

    if (window.echarts) {
      const chartIds = [
        ["chart-reg", "注册量模块"],
        ["chart-payrate", "付费率模块"],
        ["chart-arppu", "ARPPU 模块"],
        ["chart-flow", "人均流水模块"],
        ["chart-ratio", "体/游比例模块"],
        ["chart-retention", "留存模块"],
      ];

      chartIds.forEach(([id, title]) => {
        const dom = document.getElementById(id);
        if (!dom) return;
        const c = echarts.init(dom);
        c.setOption(placeholderOption(title));
        charts.push(c);
        chartsById[id] = c;
      });

      window.addEventListener("resize", () => {
        charts.forEach((c) => c && c.resize && c.resize());
      });
    }

    renderGlobalPreview();
    onGlobalChange();
  })();
</script>

  </body>
</html>
